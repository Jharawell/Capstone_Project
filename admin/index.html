<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Administrative Division Dashboard</title>
     <link rel="shortcut icon" href="../assets/images/logo.png" type="image/x-icon" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />
    <!-- Add DataTables CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css"
    />
    <link rel="stylesheet" href="../assets/css/style.css" />
    <!-- Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
      
      .dt-buttons .btn {
        margin-right: 8px;
      }
      .dt-buttons .btn:last-child {
        margin-right: 0;
      }
      
      th:nth-child(3), td:nth-child(3) {
        white-space: nowrap;
      }

      th:nth-child(4), td:nth-child(4) {
        min-width: 100px;
      }
      th:nth-child(8), td:nth-child(8) {
        min-width: 80px;
      }
      th:nth-child(9), td:nth-child(9) {
        min-width: 100px;
      }
      th:nth-child(10), td:nth-child(10) {
        min-width: 100px;
      }
      th:nth-child(11), td:nth-child(11) {
        min-width: 100px;
      }
      th:nth-child(12), td:nth-child(12) {
        min-width: 100px;
      }
      th:nth-child(13), td:nth-child(13) {
        min-width: 100px;
      }
      /* Make Status column (14th) wider */
      th:nth-child(14), td:nth-child(14) {
        min-width: 100px;
      }
      th:nth-child(15), td:nth-child(15) {
        min-width: 135px;
      }
      

      @media print {
        body * {
          visibility: hidden !important;
        }
        #documentsSection, #documentsSection * {
          visibility: visible !important;
        }
        #documentsSection {
          position: absolute !important;
          left: 0; top: 0; width: 100vw; background: white;
          z-index: 9999;
          padding: 2rem;
        }
        .sidebar, .menu-toggle, .main-content > div:not(#documentsSection) {
          display: none !important;
        }
        .btn, .bi-printer {
          display: none !important;
        }
        .monthly-letters-card {
          page-break-before: always !important;
          break-before: page !important;
        }
      }
    </style>
  </head>
  <body>
    <button class="menu-toggle" id="menuToggle" title="Toggle sidebar menu">
      <i class="bi bi-list"></i>
    </button>

    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 px-0 sidebar" id="sidebar">
          <div class="d-flex flex-column p-4">
            <div class="d-flex justify-content-center">
              <a
                href="/"
                class="d-flex flex-column align-items-center text-white text-decoration-none"
                aria-label="Go to CentralComm homepage"
              >
                <img
                  src="../assets/images/logo-dashboard-page.png"
                  alt="CentralComm Logo"
                  class="mb-1"
                  style="width: 100px; height: 100px"
                />
                <span class="fs-3 fw-bold mt-2">CentralComm</span>
                <span id="currentUserEmailadmin">cmobaguio2600@gmail.com</span>
                
              </a>
            </div>

            <hr class="border-light opacity-50" />
            <ul class="nav nav-pills flex-column mb-auto">
              <li class="nav-item">
                <a href="#" class="nav-link active" id="dashboardLink">
                  <i class="bi bi-house-door stat-icon"></i>
                  Dashboard
                </a>
              </li>
               <li>
                <a href="#" class="nav-link" id="notificationsLink">
                  <i class="bi bi-bell"></i>
                  All Notifications
                  <span id="allNotifBadge" class="badge rounded-pill bg-danger ms-2" style="display:none;">0</span>
                </a>
              </li>
              <li>
                <a href="#" class="nav-link" id="documentsLink">
                  <i class="bi bi-file-earmark-text stat-icon"></i>
                  Reports
                </a>
              </li>
              <li hidden>
                <a href="#" class="nav-link" id="usersLink">
                  <i class="bi bi-people stat-icon"></i>
                  Users
                </a>
              </li>
              <li>
                <a href="#" class="nav-link" id="archivesLink">
                  <i class="bi bi-archive stat-icon"></i>
                  Archives
                </a>
              </li>
              <li>
                <a href="#" class="nav-link" id="historyLink">
                  <i class="bi bi-clock-history stat-icon"></i>
                  History
                </a>
              </li>
              <li>
                <a href="#" class="nav-link" id="profileLink">
                  <i class="bi bi-person-circle stat-icon"></i>
                  Profile
                </a>
              </li>
              <li>
                <a href="#" class="nav-link" onclick="signOut()">
                  <i class="bi bi-box-arrow-right me-2"></i>
                  Sign out
                </a>
              </li>
            </ul>
            <hr class="border-light opacity-50" />
          </div>
        </div>

        <!-- Main content -->
        <div class="col-md-9 col-lg-10 main-content">
          <!-- Dashboard Section -->
          <div id="dashboardSection">
            <div class="header-section card-header bg-white">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h1 class="h2 mb-1">Administrative  Division - Mayor's Office Dashboard</h1>
                  <p class="mb-0">Welcome back, Admin</p>
                </div>
                <div class="d-flex justify-content-end gap-2 mb-2 mb-md-0">
                  <!-- Create New Button -->
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-light"
                    data-bs-toggle="modal"
                    data-bs-target="#createEntryModal" hidden
                    title="Create a new entry"
                  >
                    <i class="bi bi-plus-circle me-2"></i>Create New
                  </button>

                  <!-- Archive All Button -->
                   <button
                    type="button"
                    class="btn btn-sm btn-warning"
                    id="archiveAllBtncplt"
                    title="Archive all current entries"
                  >
                    <i class="bi bi-archive me-2"></i>Archive All Finished
                  </button>
                  <button
                    type="button"
                    class="btn btn-sm btn-light"
                    id="archiveAllBtn"
                    title="Archive all current entries"
                  >
                    <i class="bi bi-archive me-2"></i>Archive All
                  </button>
                </div>
              </div>
            </div>

            <!-- Monthly Statistics -->
            <div class="card mb-4">
              <div class="card-header bg-white">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="d-flex align-items-center">
                    <h5 class="card-title mb-0 me-3">Monthly Statistics</h5>
                    <button class="btn btn-primary btn-sm" id="toggleFinishedBtn" title="Toggle between Show All, Show Unfinished Only, and Show All Finished">
                      <i class="bi bi-eye-slash me-1"></i>
                      <span id="toggleFinishedText">Show Unfinished Only</span>
                    </button>
                  </div>
                  <div class="d-flex align-items-center">
                    <label for="yearSelector" class="form-label me-2 mb-0">Select Year:</label>
                    <select class="form-select w-auto" id="yearSelector" style="width: 120px;">
                      <!-- Year options will be populated dynamically -->
                    </select>
                  </div>
                </div>
              </div>
              <div class="card-body p-0">
                <div class="accordion" id="monthlyStatsAccordion">
                  <!-- Monthly statistics will be populated here -->
                </div>
              </div>
            </div>
          </div>

          <!-- Archives Section -->
          <div id="archivesSection" class="d-none">
            <div class="header-section card-header bg-white">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h1 class="h2 mb-1">Archived Entries</h1>
                  <p class="mb-0 text-white-50">
                    View archived entries by year
                  </p>
                </div>
              </div>
            </div>

            <div class="card mb-4">
              <div class="card-body">
                <div class="row" id="archivedYearsContainer">
                  <!-- Archived years will be populated here -->
                </div>
              </div>
            </div>
          </div>

          <!-- Documents Section -->
          <div id="documentsSection" class="d-none">
            <div class="header-section card-header bg-white">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h1 class="h2 mb-1">Documents Reports</h1>
                  <p class="mb-0 text-white-50">
                    View document statistics and analytics
                  </p>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <label for="reportsYearSelector" class="form-label mb-0">Select Year:</label>
                  <select class="form-select w-auto" id="reportsYearSelector" style="width: 120px;">
                    <!-- Year options will be populated dynamically -->
                  </select>
                  <div class="btn-group" role="group">
                    <button id="copyReportsBtn" class="btn btn-secondary btn-sm" title="Copy to Clipboard">
                      <i class="bi bi-clipboard"></i> Copy
                    </button>
                    <button id="csvReportsBtn" class="btn btn-success btn-sm" title="Export as CSV">
                      <i class="bi bi-file-earmark-text"></i> CSV
                    </button>
                    <button id="excelReportsBtn" class="btn btn-success btn-sm" title="Export as Excel">
                      <i class="bi bi-file-earmark-excel"></i> Excel
                    </button>
                    <button id="pdfReportsBtn" class="btn btn-danger btn-sm" title="Export as PDF">
                      <i class="bi bi-file-earmark-pdf"></i> PDF
                    </button>
                  </div>
                  <button id="printReportsBtn" class="btn btn-outline-light" title="Download/Print Reports">
                    <i class="bi bi-printer"></i> Download/Print
                  </button>
                </div>
              </div>
            </div>

            <div class="row">
              <!-- Yearly Statistics -->
              <div class="col-md-6 mb-4">
                <div class="card h-100">
                  <div class="card-body">
                    <h6 class="card-title text-primary mb-3">
                      Yearly Statistics
                    </h6>
                    <div class="table-responsive">
                      <table class="table table-sm">
                        <tbody>
                          <tr>
                            <td>Total Letters Received</td>
                            <td class="text-end" id="yearlyTotal">0</td>
                          </tr>
                          <tr>
                            <td>Complaints</td>
                            <td class="text-end" id="yearlyComplaints">0</td>
                          </tr>
                          <tr>
                            <td>Requests</td>
                            <td class="text-end" id="yearlyRequests">0</td>
                          </tr>
                          <tr>
                            <td>Proposals</td>
                            <td class="text-end" id="yearlyProposals">0</td>
                          </tr>
                          <tr>
                            <td>Invitations</td>
                            <td class="text-end" id="yearlyInvitations">0</td>
                          </tr>
                          <tr>
                            <td>Finished Letters</td>
                            <td class="text-end" id="yearlyFinished">0</td>
                          </tr>
                          <tr>
                            <td>Unfinished Letters</td>
                            <td class="text-end" id="yearlyUnfinished">0</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Monthly Statistics -->
              <div class="col-md-6 mb-4">
                <div class="card h-100">
                  <div class="card-body">
                    <h6 class="card-title text-primary mb-3">
                      Monthly Statistics
                    </h6>
                    <div class="table-responsive">
                      <table class="table table-sm">
                        <tbody>
                          <tr>
                            <td>Current Month Letters</td>
                            <td class="text-end" id="monthlyTotal">0</td>
                          </tr>
                          <tr>
                            <td>Average Daily Letters</td>
                            <td class="text-end" id="avgDailyLetters">0</td>
                          </tr>
                          <tr>
                            <td>Highest Volume Month</td>
                            <td class="text-end" id="highestVolumeMonth">-</td>
                          </tr>
                          <tr>
                            <td>Lowest Volume Month</td>
                            <td class="text-end" id="lowestVolumeMonth">-</td>
                          </tr>
                          <tr>
                            <td>Finished Letters</td>
                            <td class="text-end" id="monthlyFinished">0</td>
                          </tr>
                          <tr>
                            <td>Unfinished Letters</td>
                            <td class="text-end" id="monthlyUnfinished">0</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Monthly Letters Graph -->
              <div class="col-md-6 mb-4 monthly-letters-card">
                <div class="card">
                  <div class="card-body">
                    <h6 class="card-title text-primary mb-3">
                      Monthly Letters Received
                    </h6>
                    <canvas id="monthlyLettersChart" height="150"></canvas>
                  </div>
                </div>
              </div>

              <!-- Add this after the Monthly Letters Graph card -->
              <div class="col-md-6 mb-4">
                <div class="card">
                  <div class="card-body">
                    <h6 class="card-title text-primary mb-3">Letter Type Distribution</h6>
                    <div style="height: 300px;">
                    <canvas id="letterTypeChart"></canvas>
                  </div>
                </div>
              </div>


            </div>
          </div>
        </div>

          <!-- History Section -->
          <div id="historySection" class="d-none">
            <div class="header-section card-header bg-white">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h1 class="h2 mb-1">History</h1>
                  <p class="mb-0 text-white-50">View system activity history</p>
                </div>
              </div>
            </div>
            <div class="card mb-4">
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover" id="historyTable">
                    <thead>
                      <tr>
                        <th>Timestamp</th>
                        <th>User</th>
                        <th>Action</th>
                        <th>Details</th>
                        <th>Control Number</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- History will be populated here -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Profile Section -->
          <div id="profileSection" class="d-none">
            <div class="header-section card-header bg-white">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h1 class="h2 mb-1">Profile Management</h1>
                  <p class="mb-0 text-white-50">Manage your account settings</p>
                </div>
              </div>
            </div>

            <div class="row">
              <!-- Profile Settings -->
              <div class="col-lg-8 mb-4">
                <div class="card">
                  <div class="card-body">
                    <h5 class="card-title mb-4">Account Settings</h5>
                    <form id="profileForm">
                      <div class="mb-3">
                        <label for="email" class="form-label">Email Address</label>
                        <div class="input-group">
                          <span class="input-group-text">
                            <i class="bi bi-envelope"></i>
                          </span>
                          <input
                            type="email"
                            class="form-control with-icon"
                            id="email"
                            value="cmobaguio2600@gmail.com"
                            readonly
                          />
                        </div>
                      </div>
                      <div class="mb-3">
                        <label for="role" class="form-label">Department</label>
                        <div class="input-group">
                          <span class="input-group-text">
                            <i class="bi bi-person-badge"></i>
                          </span>
                          <input
                            type="text"
                            class="form-control with-icon"
                            id="role"
                            value="Administrative Division - Mayor's Office"
                            readonly
                          />
                        </div>
                      </div>
                    </form>
                  </div>
                </div>

                <!-- Change Password -->
                <div class="card mt-4">
                  <div class="card-body">
                    <h5 class="card-title mb-4">Change Password</h5>
                    <form id="passwordForm">
                      <div class="mb-3">
                        <label for="currentPassword" class="form-label">Current Password</label>
                        <div class="input-group">
                          <input
                            type="password"
                            class="form-control"
                            id="currentPassword"
                            required
                          />
                          <button class="btn btn-outline-secondary" type="button" id="toggleCurrentPassword" title="Show/hide password">
                            <i class="bi bi-eye" id="currentPasswordIcon"></i>
                          </button>
                        </div>
                      </div>
                      <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password</label>
                        <div class="input-group">
                          <input
                            type="password"
                            class="form-control"
                            id="newPassword"
                            required
                          />
                          <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword" title="Show/hide password">
                            <i class="bi bi-eye" id="newPasswordIcon"></i>
                          </button>
                        </div>
                      </div>
                      <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Confirm New Password</label>
                        <div class="input-group">
                          <input
                            type="password"
                            class="form-control"
                            id="confirmPassword"
                            required
                          />
                          <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword" title="Show/hide password">
                            <i class="bi bi-eye" id="confirmPasswordIcon"></i>
                          </button>
                        </div>
                      </div>
                      <button type="submit" class="btn btn-success" title="Update password">
                        Update Password
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>

            <!-- Add this new section below the existing profile cards -->
            <div class="row">
              <div class="col-lg-8 mb-4">
                <!-- Account Creation Card -->
                <div class="card mt-4">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                      <h5 class="card-title mb-0">Create New Account</h5>
                      <button class="btn btn-primary btn-sm" id="toggleAccountForm1" title="Add a new user account">
                        <i class="bi bi-plus-circle me-1"></i>Add New Account
                      </button>
                    </div>
                    
                    <form id="createAccountForm" class="d-none">
                      <div class="row mb-3">
                        <div class="col-md-6">
                          <label for="newAccountRole" class="form-label">Role</label>
                          <div class="input-group">
                            <span class="input-group-text">
                              <i class="bi bi-person-badge"></i>
                            </span>
                            <select class="form-control" id="newAccountRole" required>
                              <option value="">Select Role</option>
                              <option value="Receiving">Receiving</option>
                              <option value="Admin">Admin</option>
                              <option value="Endorsement">Endorsement</option>
                            </select>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <label for="finalRole" class="form-label">Final Role</label>
                          <div class="input-group">
                            <span class="input-group-text">
                              <i class="bi bi-check-circle"></i>
                            </span>
                            <input type="text" class="form-control" id="finalRole" readonly placeholder="Will be set automatically">
                          </div>
                        </div>
                      </div>

                      <!-- Endorsement Office Selection -->
                      <div class="row mb-3" id="endorsementOfficeRow" style="display: none;">
                        <div class="col-md-6">
                          <label for="endorsementOffice" class="form-label">Endorsement Office</label>
                          <div class="input-group">
                            <span class="input-group-text">
                              <i class="bi bi-building"></i>
                            </span>
                            <select class="form-control" id="endorsementOffice">
                              <option value="">Select Endorsement Office</option>
                              <option value="Vice Mayor's Office">Vice Mayor's Office</option>
                              <option value="Sangguniang Panlungsod">Sangguniang Panlungsod</option>
                              <option value="CAO">CAO</option>
                              <option value="CASSO">CASSO</option>
                              <option value="CADMO">CADMO</option>
                              <option value="CBO">CBO</option>
                              <option value="CEPMO">CEPMO</option>
                              <option value="CHRMO">CHRMO</option>
                              <option value="CLO">CLO</option>
                              <option value="CPDSO">CPDSO</option>
                              <option value="CTO">CTO</option>
                              <option value="GSO">GSO</option>
                              <option value="CBAO">CBAO</option>
                              <option value="CEO">CEO</option>
                              <option value="CSWDO">CSWDO</option>
                              <option value="HSO">HSO</option>
                              <option value="LCR">LCR</option>
                              <option value="CVAO">CVAO</option>
                              <option value="DepEd">DepEd</option>
                              <option value="COA">COA</option>
                              <option value="MTCC">MTCC</option>
                              <option value="RTCC">RTCC</option>
                              <option value="Prosecutor's Office">Prosecutor's Office</option>
                              <option value="PLEB">PLEB</option>
                              <option value="POSD">POSD</option>
                              <option value="PESO">PESO</option>
                              <option value="PIO">PIO</option>
                              <option value="PLD">PLD</option>
                              <option value="SSD">SSD</option>
                              <option value="PDAO">PDAO</option>
                              <option value="MITD">MITD</option>
                              <option value="CCTV/EWSS">CCTV/EWSS</option>
                              <option value="CDRRMO">CDRRMO</option>
                              <option value="LIBRARY">LIBRARY</option>
                              <option value="PERSONAL STAFF">PERSONAL STAFF</option>
                            </select>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <label for="newAccountEmail" class="form-label">Email Address</label>
                          <div class="input-group">
                            <span class="input-group-text">
                              <i class="bi bi-envelope"></i>
                            </span>
                            <input type="email" class="form-control" id="newAccountEmail" placeholder="" required>
                          </div>
                        </div>
                      </div>

                      <div class="row mb-3">
                        <div class="col-md-6">
                          <label for="newAccountPassword" class="form-label">Password</label>
                          <div class="input-group">
                            <span class="input-group-text">
                              <i class="bi bi-key"></i>
                            </span>
                            <input type="password" class="form-control" id="newAccountPassword" required>
                            <button class="btn btn-outline-secondary" type="button" id="toggleNewAccountPassword" title="Show/hide password">
                              <i class="bi bi-eye" id="newAccountPasswordIcon"></i>
                            </button>
                          </div>
                          <div class="form-text">Password must be at least 6 characters long</div>
                        </div>
                        <div class="col-md-6">
                          <label for="confirmNewAccountPassword" class="form-label">Confirm Password</label>
                          <div class="input-group">
                            <span class="input-group-text">
                              <i class="bi bi-key-fill"></i>
                            </span>
                            <input type="password" class="form-control" id="confirmNewAccountPassword" required>
                            <button class="btn btn-outline-secondary" type="button" id="toggleConfirmNewAccountPassword" title="Show/hide password">
                              <i class="bi bi-eye" id="confirmNewAccountPasswordIcon"></i>
                            </button>
                          </div>
                        </div>
                      </div>

                      <div class="row mb-3">
                        <div class="col-md-6">
                          <label for="newAccountDepartment" class="form-label">Department</label>
                          <div class="input-group">
                            <span class="input-group-text">
                              <i class="bi bi-building"></i>
                            </span>
                            <select class="form-control" id="newAccountDepartment" required>
                              <option value="">Select Department</option>
                              <option value="Administrative Division">Administrative Division</option>
                              <option value="Receiving Division">Receiving Division</option>
                              <option value="Endorsement Division">Endorsement Division</option>
                            </select>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <label for="newAccountStatus" class="form-label">Status</label>
                          <div class="input-group">
                            <span class="input-group-text">
                              <i class="bi bi-toggle-on"></i>
                            </span>
                            <select class="form-control" id="newAccountStatus" required>
                              <option value="active">Active</option>
                              <option value="inactive">Inactive</option>
                            </select>
                          </div>
                        </div>
                      </div>



                      <div class="mb-3 d-none">
                        <label for="fileUrl" class="form-label">Google Drive File URL</label>
                        <input type="url" class="form-control" id="fileUrl" placeholder="Paste Google Drive shareable link here" />
                        <div class="form-text">Upload your file to Google Drive, set sharing to 'Anyone with the link', and paste the link here.</div>
                        <div id="fileUrlPreview" class="mt-2"></div>
                      </div>

                      <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-danger" id="cancelAccountCreate" title="Cancel account creation">Cancel</button>
                        <button type="submit" class="btn btn-primary" title="Create the new account">Create Account</button>
                      </div>
                    </form>

                    <div class="table-responsive mt-4">
                      <table class="table table-hover" id="accountsTable">
                        <thead>
                          <tr>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Department</th>
                            <th>Status</th>
                            <th>Created At</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          <!-- Accounts will be populated here -->
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Create Entry Modal -->
    <div
      class="modal fade"
      id="createEntryModal"
      tabindex="-1"
      aria-labelledby="createEntryModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header card-header bg-white">
            <h5 class="modal-title" id="createEntryModalLabel">
              Create New Entry
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
              title="Close modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="createEntryForm">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="letterType" class="form-label">Type</label>
                  <select class="form-select" id="letterType" required>
                    <option value="">Select Type</option>
                    <option value="Complaint">Complaint</option>
                    <option value="Request">Request</option>
                    <option value="Proposal">Proposal</option>
                    <option value="Invitation">Invitation</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="controlNumber" class="form-label"
                    >Control Number</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="controlNumber"
                    readonly
                  />
                </div>
              </div>
              <div class="row mb-3 d-none">
                <div class="col-md-6">
                  <label for="dateReceived" class="form-label"
                    >Date Received</label
                  >
                  <input
                    type="date"
                    class="form-control"
                    id="dateReceived"
                    required
                  />
                </div>
                <div class="col-md-6">
                  <label for="timeReceived" class="form-label"
                    >Time Received</label
                  >
                  <input
                    type="time"
                    class="form-control"
                    id="timeReceived"
                    required
                  />
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="from" class="form-label">From</label>
                  <input type="text" class="form-control" id="from" required />
                </div>
                <div class="col-md-6">
                  <label for="office" class="form-label">Office</label>
                  <input
                    type="text"
                    class="form-control"
                    id="office"
                    required
                  />
                </div>
              </div>
              <div class="mb-3">
                <label for="subject" class="form-label">Subject</label>
                <input type="text" class="form-control" id="subject" required />
              </div>
              <div class="mb-3">
                <label for="endorsedTo" class="form-label">Endorsed To</label>
                <select class="form-select" id="endorsedTo" required>
                  <option value="">Select Office</option>
                  <option value="Vice Mayor's Office">
                    Vice Mayor's Office
                  </option>
                  <option value="Sangguniang Panlungsod">
                    Sangguniang Panlungsod
                  </option>
                  <option value="CAO">CAO</option>
                  <option value="CASSO">CASSO</option>
                  <option value="CADMO">CADMO</option>
                  <option value="CBO">CBO</option>
                  <option value="CEPMO">CEPMO</option>
                  <option value="CHRMO">CHRMO</option>
                  <option value="CLO">CLO</option>
                  <option value="CPDSO">CPDSO</option>
                  <option value="CTO">CTO</option>
                  <option value="GSO">GSO</option>
                  <option value="CBAO">CBAO</option>
                  <option value="CEO">CEO</option>
                  <option value="CSWDO">CSWDO</option>
                  <option value="HSO">HSO</option>
                  <option value="LCR">LCR</option>
                  <option value="CVAO">CVAO</option>
                  <option value="DepEd">DepEd</option>
                  <option value="COA">COA</option>
                  <option value="MTCC">MTCC</option>
                  <option value="RTCC">RTCC</option>
                  <option value="Prosecutor's Office">
                    Prosecutor's Office
                  </option>
                  <option value="PESO">PESO</option>
                  <option value="PIO">PIO</option>
                  <option value="PLD">PLD</option>
                  <option value="PLEB">PLEB</option>
                  <option value="POSD">POSD</option>
                  <option value="SSD">SSD</option>
                  <option value="PDAO">PDAO</option>
                  <option value="MITD">MITD</option>
                  <option value="CCTV/EWSS">CCTV/EWSS</option>
                  <option value="CDRRMO">CDRRMO</option>
                  <option value="LIBRARY">LIBRARY</option>
                  <option value="PERSONAL STAFF">PERSONAL STAFF</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="fileUpload" class="form-label">File Upload</label>
                <input
                  type="file"
                  class="form-control"
                  id="fileUpload"
                  accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                />
                <div class="form-text">
                  Accepted formats: PDF, DOC, DOCX, JPG, JPEG, PNG
                </div>
              </div>
              <div class="mb-3">
                <label for="remarks" class="form-label">Remarks</label>
                <textarea class="form-control" id="remarks" rows="3"></textarea>
              </div>
              <div class="mb-3">
                <label for="status" class="form-label">Status</label>
                <select class="form-select" id="status" required>
                  <option value="">Select Status</option>
                  <option value="Pending">Pending</option>
                  <option value="Processing">Processing</option>
                  <option value="Completed">Completed</option>
                  <option value="Archived">Archived</option>
                </select>
              </div>
              <!-- Add Client Email field to Create Entry Form -->
              <div class="mb-3">
                <label for="clientEmail" class="form-label">Client Email</label>
                <input type="email" class="form-control" id="clientEmail" name="clientEmail" required />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button type="button" class="btn btn-primary" id="saveEntry" title="Save new entry">
              Save Entry
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Entry Modal -->
    <div
      class="modal fade"
      id="editEntryModal"
      tabindex="-1"
      aria-labelledby="editEntryModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header card-header bg-white">
            <h5 class="modal-title" id="editEntryModalLabel">Edit Entry</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
              title="Close modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editEntryForm">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="editType" class="form-label">Type</label>
                  <select class="form-select" id="editType" required disabled>
                    <option value="">Select Type</option>
                    <option value="Complaint">Complaint</option>
                    <option value="Request">Request</option>
                    <option value="Proposal">Proposal</option>
                    <option value="Invitation">Invitation</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="editControlNumber" class="form-label">Control Number</label>
                  <input
                    type="text"
                    class="form-control"
                    id="editControlNumber"
                    required
                    disabled
                  />
                </div>
              </div>

              <div class="row mb-3 d-none">
                <div class="col-md-6">
                  <label for="editDateReceived" class="form-label">Date Received (Receiving Office)</label>
                  <input
                    type="date"
                    class="form-control"
                    id="editDateReceived"
                    required
                    disabled
                  />
                </div>
                <div class="col-md-6">
                  <label for="editTimeReceived" class="form-label">Time Received (Receiving Office)</label>
                  <input
                    type="time"
                    class="form-control"
                    id="editTimeReceived"
                    required
                    disabled
                  />
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="editAdminDateReceived" class="form-label">Date Received (Admin Office)</label>
                  <input
                    type="date"
                    class="form-control"
                    id="editAdminDateReceived"
                    required
                    title="Admin office date received"
                  />
                  <div class="form-text">Auto-filled with current date if empty</div>
                </div>
                <div class="col-md-6">
                  <label for="editAdminTimeReceived" class="form-label">Time Received (Admin Office)</label>
                  <input
                    type="time"
                    class="form-control"
                    id="editAdminTimeReceived"
                    required
                    title="Admin office time received"
                  />
                  <div class="form-text">Auto-filled with current time if empty</div>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="editFrom" class="form-label">From</label>
                  <input
                    type="text"
                    class="form-control"
                    id="editFrom"
                    required
                    disabled
                  />
                </div>
                <div class="col-md-6">
                  <label for="editOffice" class="form-label">Office</label>
                  <input
                    type="text"
                    class="form-control"
                    id="editOffice"
                    required
                    disabled
                  />
                </div>
              </div>

              <div class="mb-3">
                <label for="editSubject" class="form-label">Subject</label>
                <input
                  type="text"
                  class="form-control"
                  id="editSubject"
                  required
                  disabled
                />
              </div>

              <div class="mb-3">
                <label for="editFileCode" class="form-label">File Code</label>
                <input
                  type="text"
                  class="form-control"
                  id="editFileCode"
                  placeholder="Enter file code"
                />
              </div>

              <div class="mb-3">
                <label for="editEndorsedTo" class="form-label">Endorsed To</label>
                <select class="form-select" id="editEndorsedTo" required>
                  <option value="">Select Office</option>
                  <option value="Vice Mayor's Office">
                    Vice Mayor's Office
                  </option>
                  <option value="Sangguniang Panlungsod">
                    Sangguniang Panlungsod
                  </option>
                  <option value="CAO">CAO</option>
                  <option value="CASSO">CASSO</option>
                  <option value="CADMO">CADMO</option>
                  <option value="CBO">CBO</option>
                  <option value="CEPMO">CEPMO</option>
                  <option value="CHRMO">CHRMO</option>
                  <option value="CLO">CLO</option>
                  <option value="CPDSO">CPDSO</option>
                  <option value="CTO">CTO</option>
                  <option value="GSO">GSO</option>
                  <option value="CBAO">CBAO</option>
                  <option value="CEO">CEO</option>
                  <option value="CSWDO">CSWDO</option>
                  <option value="HSO">HSO</option>
                  <option value="LCR">LCR</option>
                  <option value="CVAO">CVAO</option>
                  <option value="DepEd">DepEd</option>
                  <option value="COA">COA</option>
                  <option value="MTCC">MTCC</option>
                  <option value="RTCC">RTCC</option>
                  <option value="Prosecutor's Office">
                    Prosecutor's Office
                  </option>
                  <option value="PESO">PESO</option>
                  <option value="PIO">PIO</option>
                  <option value="PLD">PLD</option>
                  <option value="PLEB">PLEB</option>
                  <option value="POSD">POSD</option>
                  <option value="SSD">SSD</option>
                  <option value="PDAO">PDAO</option>
                  <option value="MITD">MITD</option>
                  <option value="CCTV/EWSS">CCTV/EWSS</option>
                  <option value="CDRRMO">CDRRMO</option>
                  <option value="LIBRARY">LIBRARY</option>
                  <option value="PERSONAL STAFF">PERSONAL STAFF</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="editRemarks" class="form-label">Remarks</label>
                <textarea
                  class="form-control"
                  id="editRemarks"
                  rows="3"
                ></textarea>
              </div>
              <div class="mb-3">
                <label for="editStatus" class="form-label">Status</label>
                <select class="form-select" id="editStatus" required>
                  <option value="Pending">Pending</option>
                  <option value="Processing">Processing</option>
                  <option value="Completed">Completed</option>
                  <option value="Archived">Archived</option>
                  <option value="Under Investigation">Under Investigation (Ongoing)</option>
                  <option value="Inspection">Inspection, Acted Upon (Done)</option>
                </select>
              </div>
              <!-- Add Status Remarks field for status explanations -->
              <div class="mb-3">
                <label for="editStatusRemarks" class="form-label">Status Explanation</label>
                <textarea
                  class="form-control"
                  id="editStatusRemarks"
                  rows="3"
                  placeholder="Please provide explanation or reasons for the status change..."
                  required
                ></textarea>
                <div class="form-text">This explanation will be included in the email notification to the client.</div>
              </div>
              <div class="mb-3">
                <label for="editClientEmail" class="form-label">Client Email</label>
                <input type="email" class="form-control" id="editClientEmail" required disabled  />
              </div>
              <!-- Add Google Drive File URL field to Edit Entry Form -->
              <div class="mb-3">
                <label for="editFileUrl" class="form-label">Google Drive File URL</label>
                <input type="url" class="form-control" id="editFileUrl" placeholder="Paste Google Drive shareable link here" />
                <div class="form-text">Upload your file to Google Drive, set sharing to 'Anyone with the link', and paste the link here.</div>
                <div id="editFileUrlPreview" class="mt-2"></div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button type="button" class="btn btn-primary" id="updateEntry" title="Update entry">
              Update Entry
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- View Archived Entry Modal -->
    <div
      class="modal fade"
      id="viewArchivedModal"
      tabindex="-1"
      aria-labelledby="viewArchivedModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header card-header bg-white">
            <h5 class="modal-title" id="viewArchivedModalLabel">
              Archived Entry Details
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
              title="Close modal"
            ></button>
          </div>
          <div class="modal-body">
            <!-- Entry details will be populated here -->
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- View Audit Log Modal -->
    <div
      class="modal fade"
      id="viewAuditLogModal"
      tabindex="-1"
      aria-labelledby="viewAuditLogModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header card-header bg-white">
            <h5 class="modal-title" id="viewAuditLogModalLabel">
              Audit Log Details
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
              title="Close modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row mb-3">
              <div class="col-md-6">
                <strong>Timestamp:</strong> <span id="auditTimestamp"></span>
              </div>
              <div class="col-md-6">
                <strong>User:</strong> <span id="auditUser"></span>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <strong>Action:</strong> <span id="auditAction"></span>
              </div>
              <div class="col-md-6">
                <strong>Control Number:</strong>
                <span id="auditControlNumber"></span>
              </div>
            </div>
            <div class="mb-3">
              <strong>Details:</strong>
              <p id="auditDetails" class="mt-2"></p>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Create User Modal -->
    <div
      class="modal fade"
      id="createUserModal"
      tabindex="-1"
      aria-labelledby="createUserModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header card-header bg-white">
            <h5 class="modal-title" id="createUserModalLabel">Create New User</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
              title="Close modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="createUserForm">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="newFirstName" class="form-label">First Name</label>
                  <div class="input-group">
                    <span class="input-group-text">
                      <i class="bi bi-person"></i>
                    </span>
                  <input
                    type="text"
                      class="form-control with-icon"
                    id="newFirstName"
                      placeholder="First Name"
                    required
                  />
                  </div>
                </div>
                <div class="col-md-6">
                  <label for="newLastName" class="form-label">Last Name</label>
                  <div class="input-group">
                    <span class="input-group-text">
                      <i class="bi bi-person"></i>
                    </span>
                  <input
                    type="text"
                      class="form-control with-icon"
                    id="newLastName"
                      placeholder="Last Name"
                    required
                  />
                  </div>
                </div>
              </div>
              <div class="mb-3">
                <label for="newEmail" class="form-label">Email Address</label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="bi bi-envelope"></i>
                  </span>
                <input
                  type="email"
                    class="form-control with-icon"
                  id="newEmail"
                    placeholder="Email"
                  required
                />
              </div>
              </div>
              <div class="mb-3">
                <label for="newRole" class="form-label">Role</label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="bi bi-person-badge"></i>
                  </span>
                  <select class="form-control with-icon" id="newRole" required>
                  <option value="">Select Role</option>
                    <option value="Administrator">Administrator</option>
                    <option value="Staff">Staff</option>
                    <option value="Manager">Manager</option>
                </select>
                </div>
              </div>
              <div class="mb-3">
                <label for="newPassword" class="form-label">Password</label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="bi bi-key"></i>
                  </span>
                <input
                  type="password"
                    class="form-control with-icon"
                  id="newPassword"
                    placeholder="Password"
                  required
                />
                </div>
              </div>
              <div class="mb-3">
                <label for="confirmNewPassword" class="form-label">Confirm Password</label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="bi bi-key-fill"></i>
                  </span>
                <input
                  type="password"
                    class="form-control with-icon"
                  id="confirmNewPassword"
                    placeholder="Confirm Password"
                  required
                />
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button type="button" class="btn btn-primary" id="saveUser" title="Create user">
              Create User
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Sort/Filter Modal -->
    <div class="modal fade" id="sortFilterModal" tabindex="-1" aria-labelledby="sortFilterModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="sortFilterModalLabel">Sort & Filter Archived Entries</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" title="Close modal"></button>
          </div>
          <div class="modal-body">
            <form id="sortFilterForm">
              <div class="row mb-3">
                <div class="col-md-6 mb-3">
                  <label class="form-label fw-bold">Months</label>
                  <div class="d-flex flex-wrap gap-2">
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="January" id="monthJan" name="months"><label class="form-check-label" for="monthJan">January</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="February" id="monthFeb" name="months"><label class="form-check-label" for="monthFeb">February</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="March" id="monthMar" name="months"><label class="form-check-label" for="monthMar">March</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="April" id="monthApr" name="months"><label class="form-check-label" for="monthApr">April</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="May" id="monthMay" name="months"><label class="form-check-label" for="monthMay">May</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="June" id="monthJun" name="months"><label class="form-check-label" for="monthJun">June</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="July" id="monthJul" name="months"><label class="form-check-label" for="monthJul">July</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="August" id="monthAug" name="months"><label class="form-check-label" for="monthAug">August</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="September" id="monthSep" name="months"><label class="form-check-label" for="monthSep">September</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="October" id="monthOct" name="months"><label class="form-check-label" for="monthOct">October</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="November" id="monthNov" name="months"><label class="form-check-label" for="monthNov">November</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="December" id="monthDec" name="months"><label class="form-check-label" for="monthDec">December</label></div>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label fw-bold">Letter Types</label>
                  <div class="d-flex flex-wrap gap-2">
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="Complaint" id="typeComplaint" name="letterTypes"><label class="form-check-label" for="typeComplaint">Complaint</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="Request" id="typeRequest" name="letterTypes"><label class="form-check-label" for="typeRequest">Request</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="Proposal" id="typeProposal" name="letterTypes"><label class="form-check-label" for="typeProposal">Proposal</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="Invitation" id="typeInvitation" name="letterTypes"><label class="form-check-label" for="typeInvitation">Invitation</label></div>
                  </div>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-4 mb-3">
                  <label class="form-label fw-bold" for="filterDateReceived">Date Received</label>
                  <input type="date" class="form-control" id="filterDateReceived" name="dateReceived">
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label fw-bold" for="filterFrom">From</label>
                  <select class="form-select" id="filterFrom" name="from">
                    <option value="">All</option>
                    <!-- Options will be populated dynamically -->
                  </select>
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label fw-bold" for="filterOffice">Office</label>
                  <select class="form-select" id="filterOffice" name="office">
                    <option value="">All</option>
                    <!-- Options will be populated dynamically -->
                  </select>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6 mb-3">
                  <label class="form-label fw-bold" for="filterEndorsedTo">Endorsed To</label>
                  <select class="form-select" id="filterEndorsedTo" name="endorsedTo">
                    <option value="">All</option>
                    <!-- Options will be populated dynamically -->
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label fw-bold" for="filterStatus">Status</label>
                  <select class="form-select" id="filterStatus" name="status">
                    <option value="">All</option>
                    <!-- Options will be populated dynamically -->
                  </select>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="resetSortFilter" title="Reset filters">Reset</button>
            <button type="button" class="btn btn-primary" id="applySortFilter" title="Apply filters">Apply</button>
          </div>
        </div>
      </div>
    </div>

    <div id="notificationsSection" class="d-none">
      <div class="header-section card-header bg-white">
        <h1 class="h2 mb-1">All Notifications</h1>
        <p class="mb-0 text-muted">View all new entry notifications</p>
      </div>
      <div class="card mb-4">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover" id="notificationsTable">
              <thead>
                <tr>
                  <th>Control Number</th>
                  <th>Subject</th>
                  <th>Date Created</th>
                </tr>
              </thead>
              <tbody>
                <!-- Notifications will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- All Notifications Modal -->
    <div class="modal fade" id="allNotificationsModal" tabindex="-1" aria-labelledby="allNotificationsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="allNotificationsModalLabel">All Notifications</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" title="Close modal"></button>
          </div>
          <div class="modal-body">
            <div class="table-responsive">
              <table class="table table-hover" id="allNotificationsTable">
                <thead>
                  <tr>
                    <th>Control Number</th>
                    <th>Subject</th>
                    <th>Date Created</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Notifications will be populated here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
      crossorigin="anonymous"
    ></script>
    <!-- Add DataTables JS -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
    <!-- Add SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Add Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

    <script>
      // Initialize Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyCaSHRLbIRWW8COl5iwHb19dMDYYLJ2DIk",
        authDomain: "centralcomm-248a9.firebaseapp.com",
        databaseURL: "https://centralcomm-248a9-default-rtdb.firebaseio.com",
        projectId: "centralcomm-248a9",
        storageBucket: "centralcomm-248a9.firebasestorage.app",
        messagingSenderId: "796912003621",
        appId: "1:796912003621:web:0d6fd82e43399871a9edcc",
        measurementId: "G-CN0S9L5YV4",
      };

      // Initialize Firebase if not already initialized
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }

      const database = firebase.database();
      const entriesRef = database.ref("entries");
      
      // Global variable to track finished/unfinished toggle state
      let filterState = "all"; // "all", "unfinished", "finished"

      // Function to generate control number
      function generateControlNumber() {
        // Get the current year
        const year = new Date().getFullYear();
        
        // Get the last control number from the database
        return database.ref('lastControlNumber').once('value').then(snapshot => {
          let lastNumber = snapshot.val() || 0;
          lastNumber++;
          
          // Update the last control number in the database
          database.ref('lastControlNumber').set(lastNumber);
          
          // Format the number with leading zeros
          const formattedNumber = String(lastNumber).padStart(6, '0');
          return `${year}-${formattedNumber}`;
        });
      }

      // Function to check and archive old entries
      function checkAndArchiveEntries() {
        // Show loading state
        Swal.fire({
          title: "Checking Entries",
          text: "Please wait while we check for entries to archive...",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        const currentYear = new Date().getFullYear();
        entriesRef
          .once("value", (snapshot) => {
            const entries = snapshot.val();
            if (entries) {
              let archivedCount = 0;
              let totalToArchive = 0;

              // First count how many entries need to be archived
              Object.entries(entries).forEach(([_, entry]) => {
                const entryYear = new Date(entry.dateReceived).getFullYear();
                if (
                  currentYear > entryYear &&
                  entry.status !== "Archived"
                ) {
                  totalToArchive++;
                }
              });

              if (totalToArchive === 0) {
                Swal.close();
                // Initialize monthly data for new year if needed
                initializeMonthlyDataForNewYear();
                return;
              }

              // Update loading message
              Swal.update({
                title: "Archiving Entries",
                html: `Archiving ${totalToArchive} entries...`,
              });

              // Archive each entry
              Object.entries(entries).forEach(([key, entry]) => {
                const entryYear = new Date(entry.dateReceived).getFullYear();
                if (
                  currentYear > entryYear &&
                  entry.status !== "Archived"
                ) {
                  entriesRef
                    .child(key)
                    .update({
                      status: "Archived",
                      archivedAt: firebase.database.ServerValue.TIMESTAMP,
                    })
                    .then(() => {
                      archivedCount++;
                      logActivity(
                        "archive",
                        `Archived entry from ${entryYear}: ${entry.subject}`,
                        entry.controlNumber
                      );

                      // Update progress
                      if (archivedCount === totalToArchive) {
                        Swal.fire({
                          title: "Success!",
                          text: `Successfully archived ${archivedCount} entries!`,
                          icon: "success",
                          confirmButtonColor: "#002C75",
                        }).then(() => {
                          // Initialize monthly data for new year after archiving
                          initializeMonthlyDataForNewYear();
                        });
                      }
                    })
                    .catch((error) => {
                      console.error("Error archiving entry:", error);
                      Swal.fire({
                        title: "Error!",
                        text: "Error archiving entries. Please try again.",
                        icon: "error",
                        confirmButtonColor: "#dc3545",
                      });
                    });
                }
              });
            } else {
              Swal.close();
              // Initialize monthly data for new year if no entries exist
              initializeMonthlyDataForNewYear();
            }
          })
          .catch((error) => {
            console.error("Error checking entries:", error);
            Swal.close();
            showErrorAlert("Error checking entries. Please try again.");
          });
      }

      // Function to check if new month has arrived and refresh display
      function checkForNewMonth() {
        const selectedYear = document.getElementById("yearSelector")?.value || getCurrentYear();
        const currentYear = getCurrentYear();
        const currentMonth = new Date().getMonth();
        const currentMonthName = new Date().toLocaleString("default", { month: "long" });
        
        // If we're viewing the current year and a new month has started
        if (parseInt(selectedYear) === currentYear) {
          const monthKey = `${currentMonthName.toLowerCase()}${currentYear}`;
          const monthElement = document.getElementById(monthKey);
          
          // If the current month element doesn't exist, refresh the display
          if (!monthElement) {
            console.log(`New month detected: ${currentMonthName} ${currentYear}`);
            loadEntries(parseInt(selectedYear));
          }
        }
      }

      // Function to initialize monthly data for new year
      function initializeMonthlyDataForNewYear() {
        const currentYear = getCurrentYear();
        const months = [
          "January", "February", "March", "April", "May", "June",
          "July", "August", "September", "October", "November", "December"
        ];

        // Check if monthly data exists for current year
        database.ref(`monthlyData`).once("value", (snapshot) => {
          const monthlyData = snapshot.val() || {};
          let needsInitialization = false;

          // Check if we need to initialize data for current year only
          months.forEach(month => {
            const monthKey = `${month.toLowerCase()}${currentYear}`;
            if (!monthlyData[monthKey]) {
              needsInitialization = true;
            }
          });

          if (needsInitialization) {
            console.log(`Initializing monthly data for year ${currentYear}`);
            
            // Initialize empty monthly data for current year only
            months.forEach(month => {
              const monthKey = `${month.toLowerCase()}${currentYear}`;
              if (!monthlyData[monthKey]) {
                database.ref(`monthlyData/${monthKey}`).set({
                  total: 0,
                  complaints: 0,
                  proposals: 0,
                  invitations: 0,
                  requests: 0,
                  entries: []
                });
              }
            });

            logActivity(
              "system",
              `Initialized monthly data structure for year ${currentYear}`,
              "SYSTEM"
            );
          }
        });
      }

      // Function to load entries into the table
      function loadEntries(selectedYear = null) {
        const currentYear = getCurrentYear();
        const yearToLoad = selectedYear || currentYear;
        const now = new Date();
        const months = [
          "January", "February", "March", "April", "May", "June",
          "July", "August", "September", "October", "November", "December"
        ];
        
        // Determine which months to show based on the year
        let monthsToShow = [];
        if (yearToLoad < currentYear) {
          // For past years, show all months in descending order
          for (let i = 11; i >= 0; i--) {
            monthsToShow.push(months[i]);
          }
        } else if (yearToLoad === currentYear) {
          // For current year, show months up to current month in descending order
          const currentMonthIndex = now.getMonth();
          for (let i = currentMonthIndex; i >= 0; i--) {
            monthsToShow.push(months[i]);
          }
        } else {
          // For future years (2026+), show only months that have already arrived
          const currentMonthIndex = now.getMonth();
          const currentYearMonth = now.getFullYear();
          
          if (yearToLoad === currentYearMonth) {
            // If it's the current year, show months up to current month
            for (let i = currentMonthIndex; i >= 0; i--) {
              monthsToShow.push(months[i]);
            }
          } else {
            // For future years, don't show any months yet
            monthsToShow = [];
          }
        }
        
        entriesRef.on("value", (snapshot) => {
          const entries = snapshot.val();
          const accordionContainer = document.getElementById(
            "monthlyStatsAccordion"
          );

          // Clear existing content
          accordionContainer.innerHTML = "";

          // Check if there are months to show
          if (monthsToShow.length === 0) {
            // Show message for future years with no available months
            accordionContainer.innerHTML = `
              <div class="text-center py-5">
                <div class="alert alert-info" role="alert">
                  <h5 class="alert-heading">
                    <i class="bi bi-calendar-event me-2"></i>
                    No Months Available Yet
                  </h5>
                  <p class="mb-0">
                    The months for ${yearToLoad} will appear as they arrive. 
                    Currently, no months have been reached for this year.
                  </p>
                </div>
              </div>
            `;
            return;
          }

          // Create empty accordion items for the selected months
          monthsToShow.forEach((month) => {
            const monthKey = `${month.toLowerCase()}${yearToLoad}`;
            const accordionItem = document.createElement("div");
            accordionItem.className = "accordion-item border-0 mb-2";
            accordionItem.id = `accordion-${monthKey}`;
            accordionItem.innerHTML = `
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${monthKey}" title="Expand/collapse month details">
                  <div class="d-flex justify-content-between align-items-center w-100">
                    <div>
                      <span class="fw-bold">${month} ${yearToLoad}</span>
                    </div>
                    <div class="text-muted small">
                      <i class="bi bi-arrow-down-circle me-1"></i>
                      Click to view details
                    </div>
                  </div>
                </button>
              </h2>
              <div id="${monthKey}" class="accordion-collapse collapse" data-bs-parent="#monthlyStatsAccordion">
                <div class="accordion-body">
                  <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading data for ${month} ${yearToLoad}...</p>
                  </div>
                </div>
              </div>
            `;
            accordionContainer.appendChild(accordionItem);
          });

          // Then populate each month's data as it arrives
          monthsToShow.forEach((month) => {
            const monthKey = `${month.toLowerCase()}${yearToLoad}`;
            const tableId = `monthly-stats-table-${monthKey}`;

            // Get monthly data
            database
              .ref(`monthlyData/${monthKey}`)
              .once("value", (monthlySnapshot) => {
                const monthlyData = monthlySnapshot.val() || {
                  total: 0,
                  complaints: 0,
                  proposals: 0,
                  invitations: 0,
                  requests: 0,
                  entries: [],
                };

                // Get entries for this month
                const monthEntries = (monthlyData.entries || [])
                  .map((key) => {
                    const entry = entries[key];
                    return entry ? { key, ...entry } : null;
                  })
                  .filter((entry) => {
                    if (!entry || entry.status === "Archived") return false;
                    
                    // Apply filtering based on filter state
                    if (filterState === "unfinished") {
                      return entry.status !== "Completed" && entry.status !== "Inspection";
                    } else if (filterState === "finished") {
                      return entry.status === "Completed" || entry.status === "Inspection";
                    }
                    
                    return true; // Show all entries
                  });

                // Calculate statistics including archived entries
                const stats = {
                  complaints: 0,
                  proposals: 0,
                  invitations: 0,
                  requests: 0,
                  total: 0
                };

                // Count entries based on filter state
                (monthlyData.entries || []).forEach(key => {
                  const entry = entries[key];
                  if (entry && entry.status !== "Archived") {
                    let shouldCount = false;
                    
                    if (filterState === "unfinished") {
                      shouldCount = entry.status !== "Completed" && entry.status !== "Inspection";
                    } else if (filterState === "finished") {
                      shouldCount = entry.status === "Completed" || entry.status === "Inspection";
                    } else {
                      shouldCount = true; // Count all entries
                    }
                    
                    if (shouldCount) {
                      stats.total++;
                      const type = entry.type.toLowerCase();
                      if (type === 'complaint') stats.complaints++;
                      else if (type === 'proposal') stats.proposals++;
                      else if (type === 'invitation') stats.invitations++;
                      else if (type === 'request') stats.requests++;
                    }
                  }
                });

                // Calculate percentage for each type based on total
                function getTypePercent(count, total) {
                  if (total === 0) return 0;
                  return Math.round((count / total) * 100);
                }
                const complaintsPercent = getTypePercent(stats.complaints, stats.total);
                const proposalsPercent = getTypePercent(stats.proposals, stats.total);
                const invitationsPercent = getTypePercent(stats.invitations, stats.total);
                const requestsPercent = getTypePercent(stats.requests, stats.total);

                // Sort entries by date
                monthEntries.sort((a, b) => {
                  return new Date(b.dateReceived) - new Date(a.dateReceived);
                });

                // Update the accordion item with the data
                const accordionBody = document.querySelector(
                  `#${monthKey} .accordion-body`
                );
                if (accordionBody) {
                  accordionBody.innerHTML = `
                    <!-- ${month} Statistics -->
                    <div class="row mb-4">
                      <div class="col-md-3">
                        <div class="card bg-primary bg-opacity-10">
                          <div class="card-body">
                            <h6 class="card-title text-primary">Complaints</h6>
                            <h2 class="card-text">${stats.complaints}</h2>
                            <div class="d-flex align-items-center">
                              <span class="trend-indicator trend-up text-primary">
                                <i class="bi bi-arrow-up me-1"></i>${complaintsPercent}%
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="card bg-warning bg-opacity-10">
                          <div class="card-body">
                            <h6 class="card-title text-warning">Proposals</h6>
                            <h2 class="card-text">${stats.proposals}</h2>
                            <div class="d-flex align-items-center">
                              <span class="trend-indicator trend-up text-warning">
                                <i class="bi bi-arrow-up me-1"></i>${proposalsPercent}%
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="card bg-info bg-opacity-10">
                          <div class="card-body">
                            <h6 class="card-title text-info">Invitations</h6>
                            <h2 class="card-text">${stats.invitations}</h2>
                            <div class="d-flex align-items-center">
                              <span class="trend-indicator trend-up text-info">
                                <i class="bi bi-arrow-up me-1"></i>${invitationsPercent}%
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="card bg-warning bg-opacity-10">
                          <div class="card-body">
                            <h6 class="card-title text-success">Requests</h6>
                            <h2 class="card-text">${stats.requests}</h2>
                            <div class="d-flex align-items-center">
                              <span class="trend-indicator trend-up text-success">
                                <i class="bi bi-arrow-up me-1"></i>${requestsPercent}%
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="table-responsive">
                      <table class="table table-hover monthly-stats-table" id="${tableId}">
                        <thead>
                          <tr>
                            <th>#</th>
                            <th>Control Number</th>
                            <th>Letter Type</th>
                            <th>File</th>
                            <th>Time Received</th>
                            <th>Date Received</th>
                            <th>From</th>
                            <th>Office</th>
                            <th>Subject</th>
                            <th>Time Received (Admin)</th>
                            <th>Date Received (Admin)</th>
                            <th>Endorsed To</th>
                            <th>Remarks</th>
                            <th>File Code</th>
                            <th>Status</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                        </tbody>
                      </table>
                    </div>
                  `;

                  // Initialize DataTable with the data
                  setTimeout(() => {
                    try {
                      console.log(`Initializing table for ${month} with data:`, monthEntries);
                      initializeDataTable(monthKey, tableId, monthEntries);
                    } catch (error) {
                      console.error(`Error initializing DataTable for ${month}:`, error);
                    }
                  }, 100);
                }
              });
          });
        });
      }

      // Function to get status color
      function getStatusColor(status) {
        switch (status) {
          case "Pending":
            return "warning";
          case "Processing":
            return "info";
          case "Completed":
            return "success";
          case "Archived":
            return "secondary";
          default:
            return "primary";
        }
      }

      // Function to format date
      function formatDate(dateString) {
        try {
          const date = new Date(dateString);
          if (isNaN(date.getTime())) {
            return dateString;
          }
          return date.toLocaleDateString("en-US", {
            year: "numeric",
            month: "long",
            day: "numeric",
          });
        } catch (error) {
          console.error("Error formatting date:", error);
          return dateString;
        }
      }

      // Function to log activity
      function logActivity(action, details, controlNumber) {
        try {
          // Get section-specific user
          const sectionUser = getSectionUser();
          
          const logData = {
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            user: sectionUser.email,
            action: action || "unknown",
            details: details || "No details provided",
            controlNumber: controlNumber || "N/A",
            ipAddress: "127.0.0.1", // Replace with actual IP when available
            section: "admin" // Add section identifier
          };

          // Check if database is available
          if (!database) {
            console.error("Database not available for logging activity");
            return;
          }

          database
            .ref("logs")
            .push(logData)
            .then(() => {
              console.log("Activity logged successfully:", action, details);
            })
            .catch((error) => {
              console.error("Error logging activity:", error);
            });
        } catch (error) {
          console.error("Error in logActivity function:", error);
        }
      }

      // Function to show success alert
      function showSuccessAlert(message) {
        Swal.fire({
          title: "Success!",
          text: message,
          icon: "success",
          confirmButtonColor: "#002C75",
          timer: 2000,
          timerProgressBar: true,
        });
      }

      // Function to show error alert
      function showErrorAlert(message) {
        Swal.fire({
          title: "Error!",
          text: message,
          icon: "error",
          confirmButtonColor: "#dc3545",
        });
      }

      // Function to show confirmation dialog
      function showConfirmDialog(title, text, confirmButtonText) {
        return Swal.fire({
          title: title,
          text: text,
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#002C75",
          cancelButtonColor: "#dc3545",
          confirmButtonText: confirmButtonText,
        });
      }

      // Update delete entry function - now moves to archive instead of permanent deletion
      function deleteEntry(key) {
        showConfirmDialog(
          "Archive Entry",
          "This will move the entry to archives. You can restore it later if needed.",
          "Yes, archive it!"
        ).then((result) => {
          if (result.isConfirmed) {
            entriesRef.child(key).once("value", (snapshot) => {
              const entry = snapshot.val();
              if (entry) {
                entriesRef
                  .child(key)
                  .update({
                    status: "Archived",
                    archivedAt: firebase.database.ServerValue.TIMESTAMP,
                  })
                  .then(() => {
                    // Log the archiving in history
                    const logData = {
                      timestamp: firebase.database.ServerValue.TIMESTAMP,
                      user: "Admin", // Replace with actual user when authentication is implemented
                      action: "archive",
                      details: `Archived entry: ${entry.subject}`,
                      controlNumber: entry.controlNumber,
                      ipAddress: "127.0.0.1", // Replace with actual IP when available
                      userAgent: navigator.userAgent,
                    };

                    database
                      .ref("logs")
                      .push(logData)
                      .then(() => {
                        showSuccessAlert("Entry archived successfully!");
                        // Reload entries to update the table
                        const selectedYear = document.getElementById("yearSelector")?.value || getCurrentYear();
                        loadEntries(parseInt(selectedYear));
                      })
                      .catch((error) => {
                        console.error("Error logging archiving:", error);
                        showErrorAlert(
                          "Entry archived but failed to log the action."
                        );
                      });
                  })
                  .catch((error) => {
                    console.error("Error archiving entry:", error);
                    showErrorAlert("Error archiving entry. Please try again.");
                  });
              }
            });
          }
        });
      }

      // Function to archive all entries
      function archiveAllEntries() {
        showConfirmDialog(
          "Archive All Entries",
          "Are you sure you want to archive all entries? This action cannot be undone.",
          "Yes, archive all!"
        ).then((result) => {
          if (result.isConfirmed) {
            // Show initial loading state
            Swal.fire({
              title: "Preparing to Archive",
              text: "Please wait while we prepare to archive entries...",
              allowOutsideClick: false,
              didOpen: () => {
                Swal.showLoading();
              },
            });

            entriesRef
              .once("value", (snapshot) => {
                const entries = snapshot.val();
                if (entries) {
                  let archivedCount = 0;
                  let totalToArchive = 0;

                  // First count how many entries need to be archived
                  Object.entries(entries).forEach(([_, entry]) => {
                    if (entry.status !== "Archived") {
                      totalToArchive++;
                    }
                  });

                  if (totalToArchive === 0) {
                    Swal.fire({
                      title: "No Entries to Archive",
                      text: "There are no entries available to archive.",
                      icon: "info",
                      confirmButtonColor: "#002C75",
                    });
                    return;
                  }

                  // Update loading message
                  Swal.update({
                    title: "Archiving Entries",
                    html: `Archiving ${totalToArchive} entries...<br><br>
                          <div class="progress" style="height: 20px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: 0%" 
                                 id="archiveProgress">
                              0%
                            </div>
                          </div>`,
                  });

                  // Archive each entry
                  Object.entries(entries).forEach(([key, entry]) => {
                    if (entry.status !== "Archived") {
                      entriesRef
                        .child(key)
                        .update({
                          status: "Archived",
                          archivedAt: firebase.database.ServerValue.TIMESTAMP,
                        })
                        .then(() => {
                          archivedCount++;
                          logActivity(
                            "archive",
                            `Archived entry: ${entry.subject}`,
                            entry.controlNumber
                          );

                          // Update progress bar
                          const progress = Math.round(
                            (archivedCount / totalToArchive) * 100
                          );
                          document.getElementById(
                            "archiveProgress"
                          ).style.width = `${progress}%`;
                          document.getElementById(
                            "archiveProgress"
                          ).textContent = `${progress}%`;

                          // Update progress
                          if (archivedCount === totalToArchive) {
                            Swal.fire({
                              title: "Success!",
                              text: `Successfully archived ${archivedCount} entries!`,
                              icon: "success",
                              confirmButtonColor: "#002C75",
                            }).then(() => {
                              const selectedYear = document.getElementById("yearSelector")?.value || getCurrentYear();
                              loadEntries(parseInt(selectedYear));
                            });
                          }
                        })
                        .catch((error) => {
                          console.error("Error archiving entry:", error);
                          Swal.fire({
                            title: "Error!",
                            text: "Error archiving entries. Please try again.",
                            icon: "error",
                            confirmButtonColor: "#dc3545",
                          });
                        });
                    }
                  });
                } else {
                  Swal.fire({
                    title: "No Entries Found",
                    text: "There are no entries in the database.",
                    icon: "info",
                    confirmButtonColor: "#002C75",
                  });
                }
              })
              .catch((error) => {
                console.error("Error preparing to archive:", error);
                Swal.fire({
                  title: "Error!",
                  text: "Error preparing to archive entries. Please try again.",
                  icon: "error",
                  confirmButtonColor: "#dc3545",
                });
              });
          }
        });
      }

      // Update restore entry function
      function restoreEntry(key) {
        showConfirmDialog(
          "Restore Entry",
          "Are you sure you want to restore this entry?",
          "Yes, restore it!"
        ).then((result) => {
          if (result.isConfirmed) {
            // First get the entry details to log the control number
            entriesRef.child(key).once("value", (snapshot) => {
              const entry = snapshot.val();
              if (entry) {
                entriesRef
                  .child(key)
                  .update({
                    status: "Pending",
                    restoredAt: firebase.database.ServerValue.TIMESTAMP,
                  })
                  .then(() => {
                    logActivity("restore", `Restored archived entry: ${entry.subject}`, entry.controlNumber);
                    showSuccessAlert("Entry restored successfully!");
                    loadArchivedEntries();
                  })
                  .catch((error) => {
                    console.error("Error restoring entry:", error);
                    showErrorAlert("Error restoring entry. Please try again.");
                  });
              }
            });
          }
        });
      }

      // Update create entry handler
      document
        .getElementById("saveEntry")
        .addEventListener("click", function () {
          const formData = {
            type: document.getElementById("letterType").value,
            dateReceived: document.getElementById("dateReceived").value,
            timeReceived: document.getElementById("timeReceived").value,
            from: document.getElementById("from").value,
            office: document.getElementById("office").value,
            subject: document.getElementById("subject").value,
            endorsedTo: document.getElementById("endorsedTo").value,
            status: document.getElementById("status").value,
            statusRemarks: document.getElementById("editStatusRemarks").value, // Save status remarks   
            fromEmail: document.getElementById("clientEmail").value, // Save client email
            createdAt: firebase.database.ServerValue.TIMESTAMP,
            fileUrl: document.getElementById("fileUrl").value,
          };

          // Generate control number first
          generateControlNumber().then(controlNumber => {
            formData.controlNumber = controlNumber;

            // Get the month and year for monthly data
            const entryDate = new Date(formData.dateReceived);
            const month = entryDate
              .toLocaleString("default", { month: "long" })
              .toLowerCase();
            const year = entryDate.getFullYear();
            const monthKey = `${month}${year}`;

            // Save the entry
            entriesRef
              .push(formData)
              .then((ref) => {
                // Save monthly data
                const monthlyRef = database.ref(`monthlyData/${monthKey}`);
                monthlyRef.once("value", (snapshot) => {
                  const monthlyData = snapshot.val() || {
                    total: 0,
                    complaints: 0,
                    proposals: 0,
                    invitations: 0,
                    requests: 0,
                    entries: [],
                  };

                  // Update monthly statistics
                  monthlyData.total++;
                  monthlyData[formData.type.toLowerCase() + "s"]++;
                  monthlyData.entries.push(ref.key);

                  // Save updated monthly data
                  monthlyRef
                    .set(monthlyData)
                    .then(() => {
                      logActivity(
                        "create",
                        `Created new entry: ${formData.subject}`,
                        formData.controlNumber
                      );

                      // Reset form
                      document.getElementById("createEntryForm").reset();

                      // Set current date and time
                      const now = new Date();
                      const currentDate = now.toISOString().split("T")[0];
                      const currentTime = now.toTimeString().slice(0, 5);
                      document.getElementById("dateReceived").value = currentDate;
                      document.getElementById("timeReceived").value = currentTime;

                      // Generate new control number
                      generateControlNumber().then(newControlNumber => {
                        document.getElementById("controlNumber").value = newControlNumber;
                      });

                      // Show success message
                      showSuccessAlert("Entry created successfully!");

                      // Send email notification to client immediately after creation
                      sendStatusUpdateEmail(formData);

                      // Close modal
                      const modal = bootstrap.Modal.getInstance(
                        document.getElementById("createEntryModal")
                      );
                      modal.hide();

                      // Reload entries
                      const selectedYear = document.getElementById("yearSelector")?.value || getCurrentYear();
                      loadEntries(parseInt(selectedYear));

                      // Open the relevant month's accordion
                      setTimeout(() => {
                        const accordionButton = document.querySelector(
                          `button[data-bs-target="#${monthKey}"]`
                        );
                        if (accordionButton) {
                          accordionButton.click();
                        }
                      }, 500);
                    })
                    .catch((error) => {
                      console.error("Error saving monthly data:", error);
                      showErrorAlert(
                        "Error saving monthly data. Please try again."
                      );
                    });
                });
              })
              .catch((error) => {
                console.error("Error creating entry:", error);
                showErrorAlert("Error creating entry. Please try again.");
              });
          });
        });

      // Update edit entry handler
      document.getElementById("updateEntry").addEventListener("click", function() {
        const key = document.getElementById("editEntryForm").dataset.key;
        
        // Get current entry data to compare changes
        entriesRef.child(key).once("value", (snapshot) => {
          const originalEntry = snapshot.val();
          
          const formData = {
            type: document.getElementById("editType").value,
            controlNumber: document.getElementById("editControlNumber").value,
            dateReceived: document.getElementById("editDateReceived").value,
            timeReceived: document.getElementById("editTimeReceived").value,
            adminDateReceived: document.getElementById("editAdminDateReceived").value,
            adminTimeReceived: document.getElementById("editAdminTimeReceived").value,
            from: document.getElementById("editFrom").value,
            office: document.getElementById("editOffice").value,
            subject: document.getElementById("editSubject").value,
            fileCode: document.getElementById("editFileCode").value,
            endorsedTo: document.getElementById("editEndorsedTo").value,
            remarks: document.getElementById("editRemarks").value,
            status: document.getElementById("editStatus").value,
            statusRemarks: document.getElementById("editStatusRemarks").value, // Save status remarks
            fromEmail: document.getElementById("editClientEmail").value, // Save client email
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
            fileUrl: document.getElementById("editFileUrl").value,
          };

          // Validate required fields
          if (!formData.type || !formData.dateReceived || !formData.timeReceived || 
              !formData.adminDateReceived || !formData.adminTimeReceived ||
              !formData.from || !formData.office || !formData.subject || !formData.status || !formData.statusRemarks) {
            showErrorAlert("Please fill in all required fields, including status remarks/explanation.");
            return;
          }

          // Track specific field changes for logging
          const changes = [];
          
          // Check for changes in tracked fields for admin
          if (originalEntry.fileCode !== formData.fileCode) {
            changes.push(`File Code: "${originalEntry.fileCode || 'None'}"  "${formData.fileCode || 'None'}"`);
          }
          if (originalEntry.endorsedTo !== formData.endorsedTo) {
            changes.push(`Endorsed To: "${originalEntry.endorsedTo || 'None'}"  "${formData.endorsedTo || 'None'}"`);
          }
          if (originalEntry.remarks !== formData.remarks) {
            changes.push(`Remarks: "${originalEntry.remarks || 'None'}"  "${formData.remarks || 'None'}"`);
          }
          if (originalEntry.status !== formData.status) {
            changes.push(`Status: "${originalEntry.status}"  "${formData.status}"`);
          }
          if (originalEntry.statusRemarks !== formData.statusRemarks) {
            changes.push(`Status Explanation: "${originalEntry.statusRemarks || 'None'}"  "${formData.statusRemarks || 'None'}"`);
          }

          entriesRef
            .child(key)
            .update(formData)
            .then(() => {
              // Log specific field changes if any
              if (changes.length > 0) {
                changes.forEach(change => {
                  logActivity(
                    "field_update",
                    `Field updated: ${change}`,
                    formData.controlNumber
                  );
                });
              } else {
                // Log general update if no tracked fields changed
                logActivity(
                  "update",
                  `Updated entry: ${formData.subject}`,
                  formData.controlNumber
                );
              }

              showSuccessAlert("Entry updated successfully!");
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("editEntryModal")
              );
              modal.hide();

              // Send email notification to client
              sendStatusUpdateEmail(formData);

              const entryDate = new Date(formData.dateReceived);
              const monthKey =
                entryDate
                  .toLocaleString("default", { month: "long" })
                  .toLowerCase() + entryDate.getFullYear();
              const selectedYear = document.getElementById("yearSelector")?.value || getCurrentYear();
              loadEntries(parseInt(selectedYear));
              setTimeout(() => {
                const accordionButton = document.querySelector(
                  `button[data-bs-target=\"#${monthKey}\"]`
                );
                if (accordionButton) {
                  accordionButton.click();
                }
              }, 500);
            })
            .catch((error) => {
              console.error("Error updating entry:", error);
              showErrorAlert("Error updating entry. Please try again.");
            });
        });
      });

      // Update profile form submission
      document.getElementById("profileForm").addEventListener("submit", function (e) {
          e.preventDefault();
        const user = firebase.auth().currentUser;
        const sectionUser = getSectionUser();
        if (!user || !sectionUser) return;

          const profileData = {
            firstName: document.getElementById("firstName").value,
            lastName: document.getElementById("lastName").value,
            email: document.getElementById("email").value,
            phone: document.getElementById("phone").value,
            department: document.getElementById("department").value,
            position: document.getElementById("position").value,
          role: document.getElementById("role").value,
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
          };

        // Update user data in database
        database.ref("users/" + user.uid).update(profileData)
            .then(() => {
              // Update section-specific user info
              setSectionUser({
                email: profileData.email,
                name: `${profileData.firstName} ${profileData.lastName}`,
                role: profileData.role
              });
              
              showSuccessAlert("Profile updated successfully!");
              // logActivity("profile_update", "Updated profile information", "admin"); // Removed - not entry-related
            })
            .catch((error) => {
              console.error("Error updating profile:", error);
              showErrorAlert("Error updating profile. Please try again.");
            });
        });

      // Update password change form submission
      document.getElementById("passwordForm").addEventListener("submit", function (e) {
          e.preventDefault();
        const user = firebase.auth().currentUser;
        const sectionUser = getSectionUser();
        if (!user || !sectionUser) return;

        const currentPassword = document.getElementById("currentPassword").value;
          const newPassword = document.getElementById("newPassword").value;
        const confirmPassword = document.getElementById("confirmPassword").value;

          if (newPassword !== confirmPassword) {
            showErrorAlert("New passwords do not match!");
            return;
          }

        // Reauthenticate user before changing password
        const credential = firebase.auth.EmailAuthProvider.credential(
          user.email,
          currentPassword
        );

        user.reauthenticateWithCredential(credential)
          .then(() => {
            return user.updatePassword(newPassword);
          })
          .then(() => {
            showSuccessAlert("Password updated successfully!");
            // logActivity("password_change", "Changed password", "admin"); // Removed - not entry-related
            document.getElementById("passwordForm").reset();
          })
          .catch((error) => {
            console.error("Error changing password:", error);
            showErrorAlert("Error changing password. Please try again.");
          });
        });

      // Password toggle functionality
      document.getElementById("toggleCurrentPassword").addEventListener("click", function() {
        const passwordField = document.getElementById("currentPassword");
        const icon = document.getElementById("currentPasswordIcon");
        
        if (passwordField.type === "password") {
          passwordField.type = "text";
          icon.classList.remove("bi-eye");
          icon.classList.add("bi-eye-slash");
        } else {
          passwordField.type = "password";
          icon.classList.remove("bi-eye-slash");
          icon.classList.add("bi-eye");
        }
      });

      document.getElementById("toggleNewPassword").addEventListener("click", function() {
        const passwordField = document.getElementById("newPassword");
        const icon = document.getElementById("newPasswordIcon");
        
        if (passwordField.type === "password") {
          passwordField.type = "text";
          icon.classList.remove("bi-eye");
          icon.classList.add("bi-eye-slash");
        } else {
          passwordField.type = "password";
          icon.classList.remove("bi-eye-slash");
          icon.classList.add("bi-eye");
        }
      });

      document.getElementById("toggleConfirmPassword").addEventListener("click", function() {
        const passwordField = document.getElementById("confirmPassword");
        const icon = document.getElementById("confirmPasswordIcon");
        
        if (passwordField.type === "password") {
          passwordField.type = "text";
          icon.classList.remove("bi-eye");
          icon.classList.add("bi-eye-slash");
        } else {
          passwordField.type = "password";
          icon.classList.remove("bi-eye-slash");
          icon.classList.add("bi-eye");
        }
      });


      // Edit entry function
      function editEntry(key) {
        entriesRef.child(key).once("value", (snapshot) => {
          const entry = snapshot.val();
          if (entry) {
            document.getElementById("editType").value = entry.type;
            document.getElementById("editStatus").value = entry.status;
            document.getElementById("editControlNumber").value = entry.controlNumber;
            document.getElementById("editDateReceived").value = entry.dateReceived;
            document.getElementById("editTimeReceived").value = entry.timeReceived;
            document.getElementById("editAdminDateReceived").value = entry.adminDateReceived;
            document.getElementById("editAdminTimeReceived").value = entry.adminTimeReceived;
            document.getElementById("editFrom").value = entry.from;
            document.getElementById("editOffice").value = entry.office;
            document.getElementById("editSubject").value = entry.subject;
            document.getElementById("editFileCode").value = entry.fileCode;
            document.getElementById("editEndorsedTo").value = entry.endorsedTo;
            document.getElementById("editRemarks").value = entry.remarks || "";
            // Set status remarks in edit form
            document.getElementById("editStatusRemarks").value = entry.statusRemarks || "";
            // Set client email in edit form
            document.getElementById("editClientEmail").value = entry.fromEmail || "";
            document.getElementById("editEntryForm").dataset.key = key;
            document.getElementById("editFileUrl").value = entry.fileUrl || "";
            
            // Auto-fill admin date and time with current system time if empty
            const adminDateField = document.getElementById("editAdminDateReceived");
            const adminTimeField = document.getElementById("editAdminTimeReceived");
            
            // If admin date/time are empty, auto-fill with current system time
            if (!adminDateField.value) {
              const now = new Date();
              adminDateField.value = now.toISOString().split("T")[0];
            }
            if (!adminTimeField.value) {
              const now = new Date();
              adminTimeField.value = now.toTimeString().slice(0, 5);
            }
            
            // Show preview for fileUrl in edit modal
            const previewDiv = document.getElementById("editFileUrlPreview");
            if (entry.fileUrl) {
              let embedUrl = entry.fileUrl;
              if (embedUrl.includes("view?usp=sharing")) {
                embedUrl = embedUrl.replace("view?usp=sharing", "preview");
              }
              previewDiv.innerHTML = `<a href="${entry.fileUrl}" target="_blank" class="btn btn-outline-primary btn-sm mb-2">View File in Google Drive</a><br><iframe src="${embedUrl}" width="100%" height="400" style="border:1px solid #ccc;"></iframe>`;
            } else {
              previewDiv.innerHTML = "<span class='text-muted'>No file link provided.</span>";
            }
            // Also update preview when the admin changes the file URL in the edit modal
            document.getElementById("editFileUrl").addEventListener("input", function() {
              const url = this.value;
              if (url) {
                let embedUrl = url;
                if (embedUrl.includes("view?usp=sharing")) {
                  embedUrl = embedUrl.replace("view?usp=sharing", "preview");
                }
                previewDiv.innerHTML = `<a href="${url}" target="_blank" class="btn btn-outline-primary btn-sm mb-2">View File in Google Drive</a><br><iframe src="${embedUrl}" width="100%" height="400" style="border:1px solid #ccc;"></iframe>`;
              } else {
                previewDiv.innerHTML = "<span class='text-muted'>No file link provided.</span>";
              }
            });
          }
        });
      }

      // Update control number when date changes in create form
      document
        .getElementById("dateReceived")
        .addEventListener("change", function () {
          const controlNumber = generateControlNumber(this.value);
          document.getElementById("controlNumber").value = controlNumber;
        });

      // Update control number when date changes in edit form
      document
        .getElementById("editDateReceived")
        .addEventListener("change", function () {
          const controlNumber = generateControlNumber(this.value);
          document.getElementById("editControlNumber").value = controlNumber;
        });

      // Set current time when modal opens
      document
        .getElementById("createEntryModal")
        .addEventListener("show.bs.modal", function () {
          const now = new Date();
          const currentDate = now.toISOString().split("T")[0];
          const currentTime = now.toTimeString().slice(0, 5);

          document.getElementById("dateReceived").value = currentDate;
          document.getElementById("timeReceived").value = currentTime;
          
          // Generate and display control number
          generateControlNumber().then(controlNumber => {
            document.getElementById("controlNumber").value = controlNumber;
          });
        });

      // Section-specific user management
      const SECTION_NAME = "admin";
      const DEFAULT_EMAIL = "cmobaguio2600@gmail.com";
      const DEFAULT_NAME = "Admin";
      const DEFAULT_ROLE = "Administrator";

      // Function to get section-specific user info
      function getSectionUser() {
        const sectionUser = localStorage.getItem(`sectionUser_${SECTION_NAME}`);
        if (sectionUser) {
          return JSON.parse(sectionUser);
        }
        return {
          email: DEFAULT_EMAIL,
          name: DEFAULT_NAME,
          role: DEFAULT_ROLE
        };
      }

      // Function to set section-specific user info
      function setSectionUser(userInfo) {
        localStorage.setItem(`sectionUser_${SECTION_NAME}`, JSON.stringify(userInfo));
        updateUserDisplay(userInfo);
      }

      // Function to update user display
      function updateUserDisplay(userInfo) {
        const currentUserEmailElement = document.getElementById("currentUserEmailadmin");
        const currentUserNameElement = document.getElementById("currentUserName");
        const currentUserRoleElement = document.getElementById("currentUserRole");
        
        if (currentUserEmailElement) {
          currentUserEmailElement.textContent = userInfo.email;
        }
        if (currentUserNameElement) {
          currentUserNameElement.textContent = userInfo.name;
        }
        if (currentUserRoleElement) {
          currentUserRoleElement.textContent = userInfo.role;
        }
      }

      // Function to validate section access
      function validateSectionAccess() {
        const currentUser = getSectionUser();
        const allowedEmails = [
          "cmobaguio2600@gmail.com",
          "admin@centralcomm.com"
        ];
        
        if (!allowedEmails.includes(currentUser.email)) {
          console.warn("User not authorized for admin section:", currentUser.email);
          // You can redirect or show warning here
        }
      }

      // Function to populate year selector
      function populateYearSelector() {
        const yearSelector = document.getElementById("yearSelector");
        if (!yearSelector) return;

        // Get all available years from the database
        entriesRef.once("value", (snapshot) => {
          const entries = snapshot.val();
          const years = new Set();
          
          if (entries) {
            Object.values(entries).forEach(entry => {
              const year = new Date(entry.dateReceived).getFullYear();
              years.add(year);
            });
          }
          
          // Add current year if no entries exist
          const currentYear = getCurrentYear();
          years.add(currentYear);
          
          // Add 2026 specifically
          years.add(2026);
          
          // Only add next year if we're in the last quarter of the current year (October onwards)
          const currentMonth = new Date().getMonth();
          if (currentMonth >= 9) { // October, November, December
            years.add(currentYear + 1);
          }
          
          // Sort years in descending order
          const sortedYears = Array.from(years).sort((a, b) => b - a);
          
          // Populate the selector
          yearSelector.innerHTML = sortedYears.map(year => 
            `<option value="${year}" ${year === currentYear ? 'selected' : ''}>${year}</option>`
          ).join('');
          
          // Add event listener for year changes
          yearSelector.addEventListener("change", function() {
            const selectedYear = parseInt(this.value);
            loadEntries(selectedYear);
          });

          // Also populate the reports year selector
          const reportsYearSelector = document.getElementById("reportsYearSelector");
          if (reportsYearSelector) {
            reportsYearSelector.innerHTML = sortedYears.map(year => 
              `<option value="${year}" ${year === currentYear ? 'selected' : ''}>${year}</option>`
            ).join('');
            
            // Add event listener for reports year changes
            reportsYearSelector.addEventListener("change", function() {
              const selectedYear = parseInt(this.value);
              loadDocuments();
            });
          }
        });
      }

      // Export functions
      function getReportData() {
        const selectedYear = document.getElementById("reportsYearSelector")?.value || getCurrentYear();
        const yearlyData = {
          total: document.getElementById("yearlyTotal")?.textContent || "0",
          complaints: document.getElementById("yearlyComplaints")?.textContent || "0",
          requests: document.getElementById("yearlyRequests")?.textContent || "0",
          proposals: document.getElementById("yearlyProposals")?.textContent || "0",
          invitations: document.getElementById("yearlyInvitations")?.textContent || "0",
          finished: document.getElementById("yearlyFinished")?.textContent || "0",
          unfinished: document.getElementById("yearlyUnfinished")?.textContent || "0"
        };
        
        const monthlyData = {
          total: document.getElementById("monthlyTotal")?.textContent || "0",
          avgDaily: document.getElementById("avgDailyLetters")?.textContent || "0",
          highestVolume: document.getElementById("highestVolumeMonth")?.textContent || "-",
          lowestVolume: document.getElementById("lowestVolumeMonth")?.textContent || "-",
          finished: document.getElementById("monthlyFinished")?.textContent || "0",
          unfinished: document.getElementById("monthlyUnfinished")?.textContent || "0"
        };

        return { selectedYear, yearlyData, monthlyData };
      }

      function exportToClipboard() {
        const { selectedYear, yearlyData, monthlyData } = getReportData();
        
        const reportText = `Documents Report - ${selectedYear}

Yearly Statistics:
- Total Letters Received: ${yearlyData.total}
- Complaints: ${yearlyData.complaints}
- Requests: ${yearlyData.requests}
- Proposals: ${yearlyData.proposals}
- Invitations: ${yearlyData.invitations}
- Finished Letters: ${yearlyData.finished}
- Unfinished Letters: ${yearlyData.unfinished}

Monthly Statistics:
- Current Month Letters: ${monthlyData.total}
- Average Daily Letters: ${monthlyData.avgDaily}
- Highest Volume Month: ${monthlyData.highestVolume}
- Lowest Volume Month: ${monthlyData.lowestVolume}
- Finished Letters: ${monthlyData.finished}
- Unfinished Letters: ${monthlyData.unfinished}`;

        navigator.clipboard.writeText(reportText).then(() => {
          Swal.fire({
            icon: 'success',
            title: 'Copied to Clipboard!',
            text: 'Report data has been copied to your clipboard.',
            timer: 2000,
            showConfirmButton: false
          });
        }).catch(() => {
          Swal.fire({
            icon: 'error',
            title: 'Copy Failed',
            text: 'Failed to copy to clipboard. Please try again.',
          });
        });
      }

      function exportToCSV() {
        const { selectedYear, yearlyData, monthlyData } = getReportData();
        
        const csvContent = `Category,Value
Year,${selectedYear}
Yearly Statistics,,,
Total Letters Received,${yearlyData.total}
Complaints,${yearlyData.complaints}
Requests,${yearlyData.requests}
Proposals,${yearlyData.proposals}
Invitations,${yearlyData.invitations}
Finished Letters,${yearlyData.finished}
Unfinished Letters,${yearlyData.unfinished}
Monthly Statistics,,,
Current Month Letters,${monthlyData.total}
Average Daily Letters,${monthlyData.avgDaily}
Highest Volume Month,${monthlyData.highestVolume}
Lowest Volume Month,${monthlyData.lowestVolume}
Finished Letters,${monthlyData.finished}
Unfinished Letters,${monthlyData.unfinished}`;

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `documents_report_${selectedYear}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function exportToExcel() {
        const { selectedYear, yearlyData, monthlyData } = getReportData();
        
        const workbook = XLSX.utils.book_new();
        
        // Yearly Statistics Sheet
        const yearlySheet = XLSX.utils.aoa_to_sheet([
          ['Documents Report - Yearly Statistics', selectedYear],
          [''],
          ['Category', 'Value'],
          ['Total Letters Received', parseInt(yearlyData.total)],
          ['Complaints', parseInt(yearlyData.complaints)],
          ['Requests', parseInt(yearlyData.requests)],
          ['Proposals', parseInt(yearlyData.proposals)],
          ['Invitations', parseInt(yearlyData.invitations)],
          ['Finished Letters', parseInt(yearlyData.finished)],
          ['Unfinished Letters', parseInt(yearlyData.unfinished)]
        ]);
        
        // Monthly Statistics Sheet
        const monthlySheet = XLSX.utils.aoa_to_sheet([
          ['Documents Report - Monthly Statistics', selectedYear],
          [''],
          ['Category', 'Value'],
          ['Current Month Letters', parseInt(monthlyData.total)],
          ['Average Daily Letters', parseFloat(monthlyData.avgDaily)],
          ['Highest Volume Month', monthlyData.highestVolume],
          ['Lowest Volume Month', monthlyData.lowestVolume],
          ['Finished Letters', parseInt(monthlyData.finished)],
          ['Unfinished Letters', parseInt(monthlyData.unfinished)]
        ]);
        
        XLSX.utils.book_append_sheet(workbook, yearlySheet, 'Yearly Statistics');
        XLSX.utils.book_append_sheet(workbook, monthlySheet, 'Monthly Statistics');
        
        XLSX.writeFile(workbook, `documents_report_${selectedYear}.xlsx`);
      }

      function exportToPDF() {
        const { selectedYear, yearlyData, monthlyData } = getReportData();
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Title
        doc.setFontSize(20);
        doc.text('Documents Report', 105, 20, { align: 'center' });
        doc.setFontSize(14);
        doc.text(`Year: ${selectedYear}`, 105, 30, { align: 'center' });
        
        // Yearly Statistics
        doc.setFontSize(16);
        doc.text('Yearly Statistics', 20, 50);
        doc.setFontSize(12);
        
        const yearlyStats = [
          ['Total Letters Received', yearlyData.total],
          ['Complaints', yearlyData.complaints],
          ['Requests', yearlyData.requests],
          ['Proposals', yearlyData.proposals],
          ['Invitations', yearlyData.invitations],
          ['Finished Letters', yearlyData.finished],
          ['Unfinished Letters', yearlyData.unfinished]
        ];
        
        doc.autoTable({
          startY: 60,
          head: [['Category', 'Value']],
          body: yearlyStats,
          theme: 'grid',
          headStyles: { fillColor: [41, 128, 185] }
        });
        
        // Monthly Statistics
        doc.setFontSize(16);
        doc.text('Monthly Statistics', 20, 140);
        doc.setFontSize(12);
        
        const monthlyStats = [
          ['Current Month Letters', monthlyData.total],
          ['Average Daily Letters', monthlyData.avgDaily],
          ['Highest Volume Month', monthlyData.highestVolume],
          ['Lowest Volume Month', monthlyData.lowestVolume],
          ['Finished Letters', monthlyData.finished],
          ['Unfinished Letters', monthlyData.unfinished]
        ];
        
        doc.autoTable({
          startY: 150,
          head: [['Category', 'Value']],
          body: monthlyStats,
          theme: 'grid',
          headStyles: { fillColor: [41, 128, 185] }
        });
        
        doc.save(`documents_report_${selectedYear}.pdf`);
      }

      // Load entries and check for archiving when page loads
      document.addEventListener("DOMContentLoaded", function () {
        // Initialize section-specific user management
        const sectionUser = getSectionUser();
        updateUserDisplay(sectionUser);
        validateSectionAccess();

        // Admin section uses Firebase auth for authentication but section-specific display
        console.log("Admin section loaded with section-specific user:", sectionUser);
        
        // Initialize Firebase auth state listener (for authentication only)
        firebase.auth().onAuthStateChanged(function(user) {
          if (user) {
            console.log("Firebase user signed in:", user.email);
            // Get the logged-in email from storage or use Firebase user email
            const loggedInEmail = sessionStorage.getItem('adminLoggedInUserEmail') || localStorage.getItem('adminLoggedInUserEmail') || user.email;
            
            // Update section user with the actual logged-in email
            setSectionUser({
              email: loggedInEmail,
              name: "Admin",
              role: "Administrator"
            });
          } else {
            console.log("No Firebase user signed in");
            // Keep section-specific user info
          }
        });

        checkAndArchiveEntries();
        populateYearSelector();
        loadEntries();
        
        // Add event listener for toggle finished/unfinished button
        document.getElementById("toggleFinishedBtn").addEventListener("click", function() {
          // Cycle through three states: all -> unfinished -> finished -> all
          if (filterState === "all") {
            filterState = "unfinished";
          } else if (filterState === "unfinished") {
            filterState = "finished";
          } else {
            filterState = "all";
          }
          
          // Update button appearance
          const icon = this.querySelector("i");
          const text = this.querySelector("#toggleFinishedText");
          
          if (filterState === "unfinished") {
            icon.className = "bi bi-eye me-1";
            text.textContent = "Show All Finished";
            this.classList.remove("btn-outline-primary");
            this.classList.add("btn-primary");
          } else if (filterState === "finished") {
            icon.className = "bi bi-check-circle me-1";
            text.textContent = "Show All";
            this.classList.remove("btn-outline-primary");
            this.classList.add("btn-primary");
          } else {
            icon.className = "bi bi-eye-slash me-1";
            text.textContent = "Show Unfinished Only";
            this.classList.remove("btn-outline-primary");
            this.classList.add("btn-primary");
          }
          
          // Reload entries with current year
          const selectedYear = document.getElementById("yearSelector")?.value || getCurrentYear();
          loadEntries(parseInt(selectedYear));
        });
        
        // Set up automatic month checking every hour
        setInterval(() => {
          checkForNewMonth();
        }, 3600000); // Check every hour (3600000 ms)
      });

      // Function to load archived entries
      function loadArchivedEntries() {
        // Show loading state
        Swal.fire({
          title: "Loading Archived Entries",
          text: "Please wait...",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        entriesRef.once("value", (snapshot) => {
          const entries = snapshot.val();
          const archivedYearsContainer = document.getElementById("archivedYearsContainer");
          archivedYearsContainer.innerHTML = "";

          if (entries) {
            // Group entries by year
            const entriesByYear = {};
            Object.entries(entries).forEach(([key, entry]) => {
              if (entry.status === "Archived") {
                const year = new Date(entry.dateReceived).getFullYear();
                if (!entriesByYear[year]) {
                  entriesByYear[year] = [];
                }
                entriesByYear[year].push({ key, ...entry });
              }
            });

            // Sort years in descending order
            const years = Object.keys(entriesByYear).sort((a, b) => b - a);

            // Add year selector
            const yearSelector = document.createElement("div");
            yearSelector.className = "mb-3";
            yearSelector.innerHTML = `
              <div class="d-flex align-items-center mb-3">
                <label for="archiveYearSelect" class="form-label me-2 mb-0">Select Year:</label>
                <select class="form-select w-auto me-2" id="archiveYearSelect">
                  ${years.map(year => `<option value="${year}">${year}</option>`).join('')}
                </select>
                <button class="btn btn-outline-primary btn-sm" id="openSortFilterModal" type="button" data-bs-toggle="modal" data-bs-target="#sortFilterModal" title="Open sort/filter modal">
                  <i class="bi bi-funnel"></i> Sort/Filter
                </button>
              </div>
            `;
            archivedYearsContainer.appendChild(yearSelector);

            // Create accordion for each year
            years.forEach((year) => {
              const yearEntries = entriesByYear[year];
              const yearAccordion = document.createElement("div");
              yearAccordion.className = "col-12 mb-4";
              yearAccordion.id = `year-${year}`;
              yearAccordion.style.display = year === getCurrentYear().toString() ? 'block' : 'none';
              yearAccordion.innerHTML = `
                <div class="card">
                  <div class="card-header">
                    <h5 class="card-title mb-0">${year}</h5>
                  </div>
                  <div class="card-body">
                    <div class="table-responsive">
                      <table class="table table-hover archived-entries-table" id="archivedTable${year}">
                        <thead>
                          <tr>
                            <th>#</th>
                            <th>Control #</th>
                            <th>Type</th>
                            <th>Time Received</th>
                            <th>Date Received</th>
                            <th>From</th>
                            <th>Office</th>
                            <th>Subject</th>
                            <th>Endorsed To</th>
                            <th>Remarks</th>
                            <th>Status</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${yearEntries.map((entry, index) => `
                            <tr>
                              <td>${index + 1}</td>
                              <td>${entry.controlNumber}</td>
                              <td>${entry.type}</td>
                              <td>${entry.timeReceived}</td>
                              <td>${formatDate(entry.dateReceived)}</td>
                              <td>${entry.from}</td>
                              <td>${entry.office}</td>
                              <td>${entry.subject}</td>
                              <td>${entry.endorsedTo}</td>
                              <td>${entry.remarks || ""}</td>
                              <td><span class="badge bg-secondary">Archived</span></td>
                              <td>
                                <button class="btn btn-sm btn-info" onclick="viewArchivedEntry('${entry.key}')" title="View archived entry details">
                                  <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="restoreEntry('${entry.key}')" title="Restore archived entry">
                                  <i class="bi bi-arrow-counterclockwise"></i>
                                </button>
                              </td>
                            </tr>
                          `).join("")}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              `;
              archivedYearsContainer.appendChild(yearAccordion);

              // Initialize DataTable for this year's entries
              $(`#archivedTable${year}`).DataTable({
                dom: "Bfrtip",
                buttons: [
                  { extend: 'copy', className: 'btn btn-sm' },
                  { extend: 'csv', className: 'btn btn-success' },
                  { extend: 'excel', className: 'btn btn-success' },
                  { extend: 'pdf', className: 'btn btn-danger',
                    orientation: 'landscape',
                    pageSize: 'LEGAL',
                    customize: function (doc) {
                      doc.defaultStyle.fontSize = 10;                    //  Make content text bigger
                      doc.styles.tableHeader.fontSize = 11;              //  Make header text bigger
                      doc.styles.tableHeader.alignment = 'left';
                      //  Auto-set column widths evenly
                      const colCount = doc.content[1].table.body[0].length;
                      doc.content[1].table.widths = Array(colCount).fill('*');
                    }
                  },
                  { extend: 'print', className: 'btn btn-primary' }
                ],
                pageLength: 10,
                order: [[0, "desc"]], // Sort by # column (row number) in descending order
                destroy: true,
                language: {
                  search: "Search entries:",
                },
              });
            });

            // Add event listener for year selector
            document.getElementById("archiveYearSelect").addEventListener("change", function() {
              const selectedYear = this.value;
              years.forEach(year => {
                const yearElement = document.getElementById(`year-${year}`);
                if (yearElement) {
                  yearElement.style.display = year === selectedYear ? 'block' : 'none';
                }
              });
            });

            if (years.length === 0) {
              archivedYearsContainer.innerHTML = `
                <div class="col-12 text-center">
                  <p class="text-muted">No archived entries found.</p>
                </div>
              `;
            }
          }

          // Close loading state
          Swal.close();
        }).catch((error) => {
          console.error("Error loading archived entries:", error);
          Swal.close();
          showErrorAlert("Error loading archived entries. Please try again.");
        });
      }

      // Function to view archived entry details
      function viewArchivedEntry(key) {
        entriesRef.child(key).once("value", (snapshot) => {
          const entry = snapshot.val();
          if (entry) {
            // Show entry details in a modal
            const modal = new bootstrap.Modal(
              document.getElementById("viewArchivedModal")
            );
            document
              .getElementById("viewArchivedModal")
              .querySelector(".modal-body").innerHTML = `
              <div class="row mb-3">
                <div class="col-md-6">
                  <strong>Control Number:</strong> ${entry.controlNumber}
                </div>
                <div class="col-md-6">
                  <strong>Type:</strong> ${entry.type}
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <strong>Date Received:</strong> ${formatDate(
                    entry.dateReceived
                  )}
                </div>
                <div class="col-md-6">
                  <strong>Time Received:</strong> ${entry.timeReceived}
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <strong>From:</strong> ${entry.from}
                </div>
                <div class="col-md-6">
                  <strong>Office:</strong> ${entry.office}
                </div>
                 <div class="md-6">
                <strong>Archived On:</strong> ${formatDate(entry.archivedAt)}
              </div>
              </div>
              <div class="mb-3">
                <strong>Subject:</strong> ${entry.subject}
              </div>
              <div class="mb-3">
                <strong>Endorsed To:</strong> ${entry.endorsedTo}
              </div>
              <div class="mb-3">
                <strong>Remarks:</strong> ${entry.remarks || "None"}
              </div>
             
            `;
            modal.show();
          }
        });
      }

      // Function to handle navigation
      function handleNavigation(sectionId) {
        // Hide all sections
        document.querySelectorAll(".main-content > div").forEach((section) => {
          section.classList.add("d-none");
        });

        // Show selected section
        document.getElementById(sectionId).classList.remove("d-none");

        // Update active state in sidebar
        document.querySelectorAll(".nav-link").forEach((link) => {
          link.classList.remove("active");
        });
        document
          .querySelector(`#${sectionId.replace("Section", "Link")}`)
          .classList.add("active");

        // Load section-specific data
        switch (sectionId) {
          case "documentsSection":
            loadDocuments();
            break;
          case "archivesSection":
            loadArchivedEntries();
            break;
          case "historySection":
            loadHistory();
            break;
          case "profileSection":
            loadProfile();
            loadAccounts(); // Only load accounts table in profile section
            break;
          default:
            const selectedYear = document.getElementById("yearSelector")?.value || getCurrentYear();
            loadEntries(parseInt(selectedYear));
        }
      }

      // Add event listeners for navigation
      document
        .getElementById("dashboardLink")
        .addEventListener("click", function (e) {
          e.preventDefault();
          handleNavigation("dashboardSection");
        });

      document
        .getElementById("documentsLink")
        .addEventListener("click", function (e) {
          e.preventDefault();
          handleNavigation("documentsSection");
        });

      document
        .getElementById("archivesLink")
        .addEventListener("click", function (e) {
          e.preventDefault();
          handleNavigation("archivesSection");
        });

      document
        .getElementById("historyLink")
        .addEventListener("click", function (e) {
          e.preventDefault();
          handleNavigation("historySection");
        });

      document
        .getElementById("profileLink")
        .addEventListener("click", function (e) {
          e.preventDefault();
          handleNavigation("profileSection");
        });

      // Function to load documents
      function loadDocuments() {
        const selectedYear = document.getElementById("reportsYearSelector")?.value || new Date().getFullYear();
        
        entriesRef.once("value", (snapshot) => {
          const entries = snapshot.val();
          const currentYear = parseInt(selectedYear);
          const currentMonth = new Date().getMonth();

          // Initialize statistics
          const yearlyStats = {
            total: 0,
            complaints: 0,
            requests: 0,
            proposals: 0,
            invitations: 0,
          };

          const monthlyStats = {
            total: 0,
            dailyAverage: 0,
            highestVolume: { month: "", count: 0 },
            lowestVolume: { month: "", count: Infinity },
          };

          const monthlyData = Array(12).fill(0);

          if (entries) {
            Object.entries(entries).forEach(([_, entry]) => {
              const entryDate = new Date(entry.dateReceived);
              const entryYear = entryDate.getFullYear();
              const entryMonth = entryDate.getMonth();

              // Yearly statistics
              if (entryYear === currentYear) {
                yearlyStats.total++;
                yearlyStats[entry.type.toLowerCase() + "s"]++;

                // Monthly statistics
                if (entryMonth === currentMonth) {
                  monthlyStats.total++;
                }
                monthlyData[entryMonth]++;
              }
            });

            // Calculate monthly statistics
            const nonZeroMonths = monthlyData.filter((count) => count > 0);
            monthlyStats.dailyAverage =
              nonZeroMonths.length > 0
                ? Math.round(
                    nonZeroMonths.reduce((a, b) => a + b, 0) /
                      nonZeroMonths.length
                  )
                : 0;

            monthlyData.forEach((count, month) => {
              if (count > monthlyStats.highestVolume.count) {
                monthlyStats.highestVolume = {
                  month: new Date(2000, month).toLocaleString("default", {
                    month: "long",
                  }),
                  count: count,
                };
              }
              if (count < monthlyStats.lowestVolume.count && count > 0) {
                monthlyStats.lowestVolume = {
                  month: new Date(2000, month).toLocaleString("default", {
                    month: "long",
                  }),
                  count: count,
                };
              }
            });

            // Handle case when no data exists (like for 2026)
            if (monthlyStats.highestVolume.count === 0) {
              monthlyStats.highestVolume = { month: "No Data", count: 0 };
            }
            if (monthlyStats.lowestVolume.count === Infinity) {
              monthlyStats.lowestVolume = { month: "No Data", count: 0 };
            }
          }

          // Update yearly statistics
          document.getElementById("yearlyTotal").textContent =
            yearlyStats.total;
          document.getElementById("yearlyComplaints").textContent =
            yearlyStats.complaints;
          document.getElementById("yearlyRequests").textContent =
            yearlyStats.requests;
          document.getElementById("yearlyProposals").textContent =
            yearlyStats.proposals;
          document.getElementById("yearlyInvitations").textContent =
            yearlyStats.invitations;

          // Update card titles to reflect selected year
          const yearlyCardTitle = document.querySelector('.card-title.text-primary');
          if (yearlyCardTitle && yearlyCardTitle.textContent.includes('Yearly Statistics')) {
            yearlyCardTitle.textContent = `Yearly Statistics (${currentYear})`;
          }

          // Update monthly statistics
          document.getElementById("monthlyTotal").textContent =
            monthlyStats.total;
          document.getElementById("avgDailyLetters").textContent =
            monthlyStats.dailyAverage;
          document.getElementById(
            "highestVolumeMonth"
          ).textContent = `${monthlyStats.highestVolume.month} (${monthlyStats.highestVolume.count})`;
          document.getElementById(
            "lowestVolumeMonth"
          ).textContent = `${monthlyStats.lowestVolume.month} (${monthlyStats.lowestVolume.count})`;

          // Calculate finished and unfinished letter counts
          let yearlyFinished = 0;
          let yearlyUnfinished = 0;
          let monthlyFinished = 0;
          let monthlyUnfinished = 0;

          if (entries) {
            Object.entries(entries).forEach(([_, entry]) => {
              const entryDate = new Date(entry.dateReceived);
              const entryYear = entryDate.getFullYear();
              const entryMonth = entryDate.getMonth();
              
              // Only process entries for the selected year
              if (entryYear === currentYear) {
                // Determine if entry is finished
                const isFinished = entry.status === "Completed" || entry.status === "Inspection";
                
                // Update yearly stats
                if (isFinished) {
                  yearlyFinished++;
                } else {
                  yearlyUnfinished++;
                }
                
                // Update monthly stats (current month only)
                if (entryMonth === currentMonth) {
                  if (isFinished) {
                    monthlyFinished++;
                  } else {
                    monthlyUnfinished++;
                  }
                }
              }
            });
          }

          // Update finished/unfinished counts in tables
          document.getElementById("yearlyFinished").textContent = yearlyFinished;
          document.getElementById("yearlyUnfinished").textContent = yearlyUnfinished;
          document.getElementById("monthlyFinished").textContent = monthlyFinished;
          document.getElementById("monthlyUnfinished").textContent = monthlyUnfinished;

                    // Create monthly letters chart
            const monthlyCtx = document
            .getElementById("monthlyLettersChart")
            .getContext("2d");
          
          // Destroy existing chart if it exists
          const existingMonthlyChart = Chart.getChart(monthlyCtx);
          if (existingMonthlyChart) {
            existingMonthlyChart.destroy();
          }
          
          // Check if we should show empty charts for future years
          const shouldShowEmptyCharts = currentYear > new Date().getFullYear();
          
          if (shouldShowEmptyCharts) {
            // Show empty chart with message
            window.monthlyLettersChart = new Chart(monthlyCtx, {
              type: "bar",
              data: {
                labels: [
                  "January", "February", "March", "April", "May", "June",
                  "July", "August", "September", "October", "November", "December"
                ],
                datasets: [{
                  label: "Letters Received",
                  data: Array(12).fill(0),
                  borderColor: "#e9ecef",
                  backgroundColor: "#f8f9fa",
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                plugins: {
                  legend: {
                    display: false,
                  },
                  title: {
                    display: true,
                    text: `No data available for ${currentYear}`,
                    color: "#6c757d",
                    font: {
                      size: 14
                    }
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: {
                      stepSize: 1,
                    },
                  },
                },
              },
            });
          } else {
            // Show normal chart with data
            window.monthlyLettersChart = new Chart(monthlyCtx, {
              type: "bar",
              data: {
                labels: [
                  "January",
                  "February",
                  "March",
                  "April",
                  "May",
                  "June",
                  "July",
                  "August",
                  "September",
                  "October",
                  "November",
                  "December",
                ],
                datasets: [
                  {
                    label: "Letters Received",
                    data: monthlyData,
                    borderColor: "#002C75",
                    backgroundColor: "#6aa1ff",
                    tension: 0.4,
                    fill: true,
                  },
                ],
              },
              options: {
                responsive: true,
                plugins: {
                  legend: {
                    display: false,
                  },
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: {
                      stepSize: 1,
                    },
                  },
                },
              },
            });
          }


          // Create letter type distribution chart (pie chart)
          const letterTypeCtx = document.getElementById("letterTypeChart").getContext("2d");
          
          // Destroy existing chart if it exists
          const existingLetterTypeChart = Chart.getChart(letterTypeCtx);
          if (existingLetterTypeChart) {
            existingLetterTypeChart.destroy();
          }
          
          if (shouldShowEmptyCharts) {
            // Show empty pie chart with message
            window.letterTypeChart = new Chart(letterTypeCtx, {
              type: "pie",
              data: {
                labels: ["No Data"],
                datasets: [{
                  data: [1],
                  backgroundColor: ["#f8f9fa"],
                  borderColor: ["#e9ecef"],
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 2,
                plugins: {
                  legend: {
                    display: false
                  },
                  title: {
                    display: true,
                    text: `No data available for ${currentYear}`,
                    color: "#6c757d",
                    font: {
                      size: 14
                    }
                  }
                },
                layout: {
                  padding: {
                    left: 20,
                    right: 20,
                    top: 20,
                    bottom: 20
                  }
                }
              }
            });
          } else {
            // Show normal pie chart with data
            window.letterTypeChart = new Chart(letterTypeCtx, {
              type: "pie",
              data: {
                labels: ["Complaints", "Requests", "Proposals", "Invitations"],
                datasets: [{
                  data: [
                    yearlyStats.complaints,
                    yearlyStats.requests,
                    yearlyStats.proposals,
                    yearlyStats.invitations
                  ],
                  backgroundColor: [
                    "rgba(255, 99, 132, 0.7)",    // Red for Complaints
                    "rgba(75, 192, 192, 0.7)",    // Green for Requests
                    "rgba(255, 206, 86, 0.7)",    // Yellow for Proposals
                    "rgba(54, 162, 235, 0.7)",    // Blue for Invitations
                  ],
                  borderColor: [
                    "rgba(255, 99, 132, 1)",      // Red border
                    "rgba(75, 192, 192, 1)",      // Green border
                    "rgba(255, 206, 86, 1)",      // Yellow border
                    "rgba(54, 162, 235, 1)",      // Blue border
                  ],
                  borderWidth: 2,                 // Increased border width
                  borderAlign: 'inner',           // Inner border alignment
                  hoverBorderWidth: 3,            // Larger border on hover
                  hoverBorderColor: [             // Darker border colors on hover
                    "rgba(205, 49, 82, 1)",
                    "rgba(25, 142, 142, 1)",
                    "rgba(205, 156, 36, 1)",
                    "rgba(4, 112, 185, 1)",
                  ],
                  hoverOffset: 10                 // Segments spread out on hover
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 2,
                plugins: {
                  legend: {
                    position: "right",
                    labels: {
                      generateLabels: function(chart) {
                        const data = chart.data;
                        if (data.labels.length && data.datasets.length) {
                          return data.labels.map((label, i) => {
                            const value = data.datasets[0].data[i];
                            const total = data.datasets[0].data.reduce((acc, val) => acc + val, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return {
                              text: `${label}: ${value} (${percentage}%)`,
                              fillStyle: data.datasets[0].backgroundColor[i],
                              strokeStyle: data.datasets[0].borderColor[i],
                              lineWidth: 2,
                              index: i
                            };
                          });
                        }
                        return [];
                      },
                      font: {
                        size: 12,
                        weight: 'bold'
                      },
                      padding: 20,
                      usePointStyle: true,
                      pointStyle: 'circle'
                    }
                  },
                  title: {
                    display: true,
                    text: `Total Letters by Type (${currentYear})`,
                    color: "#333",
                    font: {
                      size: 16,
                      weight: 'bold'
                    },
                    padding: {
                      top: 10,
                      bottom: 30
                    }
                  }
                },
                layout: {
                  padding: {
                    left: 20,
                    right: 20,
                    top: 20,
                    bottom: 20
                  }
                },
                elements: {
                  arc: {
                    borderWidth: 2,
                    borderRadius: 5
                  }
                }
              }
            });
          }
        });
      }

      // Function to load users
      function loadUsers() {
        // Check if DataTable is already initialized
        if ($.fn.DataTable.isDataTable("#usersTable")) {
          $("#usersTable").DataTable().destroy();
        }

        // Show loading state
        Swal.fire({
          title: "Loading Users",
          text: "Please wait...",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        database
          .ref("users")
          .once("value", (snapshot) => {
            const users = snapshot.val();
            const tbody = document.querySelector("#usersTable tbody");
            tbody.innerHTML = "";

            if (users) {
              Object.entries(users).forEach(([key, user]) => {
                if (key !== "admin") {
                  // Skip the admin user
                  const row = document.createElement("tr");
                  row.innerHTML = `
                  <td>${user.firstName} ${user.lastName}</td>
                  <td>${user.email}</td>
                  <td>${user.role}</td>
                  <td><span class="badge bg-warning">Active</span></td>
                  <td>
                    <button class="btn btn-sm btn-primary" onclick="editUser('${key}')" title="Edit user">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteUser('${key}')" title="Delete user">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                `;
                  tbody.appendChild(row);
                }
              });
            }

            // Initialize DataTable
            $("#usersTable").DataTable({
              dom: "Bfrtip",
              buttons: [
                { extend: 'copy', className: 'btn btn-sm' },
                { extend: 'csv', className: 'btn btn-success' },
                { extend: 'excel', className: 'btn btn-success' },
                { extend: 'pdf', className: 'btn btn-danger',
                    orientation: 'landscape',
                    pageSize: 'LEGAL',
                    customize: function (doc) {
                      doc.defaultStyle.fontSize = 10;                  
                      doc.styles.tableHeader.fontSize = 11;      
                      const colCount = doc.content[1].table.body[0].length;
                      doc.content[1].table.widths = Array(colCount).fill('*');
                    }
                  },
                { extend: 'print', className: 'btn btn-primary' }
              ],
              pageLength: 10,
              order: [[0, "asc"]],
              destroy: true,
              language: {
                search: "Search users:",
              },
            });

            // Close loading state
            Swal.close();
          })
          .catch((error) => {
            console.error("Error loading users:", error);
            Swal.close();
            showErrorAlert("Error loading users. Please try again.");
          });
      }

      // Function to load history
      function loadHistory() {
        // Check if DataTable is already initialized
        if ($.fn.DataTable.isDataTable("#historyTable")) {
          $("#historyTable").DataTable().destroy();
        }

        // Show loading state
        Swal.fire({
          title: "Loading History",
          text: "Please wait...",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        // Get current user info
        const currentUser = getSectionUser();
        let userOffice = null;

        // Extract office from user role if it's an endorsement role
        if (currentUser.role && currentUser.role.startsWith("Endorsement -")) {
          userOffice = currentUser.role.replace("Endorsement - ", "");
        }

        // First, get all entries to check which ones are endorsed to the user's office
        const entriesPromise = userOffice ? database.ref("entries").once("value") : Promise.resolve(null);
        
        entriesPromise.then((entriesSnapshot) => {
          const relevantControlNumbers = new Set();
          
          if (entriesSnapshot && userOffice) {
            const entries = entriesSnapshot.val();
            if (entries) {
              Object.entries(entries).forEach(([key, entry]) => {
                if (entry.endorsedTo === userOffice) {
                  relevantControlNumbers.add(entry.controlNumber);
                }
              });
            }
          }

          database
            .ref("logs")
            .on("value", (snapshot) => {
              try {
                const logs = snapshot.val();
                const tbody = document.querySelector("#historyTable tbody");
                
                if (!tbody) {
                  console.error("History table tbody not found");
                  Swal.close();
                  return;
                }
                
                tbody.innerHTML = "";

                if (logs) {
                  Object.entries(logs).forEach(([key, log]) => {
                    try {
                      // Filter logs based on user's office
                      if (userOffice) {
                        // For endorsement users, only show logs related to their office
                        const logDetails = log.details || "";
                        const logAction = log.action || "";
                        const logControlNumber = log.controlNumber || "";
                        
                        // Check if the log is related to the user's office
                        const isRelevantLog = logDetails.includes(userOffice) || 
                                            logAction.includes(userOffice) ||
                                            logControlNumber.includes(userOffice) ||
                                            relevantControlNumbers.has(logControlNumber);
                        
                        // Also check if it's a general system log that should be visible to all
                        const isGeneralLog = logAction === "login" || 
                                           logAction === "logout" || 
                                           logAction === "profile_update" ||
                                           logAction === "password_change";
                        
                        if (!isRelevantLog && !isGeneralLog) {
                          return; // Skip this log entry
                        }
                      }

                      // Format timestamp
                      const date = new Date(log.timestamp);
                      const timestampValue = date.getTime();
                      const formattedTimestamp = date.toLocaleString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true
                      });

                      const row = document.createElement("tr");
                      row.innerHTML = `
                      <td data-order="${timestampValue}">${formattedTimestamp}</td>
                      <td>${log.user || "Unknown User"}</td>
                      <td>${log.action || "Unknown Action"}</td>
                      <td>${log.details || "No details"}</td>
                      <td>${log.controlNumber || "-"}</td>
                    `;
                      tbody.appendChild(row);
                    } catch (error) {
                      console.error("Error processing log entry:", error, log);
                    }
                  });
                }

                // Initialize DataTable
                $("#historyTable").DataTable({
                  dom: "Bfrtip",
                  buttons: [
                    { extend: 'copy', className: 'btn btn-sm' },
                    { extend: 'csv', className: 'btn btn-success' },
                    { extend: 'excel', className: 'btn btn-success' },
                    { extend: 'pdf', className: 'btn btn-danger',
                        orientation: 'landscape',
                        pageSize: 'LEGAL',
                        customize: function (doc) {
                          doc.defaultStyle.fontSize = 10;              
                          doc.styles.tableHeader.fontSize = 11;        
                          doc.styles.tableHeader.alignment = 'left'
                          const colCount = doc.content[1].table.body[0].length;
                          doc.content[1].table.widths = Array(colCount).fill('*');
                        }
                      },
                    { extend: 'print', className: 'btn btn-primary' }
                ],
                  pageLength: 10,
                  order: [[0, "desc"]], // Sort by Timestamp column (index 0) in descending order - latest first
                  destroy: true,
                  language: {
                    search: "Search history:",
                  },
                  columnDefs: [
                    { width: "20%", targets: 0 }, // Timestamp
                    { width: "15%", targets: 1 }, // User
                    { width: "10%", targets: 2 }, // Action
                    { width: "40%", targets: 3 }, // Details
                    { width: "15%", targets: 4 }  // Control Number
                  ],
                });

                // Close loading state
                Swal.close();
              } catch (error) {
                console.error("Error processing history data:", error);
                Swal.close();
                showErrorAlert("Error loading history. Please try again.");
              }
            }, (error) => {
              // Error callback for .on() method
              console.error("Error loading history:", error);
              Swal.close();
              showErrorAlert("Error loading history. Please try again.");
            });
        }).catch((error) => {
          console.error("Error loading entries for filtering:", error);
          Swal.close();
          showErrorAlert("Error loading history. Please try again.");
        });
      }

      // Function to view audit log details
      function viewAuditLog(key, log) {
        const modal = new bootstrap.Modal(
          document.getElementById("viewAuditLogModal")
        );

        // Format timestamp
        const timestamp = new Date(log.timestamp);
        const formattedTimestamp = timestamp.toLocaleString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });

        // Update modal content
        document.getElementById("auditTimestamp").textContent =
          formattedTimestamp;
        document.getElementById("auditUser").textContent = log.user;
        document.getElementById("auditAction").textContent = log.action;
        document.getElementById("auditControlNumber").textContent =
          log.controlNumber || "-";
        document.getElementById("auditDetails").textContent = log.details;

        // Show modal
        modal.show();
      }

      // Function to load profile
      function loadProfile() {
        const sectionUser = getSectionUser();
        if (!sectionUser) return;

        // Show loading state
        Swal.fire({
          title: "Loading Profile",
          text: "Please wait...",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        // Use section-specific user data
        const userData = {
          firstName: sectionUser.name.split(' ')[0] || '',
          lastName: sectionUser.name.split(' ').slice(1).join(' ') || '',
          email: sectionUser.email,
          role: sectionUser.role,
          phone: '',
          department: '',
          position: ''
        };

        // Safely update UI elements
        const updateElement = (id, value) => {
          const element = document.getElementById(id);
          if (element) {
            element.textContent = value;
          }
        };

        const updateInputValue = (id, value) => {
          const element = document.getElementById(id);
          if (element) {
            element.value = value || '';
          }
        };

        // Update profile information if elements exist
        updateElement("profileName", `${userData.firstName || ''} ${userData.lastName || ''}`);
        updateElement("profileRole", userData.role || '');
        updateElement("currentUserName", `${userData.firstName || ''} ${userData.lastName || ''}`);
        updateElement("currentUserRole", userData.role || '');
        updateInputValue("email", userData.email);
        
        // Update form fields if they exist
        updateInputValue("firstName", userData.firstName);
        updateInputValue("lastName", userData.lastName);
        updateInputValue("phone", userData.phone);
        updateInputValue("department", userData.department);
        updateInputValue("position", userData.position);
        
        // Set role and disable it if it exists
        const roleSelect = document.getElementById("role");
        if (roleSelect) {
          roleSelect.value = userData.role || '';
          roleSelect.disabled = !!userData.role;
        }

        // Update profile image if available
        const profileImage = document.getElementById("profileImage");
        if (profileImage) {
          profileImage.src = 'assets/images/logo.png'; // Default logo as profile image
        }

        Swal.close();
      }

      // Initialize the dashboard on page load
      document.addEventListener("DOMContentLoaded", function () {
        handleNavigation("dashboardSection");
      });

      // Add event listener for the Archive All button
      document.addEventListener("DOMContentLoaded", function () {
        const archiveAllBtn = document.getElementById("archiveAllBtn");
        if (archiveAllBtn) {
          archiveAllBtn.addEventListener("click", archiveAllEntries);
        }
      });

      document.addEventListener("DOMContentLoaded", function() {
        // Add event listener for archiving completed documents
        document.getElementById("archiveAllBtncplt").addEventListener("click", function() {
          showConfirmDialog(
            "Archive Completed Documents",
            "Are you sure you want to archive all completed documents?",
            "Yes, archive completed"
          ).then((result) => {
            if (result.isConfirmed) {
              // Show loading state
              Swal.fire({
                title: "Archiving Completed Documents",
                text: "Please wait...",
                allowOutsideClick: false,
                didOpen: () => {
                  Swal.showLoading();
                },
              });

              entriesRef.once("value", (snapshot) => {
                const entries = snapshot.val();
                let archivedCount = 0;
                let totalToArchive = 0;

                if (entries) {
                  // First count completed documents
                  Object.entries(entries).forEach(([_, entry]) => {
                    if (
                      entry.status === "Completed" || 
                      entry.status === "Inspection" ||
                      entry.status === "Request Granted" ||
                      entry.status === "Mayor Decision" ||
                      entry.status === "Decision Made"
                    ) {
                      totalToArchive++;
                    }
                  });

                  if (totalToArchive === 0) {
                    Swal.fire({
                      title: "No Documents to Archive",
                      text: "There are no completed documents to archive.",
                      icon: "info",
                      confirmButtonColor: "#002C75",
                    });
                    return;
                  }

                  // Update progress bar
                  Swal.update({
                    html: `Archiving ${totalToArchive} completed documents...<br><br>
                          <div class="progress" style="height: 20px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: 0%" 
                                 id="archiveProgress">
                              0%
                            </div>
                          </div>`,
                  });

                  // Archive completed documents
                  Object.entries(entries).forEach(([key, entry]) => {
                    if (
                      entry.status === "Completed" || 
                      entry.status === "Inspection" ||
                      entry.status === "Request Granted" ||
                      entry.status === "Mayor Decision" ||
                      entry.status === "Decision Made"
                    ) {
                      entriesRef.child(key).update({
                        status: "Archived",
                        archivedAt: firebase.database.ServerValue.TIMESTAMP,
                      })
                      .then(() => {
                        archivedCount++;
                        logActivity(
                          "archive",
                          `Archived completed document: ${entry.subject}`,
                          entry.controlNumber
                        );

                        // Update progress bar
                        const progress = Math.round((archivedCount / totalToArchive) * 100);
                        document.getElementById("archiveProgress").style.width = `${progress}%`;
                        document.getElementById("archiveProgress").textContent = `${progress}%`;

                        if (archivedCount === totalToArchive) {
                          Swal.fire({
                            title: "Success!",
                            text: `Successfully archived ${archivedCount} completed documents!`,
                            icon: "success",
                            confirmButtonColor: "#002C75",
                          }).then(() => {
                            const selectedYear = document.getElementById("yearSelector")?.value || getCurrentYear();
                            loadEntries(parseInt(selectedYear));
                          });
                        }
                      })
                      .catch((error) => {
                        console.error("Error archiving document:", error);
                        Swal.fire({
                          title: "Error!",
                          text: "Error archiving documents. Please try again.",
                          icon: "error",
                          confirmButtonColor: "#dc3545",
                        });
                      });
                    }
                  });
                }
              });
            }
          });
        });
      });

      // Function to handle sign out
      function signOut() {
        showConfirmDialog(
          "Sign Out",
          "Are you sure you want to sign out?",
          "Yes, sign out"
        ).then((result) => {
          if (result.isConfirmed) {
            // Clear session data for this specific section
            sessionStorage.removeItem('admin_section_auth');
            localStorage.removeItem('admin_section_auth');
            
                    // Clear stored user email
        sessionStorage.removeItem('adminLoggedInUserEmail');
        localStorage.removeItem('adminLoggedInUserEmail');
            
            // Store sign out timestamp to prevent immediate redirect
            sessionStorage.setItem('admin_signout_time', Date.now().toString());

            // Redirect to selection page
            window.location.href = "../pages/selection.html";
          }
        });
      }

      // Check authentication state
      firebase.auth().onAuthStateChanged((user) => {
        // Check if user was signed out from this specific section
        const signoutTime = sessionStorage.getItem('admin_signout_time');
        const currentTime = Date.now();
        
        // If signout was within the last 5 seconds, don't redirect back
        if (signoutTime && (currentTime - parseInt(signoutTime)) < 5000) {
          return;
        }
        
        if (!user) {
          // If no user is signed in, redirect to selection page
          window.location.href = "../pages/selection.html";
          return;
        }
        
        // Clean up old signout timestamp
        if (signoutTime && (currentTime - parseInt(signoutTime)) >= 5000) {
          sessionStorage.removeItem('admin_signout_time');
        }
        
        if (!user) {
          // If no user is signed in, redirect to selection page
          window.location.href = "../pages/selection.html";
        } else if (user) {
          // Check if user has access to admin section
          const adminAuth = sessionStorage.getItem('admin_section_auth') || localStorage.getItem('admin_section_auth');
          if (!adminAuth) {
            // User doesn't have access to this section, redirect to selection
            window.location.href = "../pages/selection.html";
            return;
          }
          // Safely update UI elements
          const updateElement = (id, value) => {
            const element = document.getElementById(id);
            if (element) {
              element.textContent = value;
            }
          };

                  // Get user email from session storage (set during login) or fallback to Firebase user
        const loggedInEmail = sessionStorage.getItem('adminLoggedInUserEmail') || localStorage.getItem('adminLoggedInUserEmail') || user.email || "";
          
          // Set the current user's email immediately from storage
          updateElement("email", loggedInEmail);
          updateElement("currentUserEmailadmin", loggedInEmail);
          
          // Fetch user details from database
          database.ref('users/' + user.uid).once('value').then((snapshot) => {
            const userData = snapshot.val();
            if (userData) {
              // Check if profile is complete
              const isProfileComplete = userData.firstName && userData.lastName && userData.role;
              
              if (!isProfileComplete) {
                // Auto-close the profile completion modal immediately
                setTimeout(() => {
                  // Close any open SweetAlert modals
                  if (Swal.isVisible()) {
                    Swal.close();
                  }
                }, 1);
                
                // Skip showing the modal entirely
                return;
                
                // Show profile completion modal (commented out to prevent display)
                // showProfileCompletionModal(user);
              } else {
                // Update UI with user info
                updateElement("currentUserName", `${userData.firstName} ${userData.lastName}`);
                updateElement("currentUserRole", userData.role);
                
                // Update user avatar if available
                const userAvatar = document.getElementById("userAvatar");
                if (userAvatar && user.photoURL) {
                  userAvatar.src = user.photoURL;
                }
              }
            }
          }).catch((error) => {
            console.error("Error fetching user data:", error);
            // Fallback to basic user info
            updateElement("currentUserName", user.displayName || user.email);
            updateElement("currentUserRole", "User");
          });
        }
      });

      // Function to show profile completion modal (commented out to prevent display)
      /*
      function showProfileCompletionModal(user) {
        Swal.fire({
          title: 'Complete Your Profile',
          html: `
            <form id="initialProfileForm">
              <div class="mb-3">
                <label for="initialFirstName" class="form-label">First Name</label>
                <input type="text" class="form-control" id="initialFirstName" required>
              </div>
              <div class="mb-3">
                <label for="initialLastName" class="form-label">Last Name</label>
                <input type="text" class="form-control" id="initialLastName" required>
              </div>
              <div class="mb-3">
                <label for="initialRole" class="form-label">Role</label>
                <select class="form-select" id="initialRole" required>
                  <option value="">Select Role</option>
                  <option value="Administrator">Administrator</option>
                  <option value="Staff">Staff</option>
                </select>
              </div>
            </form>
          `,
          showCancelButton: false,
          confirmButtonText: 'Save Profile',
          confirmButtonColor: '#2e7d32',
          allowOutsideClick: false,
          preConfirm: () => {
            const firstName = document.getElementById('initialFirstName').value;
            const lastName = document.getElementById('initialLastName').value;
            const role = document.getElementById('initialRole').value;
            
            if (!firstName || !lastName || !role) {
              Swal.showValidationMessage('Please fill in all fields');
              return false;
            }
            
            return { firstName, lastName, role };
          }
        }).then((result) => {
          if (result.isConfirmed) {
            handleProfileCompletion(user, result.value);
          }
        });
      }
      */

      // Function to handle profile completion
      function handleProfileCompletion(user, profileData) {
        const updates = {
          firstName: profileData.firstName,
          lastName: profileData.lastName,
          role: profileData.role,
          updatedAt: firebase.database.ServerValue.TIMESTAMP
        };
        
        database.ref('users/' + user.uid).update(updates)
          .then(() => {
            // Update user's display name in Firebase Auth
            return user.updateProfile({
              displayName: `${profileData.firstName} ${profileData.lastName}`
            });
          })
          .then(() => {
            // Safely update UI elements
            const updateElement = (id, value) => {
              const element = document.getElementById(id);
              if (element) {
                element.textContent = value;
              }
            };

            updateElement("currentUserName", `${profileData.firstName} ${profileData.lastName}`);
            updateElement("currentUserRole", profileData.role);
            
            // Show success message
            Swal.fire({
              title: 'Success!',
              text: 'Profile completed successfully!',
              icon: 'success',
              confirmButtonColor: '#002C75'
            });
          })
          .catch((error) => {
            console.error("Error updating profile:", error);
            showErrorAlert("Error updating profile. Please try again.");
          });
      }

      // Function to create new user
      document.getElementById("saveUser").addEventListener("click", function () {
        const firstName = document.getElementById("newFirstName").value;
        const lastName = document.getElementById("newLastName").value;
        const email = document.getElementById("newEmail").value;
        const password = document.getElementById("newPassword").value;
        const confirmPassword = document.getElementById("confirmNewPassword").value;
        const role = document.getElementById("newRole").value;

        // Validate password match
        if (password !== confirmPassword) {
          Swal.fire({
            title: "Error!",
            text: "Passwords do not match!",
            icon: "error",
            confirmButtonColor: "#dc3545",
          });
          return;
        }

        // Validate password length
        if (password.length < 6) {
          Swal.fire({
            title: "Error!",
            text: "Password should be at least 6 characters long!",
            icon: "error",
            confirmButtonColor: "#dc3545",
          });
          return;
        }

        // Show loading state
        Swal.fire({
          title: "Creating user...",
          text: "Please wait while we create the user account",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        // Create user with Firebase Auth
        auth
          .createUserWithEmailAndPassword(email, password)
          .then((userCredential) => {
            const user = userCredential.user;

            // Store additional user data in Realtime Database
            const userData = {
              firstName: firstName,
              lastName: lastName,
              email: email,
              role: role,
              status: "active",
              createdAt: firebase.database.ServerValue.TIMESTAMP
            };

            // Save user data to database
            return database.ref('users/' + user.uid).set(userData)
              .then(() => {
                // Also update the user's display name in Firebase Auth
                return user.updateProfile({
                  displayName: `${firstName} ${lastName}`
                });
              });
          })
          .then(() => {
            // Show success message
            Swal.fire({
              title: "Success!",
              text: "User created successfully!",
              icon: "success",
              confirmButtonColor: "#002C75",
            }).then(() => {
              // Close modal
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("createUserModal")
              );
              modal.hide();

              // Reset form
              document.getElementById("createUserForm").reset();

              // Reload users table
              loadUsers();
            });
          })
          .catch((error) => {
            let errorMessage = "An error occurred while creating the user.";

            switch (error.code) {
              case "auth/email-already-in-use":
                errorMessage = "Email is already in use.";
                break;
              case "auth/invalid-email":
                errorMessage = "Invalid email format.";
                break;
              case "auth/weak-password":
                errorMessage = "Password should be at least 6 characters.";
                break;
              case "auth/operation-not-allowed":
                errorMessage = "User creation is currently disabled.";
                break;
            }

            // Show error message
            Swal.fire({
              title: "Error!",
              text: errorMessage,
              icon: "error",
              confirmButtonColor: "#dc3545",
            });
          });
      });

       // Function to update status options based on type
       function updateStatusOptions(type) {
        const statusSelect = document.getElementById("status");
        const editStatusSelect = document.getElementById("editStatus");
        
        // Clear existing options
        statusSelect.innerHTML = '';
        editStatusSelect.innerHTML = '';
        
        switch(type) {
          case "Complaint":
            // Complaint statuses
            const complaintStatuses = [
              { value: "Under Investigation", text: "Under Investigation (Ongoing)" },
              { value: "Inspection", text: "Inspection, Acted Upon (Done)" }
            ];
            addStatusOptions(complaintStatuses);
            break;
            
          case "Request":
            // Request statuses
            const requestStatuses = [
              { value: "For Review", text: "For Review and Approval (Ongoing)" },
              { value: "Request Granted", text: "Request Granted (Done)" }
            ];
            addStatusOptions(requestStatuses);
            break;
            
          case "Invitation":
            // Invitation statuses
            const invitationStatuses = [
              { value: "Calendar Pending", text: "To be placed in the calendar (Ongoing)" },
              { value: "Mayor Decision", text: "The mayor will accept/decline (Done)" }
            ];
            addStatusOptions(invitationStatuses);
            break;
            
          case "Proposal":
            // Proposal statuses
            const proposalStatuses = [
              { value: "Review Study", text: "For review and study (Ongoing)" },
              { value: "Decision Made", text: "Approve, please present your proposal/ disapprove, the city has already a working product/system (Done)" }
            ];
            addStatusOptions(proposalStatuses);
            break;
            
          default:
            // Regular status options for other types
            const regularStatuses = [
              { value: "Pending", text: "Pending" },
              { value: "Processing", text: "Processing" },
              { value: "Completed", text: "Completed" },
              { value: "Archived", text: "Archived" }
            ];
            addStatusOptions(regularStatuses);
        }
      }

      // Helper function to add status options to both select elements
      function addStatusOptions(statuses) {
        const statusSelect = document.getElementById("status");
        const editStatusSelect = document.getElementById("editStatus");
        
        statuses.forEach(status => {
          const option = new Option(status.text, status.value);
          const editOption = new Option(status.text, status.value);
          statusSelect.add(option);
          editStatusSelect.add(editOption);
        });
      }

      // Add event listeners for type changes
      document.getElementById("letterType").addEventListener("change", function() {
        updateStatusOptions(this.value);
      });

      document.getElementById("editType").addEventListener("change", function() {
        updateStatusOptions(this.value);
      });

      // Initialize status options based on initial type
      document.addEventListener("DOMContentLoaded", function() {
        const initialType = document.getElementById("letterType").value;
        updateStatusOptions(initialType);
      });
      
      // Update the DataTables initialization
      $("#monthly-stats-table").DataTable({
        dom: "Bfrtip",
        buttons: [
          { 
            extend: 'copy', 
            className: 'btn btn-sm',
            title: 'Administrative Division Dashboard'
          },
          { 
            extend: 'csv', 
            className: 'btn btn-success',
            title: 'Administrative Division Dashboard'
          },
          { 
            extend: 'excel', 
            className: 'btn btn-success',
            title: 'Administrative Division Dashboard'
          },
          { 
            extend: 'pdf', 
            className: 'btn btn-danger',
            orientation: 'landscape',
            pageSize: 'LEGAL',
            title: 'Administrative Division Dashboard',
            customize: function (doc) {
              doc.defaultStyle.fontSize = 10;
              doc.styles.tableHeader.fontSize = 11;
              doc.styles.tableHeader.alignment = 'left';
              const colCount = doc.content[1].table.body[0].length;
              doc.content[1].table.widths = Array(colCount).fill('*');
            }
          },
          { 
            extend: 'print', 
            className: 'btn btn-primary',
            title: 'Administrative Division Dashboard'
          }
        ],
        pageLength: 10,
        order: [[1, "desc"]], // Sort by Control Number column (index 1) in descending order
        destroy: true,
        language: {
          search: "Search entries:",
        },
        columnDefs: [
          { width: "5%", targets: 0 }, // #
          { width: "12%", targets: 1 }, // Control Number (increased width)
          { width: "8%", targets: 2 }, // Letter Type
          { width: "7%", targets: 3 }, // Time Received
          { width: "7%", targets: 4 }, // Date Received
          { width: "7%", targets: 5 }, // From
          { width: "7%", targets: 6 }, // Office
          { width: "10%", targets: 7 }, // Subject
          { width: "7%", targets: 8 }, // Time Received (Admin)
          { width: "7%", targets: 9 }, // Date Received (Admin)
          { width: "7%", targets: 10 }, // Endorsed To
          { width: "7%", targets: 11 }, // Remarks
          { width: "7%", targets: 12 }, // File Code
          { width: "5%", targets: 13 }, // Status
          { width: "5%", targets: 14 }  // Actions
        ],
        scrollX: true,
        scrollCollapse: true,
        fixedColumns: {
          left: 1,
          right: 1
        }
      });

      // Add this function near the top of the script section
      function getCurrentYear() {
        return new Date().getFullYear();
      }

      // Function to handle search in accordion tables
      function initializeSearch(selectedYear = null) {
        const currentYear = getCurrentYear();
        const yearToUse = selectedYear || currentYear;
        const now = new Date();
        const months = [
          "January", "February", "March", "April", "May", "June",
          "July", "August", "September", "October", "November", "December"
        ];
        
        // Determine which months to show based on the year
        let monthsToShow = [];
        if (yearToUse < currentYear) {
          // For past years, show all months in descending order
          for (let i = 11; i >= 0; i--) {
            monthsToShow.push(months[i]);
          }
        } else if (yearToUse === currentYear) {
          // For current year, show months up to current month in descending order
          const currentMonthIndex = now.getMonth();
          for (let i = currentMonthIndex; i >= 0; i--) {
            monthsToShow.push(months[i]);
          }
        } else {
          // For future years (2026+), show only months that have already arrived
          const currentMonthIndex = now.getMonth();
          const currentYearMonth = now.getFullYear();
          
          if (yearToUse === currentYearMonth) {
            // If it's the current year, show months up to current month
            for (let i = currentMonthIndex; i >= 0; i--) {
              monthsToShow.push(months[i]);
            }
          } else {
            // For future years, don't show any months yet
            monthsToShow = [];
          }
        }

        monthsToShow.forEach(month => {
          const monthKey = `${month.toLowerCase()}${yearToUse}`;
          const searchInput = document.getElementById(`search${monthKey}`);
          const tableId = `monthly-stats-table-${monthKey}`;
          
          if (searchInput) {
            // Create title for this month
            const title = `${month} ${yearToUse} - Administrative Division Dashboard`;
            
            // Initialize DataTable for this month
            $(`#${tableId}`).DataTable({
              dom: "Bfrtip",
              buttons: [
                { 
                  extend: 'copy', 
                  className: 'btn btn-sm',
                  title: title
                },
                { 
                  extend: 'csv', 
                  className: 'btn btn-success',
                  title: title
                },
                { 
                  extend: 'excel', 
                  className: 'btn btn-success',
                  title: title
                },
                { 
                  extend: 'pdf', 
                  className: 'btn btn-danger',
                  orientation: 'landscape',
                  pageSize: 'LEGAL',
                  title: title,
                  customize: function (doc) {
                    doc.defaultStyle.fontSize = 10;
                    doc.styles.tableHeader.fontSize = 11;
                    doc.styles.tableHeader.alignment = 'left';
                    const colCount = doc.content[1].table.body[0].length;
                    doc.content[1].table.widths = Array(colCount).fill('*');
                  }
                },
                { 
                  extend: 'print', 
                  className: 'btn btn-primary',
                  title: title
                }
              ],
              pageLength: 10,
              order: [[0, "desc"]], // Sort by # column (row number) in descending order
              destroy: true,
              language: {
                search: "Search entries:",
              },
              columnDefs: [
                { width: "5%", targets: 0 }, // #
                { width: "12%", targets: 1 }, // Control Number
                { width: "8%", targets: 2 }, // Letter Type
                { width: "7%", targets: 3 }, // Time Received
                { width: "7%", targets: 4 }, // Date Received
                { width: "7%", targets: 5 }, // From
                { width: "7%", targets: 6 }, // Office
                { width: "10%", targets: 7 }, // Subject
                { width: "7%", targets: 8 }, // Time Received (Admin)
                { width: "7%", targets: 9 }, // Date Received (Admin)
                { width: "7%", targets: 10 }, // Endorsed To
                { width: "7%", targets: 11 }, // Remarks
                { width: "7%", targets: 12 }, // File Code
                { width: "5%", targets: 13 }, // Status
                { width: "5%", targets: 14 }  // Actions
              ],
              scrollX: true,
              scrollCollapse: true,
              fixedColumns: {
                left: 1,
                right: 1
              }
            });

            // Add search functionality
            searchInput.addEventListener('keyup', function() {
              const table = $(`#${tableId}`).DataTable();
              table.search(this.value).draw();
            });
          }
        });
      }

      // Function to initialize DataTable for a specific month
      function initializeDataTable(monthKey, tableId, data) {
        // Destroy existing DataTable if it exists
        if ($.fn.DataTable.isDataTable(`#${tableId}`)) {
          $(`#${tableId}`).DataTable().destroy();
        }

        // Extract month name and year from monthKey (e.g., "may2024" -> "May" and "2024")
        const monthName = monthKey.replace(/\d+/g, '').charAt(0).toUpperCase() + monthKey.replace(/\d+/g, '').slice(1);
        const year = monthKey.replace(/\D/g, '');
        const title = `${monthName} ${year} - Administrative Division Dashboard`;

        // Initialize new DataTable with basic configuration
        const table = $(`#${tableId}`).DataTable({
          data: data,
          columns: [
              { data: null, render: (data, type, row, meta) => meta.row + 1 },
              { data: 'controlNumber' },
              { data: 'type' },
              { data: 'fileUrl', render: function(data) { return data ? `<a href="${data}" target="_blank">View File</a>` : '' } },
              { data: 'timeReceived' },
              { data: 'dateReceived' },
              { data: 'from' },
              { data: 'office' },
              { data: 'subject' },
              { data: 'adminTimeReceived', defaultContent: '' },
              { data: 'adminDateReceived', defaultContent: '' },
              { data: 'endorsedTo', defaultContent: '' },
              { data: 'remarks', defaultContent: '' },
              { data: 'fileCode', defaultContent: '' },
              {
              data: 'status',
              render: function(data, type, row) {
                return `<span class="badge bg-${getStatusColor(data)}">${data || 'Pending'}</span>`;
              }
            },
            {
              data: null,
              render: function(data, type, row) {
                return `
                  <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#editEntryModal" onclick="editEntry('${row.key}')" title="Edit entry">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-warning" onclick="deleteEntry('${row.key}')" title="Archive entry">
                    <i class="bi bi-archive"></i>
                  </button>
                `;
              }
            }
          ],
          pageLength: 10,
          order: [[0, "desc"]], // Sort by # column (row number) in descending order
          scrollX: true,
          scrollCollapse: true,
          fixedColumns: {
            left: 1,
            right: 1
          },
          dom: "Bfrtip", // Buttons, filter, processing, table, pagination
          buttons: [
            { 
              extend: 'copy', 
              className: 'btn btn-sm',
              title: title
            },
            { 
              extend: 'csv', 
              className: 'btn btn-success',
              title: title
            },
            { 
              extend: 'excel', 
              className: 'btn btn-success',
              title: title
            },
            { 
              extend: 'pdf', 
              className: 'btn btn-danger',
              orientation: 'landscape',
              pageSize: 'LEGAL',
              title: title,
              customize: function (doc) {
                doc.defaultStyle.fontSize = 10;
                doc.styles.tableHeader.fontSize = 11;
                doc.styles.tableHeader.alignment = 'left';
                const colCount = doc.content[1].table.body[0].length;
                doc.content[1].table.widths = Array(colCount).fill('*');
              }
            },
            { 
              extend: 'print', 
              className: 'btn btn-primary',
              title: title
            }
          ],
          language: {
            search: "Search entries:",
          }
        });

        // Add search functionality
        const searchInput = document.getElementById(`search${monthKey}`);
        if (searchInput) {
          searchInput.addEventListener('keyup', function() {
            table.search(this.value).draw();
          });
        }

        // After DataTable initialization, style the buttons
        $(`#${tableId}_wrapper .dt-buttons`).addClass('btn-group flex-wrap mb-2');

        return table;
      }

      // Toggle account creation form
      document.getElementById('toggleAccountForm1').addEventListener('click', function() {
        const form = document.getElementById('createAccountForm');
        form.classList.toggle('d-none');
        this.innerHTML = form.classList.contains('d-none') 
          ? '<i class="bi bi-plus-circle me-1"></i>Add New Account'
          : '';
      });

      // Cancel button handler
      document.getElementById('cancelAccountCreate').addEventListener('click', function() {
        document.getElementById('createAccountForm').classList.add('d-none');
        document.getElementById('toggleAccountForm1').innerHTML = '"></i>Add New Account';
        document.getElementById('createAccountForm').reset();
      });

      // Handle account creation form submission
      document.getElementById('createAccountForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const email = document.getElementById('newAccountEmail').value;
        const password = document.getElementById('newAccountPassword').value;
        const confirmPassword = document.getElementById('confirmNewAccountPassword').value;
        const role = document.getElementById('newAccountRole').value;
        const department = document.getElementById('newAccountDepartment').value;
        const status = document.getElementById('newAccountStatus').value;

        // Validate passwords match
        if (password !== confirmPassword) {
          showErrorAlert('Passwords do not match!');
          return;
        }

        // Validate password length
        if (password.length < 6) {
          showErrorAlert('Password must be at least 6 characters long!');
          return;
        }

        // Show loading state
        Swal.fire({
          title: 'Creating Account',
          text: 'Please wait while we create the account...',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });

        // Create user in Firebase Auth
        firebase.auth().createUserWithEmailAndPassword(email, password)
          .then((userCredential) => {
            const user = userCredential.user;
            
            // Create user data object
            const userData = {
              email: email,
              role: role,
              department: department,
              status: status,
              createdAt: firebase.database.ServerValue.TIMESTAMP,
              createdBy: getSectionUser().email
            };

            // Save user data to database
            return database.ref('users/' + user.uid).set(userData);
          })
          .then(() => {
            // Show success message
            Swal.fire({
              title: 'Success!',
              text: 'Account created successfully!',
              icon: 'success',
              confirmButtonColor: '#002C75'
            });

            // Reset form and hide it
            this.reset();
            this.classList.add('d-none');
            document.getElementById('toggleAccountForm1').innerHTML = 
              '<i class="bi bi-plus-circle me-1"></i>Add New Account';

            // Log activity
            // logActivity('account_create', `Created new account for ${email}`, null); // Removed - not entry-related

            // Reload accounts table
            loadAccounts();
          })
          .catch((error) => {
            console.error('Error creating account:', error);
            Swal.fire({
              title: 'Error!',
              text: error.message,
              icon: 'error',
              confirmButtonColor: '#dc3545'
            });
          });
      });

      // Auto-fill email and department based on selected role
      document.getElementById('newAccountRole').addEventListener('change', function() {
        const selectedRole = this.value;
        const emailField = document.getElementById('newAccountEmail');
        const departmentField = document.getElementById('newAccountDepartment');
        
        if (selectedRole) {
          let emailDomain = '';
          let department = '';
          
          switch (selectedRole) {
            case 'Receiving':
              emailDomain = '@receiving.com';
              department = 'Receiving Division';
              break;
            case 'Admin':
              emailDomain = '@admin.com';
              department = 'Administrative Division';
              break;
            case 'Endorsement':
              emailDomain = '@endorsement.com';
              department = 'Endorsement Division';
              break;
            default:
              emailDomain = '';
              department = '';
          }
          
          if (emailDomain) {
            // Set email to just the domain without any username
            emailField.value = emailDomain;
          }
          
          if (department) {
            // Set department based on role
            departmentField.value = department;
          }
        } else {
          // Clear the email field and reset department when no role is selected
          emailField.value = ' ';
          departmentField.value = '';
        }
      });

      // Password toggle functionality for account creation form
      document.getElementById('toggleNewAccountPassword').addEventListener('click', function() {
        const passwordField = document.getElementById('newAccountPassword');
        const icon = document.getElementById('newAccountPasswordIcon');
        
        if (passwordField.type === 'password') {
          passwordField.type = 'text';
          icon.classList.remove('bi-eye');
          icon.classList.add('bi-eye-slash');
        } else {
          passwordField.type = 'password';
          icon.classList.remove('bi-eye-slash');
          icon.classList.add('bi-eye');
        }
      });

      document.getElementById('toggleConfirmNewAccountPassword').addEventListener('click', function() {
        const passwordField = document.getElementById('confirmNewAccountPassword');
        const icon = document.getElementById('confirmNewAccountPasswordIcon');
        
        if (passwordField.type === 'password') {
          passwordField.type = 'text';
          icon.classList.remove('bi-eye');
          icon.classList.add('bi-eye-slash');
        } else {
          passwordField.type = 'password';
          icon.classList.remove('bi-eye-slash');
          icon.classList.add('bi-eye');
        }
      });

      // Function to load accounts
      function loadAccounts() {
        const accountsTable = document.getElementById('accountsTable').getElementsByTagName('tbody')[0];
        accountsTable.innerHTML = '<tr><td colspan="6" class="text-center">Loading accounts...</td></tr>';

        database.ref('users').once('value')
          .then((snapshot) => {
            const accounts = snapshot.val();
            accountsTable.innerHTML = '';

            if (accounts) {
              Object.entries(accounts).forEach(([uid, account]) => {
                const row = accountsTable.insertRow();
                row.innerHTML = `
                  <td>${account.email}</td>
                  <td><span class="badge bg-primary">${account.role}</td>
                  <td>${account.department}</td>
                  <td><span class="badge bg-${account.status === 'active' ? 'success' : 'danger'}">${account.status}</span></td>
                  <td>${formatDate(account.createdAt)}</td>
                  <td>
                    <button class="btn btn-sm btn-warning" onclick="resetPassword('${uid}')" title="Reset password">
                      <i class="bi bi-key"></i>
                    </button>
                    <button class="btn btn-sm btn-info" onclick="changeRole('${uid}', '${account.role}')" title="Change role">
                      <i class="bi bi-person-badge"></i>
                    </button>
                    <button class="btn btn-sm btn-${account.status === 'active' ? 'danger' : 'success'}" onclick="toggleAccountStatus('${uid}', '${account.status}')" title="Toggle account status">
                      <i class="bi bi-toggle-${account.status === 'active' ? 'off' : 'on'}"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteAccount('${uid}', '${account.email}')" title="Delete account">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                `;
              });
            } else {
              accountsTable.innerHTML = '<tr><td colspan="6" class="text-center">No accounts found</td></tr>';
            }
          })
          .catch((error) => {
            console.error('Error loading accounts:', error);
            accountsTable.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading accounts</td></tr>';
          });
      }

      // Function to reset password
      function resetPassword(uid) {
        Swal.fire({
          title: 'Reset Password',
          text: 'Are you sure you want to reset this account\'s password?',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#002C75',
          cancelButtonColor: '#dc3545',
          confirmButtonText: 'Yes, reset it!'
        }).then((result) => {
          if (result.isConfirmed) {
            // Generate temporary password
            const tempPassword = Math.random().toString(36).slice(-8);
            
            // Get user email first
            database.ref(`users/${uid}`).once('value')
              .then((snapshot) => {
                const userData = snapshot.val();
                if (!userData || !userData.email) {
                  throw new Error('User email not found');
                }

                // Create custom auth token
                return firebase.auth().sendPasswordResetEmail(userData.email);
              })
              .then(() => {
                // Show success message
                Swal.fire({
                  title: 'Password Reset Email Sent!',
                  html: `A password reset email has been sent to the user's email address.`,
                  icon: 'success',
                  confirmButtonColor: '#002C75'
                });

                // Log activity
                // logActivity('password_reset_request', `Initiated password reset for user ${uid}`, null); // Removed - not entry-related
              })
              .catch((error) => {
                console.error('Error resetting password:', error);
                Swal.fire({
                  title: 'Error!',
                  text: 'Error resetting password. ' + error.message,
                  icon: 'error',
                  confirmButtonColor: '#dc3545'
                });
              });
          }
        });
      }

      // Function to toggle account status
      function toggleAccountStatus(uid, currentStatus) {
        const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
        
        Swal.fire({
          title: 'Change Account Status',
          text: `Are you sure you want to ${newStatus === 'active' ? 'activate' : 'deactivate'} this account?`,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#002C75',
          cancelButtonColor: '#dc3545',
          confirmButtonText: 'Yes, change it!'
        }).then((result) => {
          if (result.isConfirmed) {
            database.ref(`users/${uid}/status`).set(newStatus)
              .then(() => {
                showSuccessAlert(`Account ${newStatus === 'active' ? 'activated' : 'deactivated'} successfully!`);
                loadAccounts();
                // logActivity('status_change', `Changed account status to ${newStatus} for user ${uid}`, null); // Removed - not entry-related
              })
              .catch((error) => {
                console.error('Error changing account status:', error);
                showErrorAlert('Error changing account status. Please try again.');
              });
          }
        });
      }

      // Function to change user role
      function changeRole(uid, currentRole) {
        Swal.fire({
          title: 'Change User Role',
          html: `
            <div class="mb-3">
              <label for="changeRoleSelect" class="form-label">Select New Role:</label>
              <select class="form-select" id="changeRoleSelect">
                <option value="Staff">Staff</option>
                <option value="Administrator">Administrator</option>
                <option value="Receiving Staff">Receiving Staff</option>
                <option value="Receiving Administrator">Receiving Administrator</option>
                <option value="Endorsement Staff">Endorsement Staff</option>
                <option value="Endorsement Administrator">Endorsement Administrator</option>
              </select>
            </div>
          `,
          showCancelButton: true,
          confirmButtonColor: '#002C75',
          cancelButtonColor: '#dc3545',
          confirmButtonText: 'Change Role',
          preConfirm: () => {
            const newRole = document.getElementById('changeRoleSelect').value;
            if (!newRole) {
              Swal.showValidationMessage('Please select a role');
              return false;
            }
            return newRole;
          }
        }).then((result) => {
          if (result.isConfirmed) {
            const newRole = result.value;
            
            database.ref(`users/${uid}/role`).set(newRole)
              .then(() => {
                showSuccessAlert(`User role changed to ${newRole} successfully!`);
                loadAccounts();
              })
              .catch((error) => {
                console.error('Error changing user role:', error);
                showErrorAlert('Error changing user role. Please try again.');
              });
          }
        });
      }

      // Function to delete account
      function deleteAccount(uid, userEmail) {
        Swal.fire({
          title: 'Delete Account',
          text: `Are you sure you want to permanently delete the account for ${userEmail}? This action cannot be undone.`,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#dc3545',
          cancelButtonColor: '#6c757d',
          confirmButtonText: 'Yes, delete it!',
          input: 'text',
          inputLabel: 'Type "DELETE" to confirm',
          inputPlaceholder: 'Type DELETE to confirm deletion',
          inputValidator: (value) => {
            if (value !== 'DELETE') {
              return 'You must type DELETE to confirm';
            }
          }
        }).then((result) => {
          if (result.isConfirmed) {
            // Show loading state
            Swal.fire({
              title: 'Deleting Account',
              text: 'Please wait...',
              allowOutsideClick: false,
              didOpen: () => {
                Swal.showLoading();
              }
            });

            // Delete user from Firebase Auth (if possible)
            // Note: This requires admin SDK, so we'll just delete from database
            database.ref(`users/${uid}`).remove()
              .then(() => {
                showSuccessAlert('Account deleted successfully!');
                loadAccounts();
              })
              .catch((error) => {
                console.error('Error deleting account:', error);
                showErrorAlert('Error deleting account. Please try again.');
              });
          }
        });
      }

      // Load accounts when profile section is shown
      document.getElementById('profileLink').addEventListener('click', function() {
        setTimeout(loadAccounts, 500); // Delay to ensure DOM is ready
      });

      // Add this function to handle updating own password in profile section
      function updateOwnPassword() {
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (!currentPassword || !newPassword || !confirmPassword) {
          showErrorAlert('Please fill in all password fields');
          return;
        }

        if (newPassword !== confirmPassword) {
          showErrorAlert('New passwords do not match');
          return;
        }

        if (newPassword.length < 6) {
          showErrorAlert('New password must be at least 6 characters long');
          return;
        }

        const user = firebase.auth().currentUser;
        if (!user) {
          showErrorAlert('You must be logged in to change your password');
          return;
        }

        // Show loading state
        Swal.fire({
          title: 'Updating Password',
          text: 'Please wait...',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });

        // Reauthenticate with current password
        const credential = firebase.auth.EmailAuthProvider.credential(
          user.email,
          currentPassword
        );

        user.reauthenticateWithCredential(credential)
          .then(() => {
            // Update password
            return user.updatePassword(newPassword);
          })
          .then(() => {
            // Clear form
            document.getElementById('passwordForm').reset();

            // Show success message
            Swal.fire({
              title: 'Success!',
              text: 'Your password has been updated successfully',
              icon: 'success',
              confirmButtonColor: '#002C75'
            });

            // Log activity
            // logActivity('password_change', 'Changed own password', null); // Removed - not entry-related
          })
          .catch((error) => {
            console.error('Error updating password:', error);
            Swal.fire({
              title: 'Error!',
              text: 'Error updating password: ' + error.message,
              icon: 'error',
              confirmButtonColor: '#dc3545'
            });
          });
      }

      // Update the password form submission handler
      document.getElementById('passwordForm').addEventListener('submit', function(e) {
        e.preventDefault();
        updateOwnPassword();
      });

      const months = [
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
      ];
      const now = new Date();
      const currentMonthIndex = now.getMonth(); // 0-based index

      // Reorder months so current month is first
      const reorderedMonths = [
        ...months.slice(currentMonthIndex),
        ...months.slice(0, currentMonthIndex)
      ];

      // === ARCHIVES FILTER LOGIC ===

      // Helper: Get unique values from array of objects
      function getUniqueValues(entries, key) {
        const set = new Set();
        entries.forEach(e => {
          if (e[key]) set.add(e[key]);
        });
        return Array.from(set).sort();
      }

      // Populate filter modal dropdowns when modal is shown
      $(document).on('show.bs.modal', '#sortFilterModal', function () {
        // Get selected year
        const year = document.getElementById('archiveYearSelect')?.value;
        if (!year) return;
        // Find entries for this year
        const yearTable = document.getElementById(`archivedTable${year}`);
        if (!yearTable) return;
        const rows = yearTable.querySelectorAll('tbody tr');
        const entries = Array.from(rows).map(row => {
          const cells = row.querySelectorAll('td');
          return {
            controlNumber: cells[0]?.textContent.trim(),
            type: cells[1]?.textContent.trim(),
            timeReceived: cells[2]?.textContent.trim(),
            dateReceived: cells[3]?.textContent.trim(),
            from: cells[4]?.textContent.trim(),
            office: cells[5]?.textContent.trim(),
            subject: cells[6]?.textContent.trim(),
            endorsedTo: cells[7]?.textContent.trim(),
            remarks: cells[8]?.textContent.trim(),
            status: cells[9]?.textContent.trim(),
          };
        });
        // Populate dropdowns
        function fillSelect(id, values) {
          const sel = document.getElementById(id);
          if (!sel) return;
          sel.innerHTML = '<option value="">All</option>' + values.map(v => `<option value="${v}">${v}</option>`).join('');
        }
        fillSelect('filterFrom', getUniqueValues(entries, 'from'));
        fillSelect('filterOffice', getUniqueValues(entries, 'office'));
        fillSelect('filterEndorsedTo', getUniqueValues(entries, 'endorsedTo'));
        fillSelect('filterStatus', getUniqueValues(entries, 'status'));
      });

      // Filter logic for Apply button
      $('#applySortFilter').on('click', function () {
        const year = document.getElementById('archiveYearSelect')?.value;
        if (!year) return;
        const table = $(`#archivedTable${year}`).DataTable();
        // Gather filter values
        const months = Array.from(document.querySelectorAll('input[name="months"]:checked')).map(cb => cb.value);
        const types = Array.from(document.querySelectorAll('input[name="letterTypes"]:checked')).map(cb => cb.value);
        const dateReceived = document.getElementById('filterDateReceived').value;
        const from = document.getElementById('filterFrom').value;
        const office = document.getElementById('filterOffice').value;
        const endorsedTo = document.getElementById('filterEndorsedTo').value;
        const status = document.getElementById('filterStatus').value;
        // Custom filter function
        $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
          // Only filter the correct table
          if (settings.nTable.id !== `archivedTable${year}`) return true;
          // Data columns: 0=Control #, 1=Type, 2=Time, 3=Date, 4=From, 5=Office, 6=Subject, 7=Endorsed To, 8=Remarks, 9=Status
          const rowType = data[1];
          const rowDate = data[3];
          const rowFrom = data[4];
          const rowOffice = data[5];
          const rowEndorsedTo = data[7];
          const rowStatus = $(data[9]).text() || data[9];
          // Months
          if (months.length > 0) {
            const monthName = rowDate.split(' ')[0];
            if (!months.includes(monthName)) return false;
          }
          // Letter Types
          if (types.length > 0 && !types.includes(rowType)) return false;
          // Date Received
          if (dateReceived) {
            // Try to match YYYY-MM-DD or formatted date
            const rowDateVal = new Date(rowDate);
            const filterDateVal = new Date(dateReceived);
            if (rowDateVal.toISOString().slice(0,10) !== dateReceived) return false;
          }
          // From
          if (from && rowFrom !== from) return false;
          // Office
          if (office && rowOffice !== office) return false;
          // Endorsed To
          if (endorsedTo && rowEndorsedTo !== endorsedTo) return false;
          // Status
          if (status && rowStatus !== status) return false;
          return true;
        });
        table.draw();
        // Remove filter after draw to avoid affecting other tables
        $.fn.dataTable.ext.search.pop();
        // Close modal
        $('#sortFilterModal').modal('hide');
      });

      // Reset button logic
      $('#resetSortFilter').on('click', function () {
        document.getElementById('sortFilterForm').reset();
        const year = document.getElementById('archiveYearSelect')?.value;
        if (!year) return;
        const table = $(`#archivedTable${year}`).DataTable();
        table.search('').columns().search('').draw();
      });
      // === END ARCHIVES FILTER LOGIC ===

      // === EMAILJS INTEGRATION ===
      // Initialize EmailJS (replace 'Tp4tK-Kp7Vr1m3Kv6' with your actual EmailJS user ID if different)
      emailjs.init('mr3lRz__Eu1dWmX1Z');

      // Function to send email notification on status update
        // === EMAILJS INTEGRATION ===
      // Initialize EmailJS (already in your setup)
      emailjs.init('mr3lRz__Eu1dWmX1Z');

      function sendStatusUpdateEmail(entry) {
        // Use the client email from the entry or fallback
        const clientEmail = entry.fromEmail || "mysagesierra@gmail.com";

        // Send the email using EmailJS
        emailjs.send("service_zfmf4zb", "template_h3f31qv", {
          to_email: clientEmail,
          reply_to: clientEmail, // reply-to for email responses
          title: "Document Status Update",

          //  Template Data  must match your EmailJS placeholders
          controlNumber: entry.controlNumber,
          subject: entry.subject,
          status: entry.status,
          statusRemarks: entry.statusRemarks || "No additional remarks provided.",
          fileUrl: entry.fileUrl || "",

          //  Additional fields for custom message block
          name: entry.name || "Unknown Sender",
          time: entry.time || new Date().toLocaleString(), // fallback to current time
          message: entry.message || "No message content provided.",
          email: clientEmail
        })
        .then(function(response) {
          console.log('Email sent!', response.status, response.text);
        }, function(error) {
          console.error('Failed to send email:', error);
        });
      }

      // Show preview for fileUrl in create modal
      document.getElementById("fileUrl").addEventListener("input", function() {
        const url = this.value;
        const previewDiv = document.getElementById("fileUrlPreview");
        if (url) {
          let embedUrl = url;
          if (embedUrl.includes("view?usp=sharing")) {
            embedUrl = embedUrl.replace("view?usp=sharing", "preview");
          }
          previewDiv.innerHTML = `<a href="${url}" target="_blank" class="btn btn-outline-primary btn-sm mb-2">View File in Google Drive</a><br><iframe src="${embedUrl}" width="100%" height="400" style="border:1px solid #ccc;"></iframe>`;
        } else {
          previewDiv.innerHTML = "<span class='text-muted'>No file link provided.</span>";
        }
      });

      // Notification logic
      const notifBadge = document.getElementById('notifBadge');
      const notifDropdown = document.getElementById('notifDropdown');
      let unreadCount = 0;
      let notifications = [];

      // Listen for new entries (created in the last 5 minutes)
      entriesRef.orderByChild('createdAt').limitToLast(10).on('child_added', (snapshot) => {
        const entry = snapshot.val();
        if (!entry || !entry.createdAt) return;
        const now = Date.now();
        if (now - entry.createdAt < 5 * 60 * 1000) { // 5 minutes
          notifications.unshift({
            controlNumber: entry.controlNumber,
            subject: entry.subject,
            createdAt: entry.createdAt
          });
          unreadCount++;
          updateNotifUI();
        }
      });

      function updateNotifUI() {
        const allNotifBadge = document.getElementById('allNotifBadge');
        allNotifBadge.textContent = unreadCount;
        allNotifBadge.style.display = unreadCount > 0 ? 'inline-block' : 'none';
      }

      document.getElementById("notificationsLink").addEventListener("click", function(e) {
        e.preventDefault();
        unreadCount = 0;
        const allNotifBadge = document.getElementById('allNotifBadge');
        allNotifBadge.style.display = 'none';
        const modal = new bootstrap.Modal(document.getElementById("allNotificationsModal"));
        modal.show();
        loadAllNotificationsModal();
      });

      function loadAllNotificationsModal() {
        entriesRef.orderByChild('createdAt').once("value", (snapshot) => {
          const entries = snapshot.val();
          const tbody = document.querySelector("#allNotificationsTable tbody");
          tbody.innerHTML = "";
          const now = Date.now();
          if (entries) {
            Object.entries(entries)
              .sort((a, b) => b[1].createdAt - a[1].createdAt)
              .forEach(([key, entry]) => {
                // Mark as new if within last 5 minutes
                const isNew = now - entry.createdAt < 5 * 60 * 1000;
                const newBadge = isNew ? '<span class="badge bg-success ms-2">New</span>' : '';
                const row = document.createElement("tr");
                row.innerHTML = `
                  <td>${entry.controlNumber} ${newBadge}</td>
                  <td>${entry.subject}</td>
                  <td>${new Date(entry.createdAt).toLocaleString()}</td>
                  <td>
                    <button class="btn btn-sm btn-primary view-entry-btn" data-key="${key}" title="View entry details">
                      <i class="bi bi-eye"></i> View
                    </button>
                  </td>
                `;
                tbody.appendChild(row);
              });
          }
          // Always (re)initialize DataTables after updating the table
          if ($.fn.DataTable.isDataTable('#allNotificationsTable')) {
            $('#allNotificationsTable').DataTable().destroy();
          }
          $('#allNotificationsTable').DataTable({
            pageLength: 10,
            order: [[2, 'desc']],
            language: {
              search: 'Search notifications:',
              emptyTable: 'No notifications found.'
            }
          });
        });
      }

      // Initialize DataTables on the notifications modal table when modal is shown
      $('#allNotificationsModal').on('shown.bs.modal', function () {
        if ($.fn.DataTable.isDataTable('#allNotificationsTable')) {
          $('#allNotificationsTable').DataTable().destroy();
        }
        $('#allNotificationsTable').DataTable({
          pageLength: 10,
          order: [[2, 'desc']],
          language: {
            search: 'Search notifications:',
            emptyTable: 'No notifications found.'
          }
        });
      });

      // Delegate click event for view buttons in notifications modal
      $('#allNotificationsTable').off('click', '.view-entry-btn').on('click', '.view-entry-btn', function() {
        const key = $(this).data('key');
        $('#allNotificationsModal').modal('hide');
        setTimeout(() => {
          editEntry(key);
          $('#editEntryModal').modal('show');
        }, 300);
      });

      function getStatusBadge(status) {
        switch (status) {
          case "Under Investigation": return '<span class="badge bg-primary">Under Investigation</span>';
          case "Processing": return '<span class="badge bg-info">Processing</span>';
          case "Completed": return '<span class="badge bg-success">Completed</span>';
          case "Calendar Pending": return '<span class="badge bg-warning">Calendar Pending</span>';
          case "For Review": return '<span class="badge bg-primary">For Review</span>';
          // ...add more as needed
          default: return `<span class="badge bg-secondary">${status}</span>`;
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        const printBtn = document.getElementById("printReportsBtn");
        if (printBtn) {
          printBtn.addEventListener("click", function () {
            // Before printing, force charts to redraw for print (Chart.js)
            if (window.Chart) {
              Object.values(Chart.instances || {}).forEach(chart => chart.resize());
            }
            window.print();
          });
        }

        // Export functionality
        const copyBtn = document.getElementById("copyReportsBtn");
        const csvBtn = document.getElementById("csvReportsBtn");
        const excelBtn = document.getElementById("excelReportsBtn");
        const pdfBtn = document.getElementById("pdfReportsBtn");

        if (copyBtn) {
          copyBtn.addEventListener("click", function() {
            exportToClipboard();
          });
        }

        if (csvBtn) {
          csvBtn.addEventListener("click", function() {
            exportToCSV();
          });
        }

        if (excelBtn) {
          excelBtn.addEventListener("click", function() {
            exportToExcel();
          });
        }

        if (pdfBtn) {
          pdfBtn.addEventListener("click", function() {
            exportToPDF();
          });
        }

        // Role selection handler for automatic department assignment and endorsement office dropdown
        const roleSelect = document.getElementById("newAccountRole");
        const departmentSelect = document.getElementById("newAccountDepartment");
        const endorsementOfficeRow = document.getElementById("endorsementOfficeRow");
        const endorsementOfficeSelect = document.getElementById("endorsementOffice");
        const finalRoleInput = document.getElementById("finalRole");
        
        if (roleSelect && departmentSelect) {
          roleSelect.addEventListener("change", function() {
            const selectedRole = this.value;
            
            // Auto-set department based on role selection
            const emailInput = document.getElementById("newAccountEmail");
            
            if (selectedRole === "Receiving") {
              departmentSelect.value = "Receiving Division";
              endorsementOfficeRow.style.display = "none";
              finalRoleInput.value = "Receiving";
              emailInput.value = "";
            } else if (selectedRole === "Admin") {
              departmentSelect.value = "Administrative Division";
              endorsementOfficeRow.style.display = "none";
              finalRoleInput.value = "Admin";
              emailInput.value = "";
            } else if (selectedRole === "Endorsement") {
              departmentSelect.value = "Endorsement Division";
              endorsementOfficeRow.style.display = "block";
              endorsementOfficeSelect.required = true;
              finalRoleInput.value = "";
              emailInput.value = "";
            } else {
              departmentSelect.value = "";
              endorsementOfficeRow.style.display = "none";
              finalRoleInput.value = "";
              emailInput.value = "";
            }
          });
        }

        // Endorsement office selection handler
        if (endorsementOfficeSelect) {
          endorsementOfficeSelect.addEventListener("change", function() {
            const selectedOffice = this.value;
            const emailInput = document.getElementById("newAccountEmail");
            
            if (selectedOffice) {
              finalRoleInput.value = `Endorsement - ${selectedOffice}`;
              
              // Auto-generate email based on endorsement office
              const officeAcronym = selectedOffice.toLowerCase().replace(/\s+/g, '-');
              emailInput.value = `@endorsement-${officeAcronym}.com`;
            } else {
              finalRoleInput.value = "";
              emailInput.value = "";
            }
          });
        }


      });
    </script>
  </body>
</html>