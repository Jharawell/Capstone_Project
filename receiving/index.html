<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Receiving Section Dashboard</title>
    <link rel="shortcut icon" href="../assets/images/logo.svg" type="image/x-icon" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />
    <!-- Add DataTables CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css"
    />
    <link rel="stylesheet" href="../assets/css/style.css" />
    <style>
      /* Add custom styling for DataTables buttons */
      .dt-buttons .btn {
        margin-right: 8px;
      }
      .dt-buttons .btn:last-child {
        margin-right: 0;
      }

      #currentUserEmailreceiving{
        font-size: 15px;
      }
    </style>
  </head>
  <body>
    <button class="menu-toggle" id="menuToggle">
      <i class="bi bi-list"></i>
    </button>

    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 px-0 sidebar" id="sidebar">
          <div class="d-flex flex-column p-4">
            <div class="d-flex justify-content-center">
              <a
                href="/"
                class="d-flex flex-column align-items-center text-white text-decoration-none"
                aria-label="Go to CentralComm homepage"
              >
                <img
                  src="../assets/images/logo.svg"
                  alt="CentralComm Logo"
                  class="mb-1"
                  style="width: 50px; height: 50px"
                />
                <span class="fs-2 mt-6">CentralComm</span>
                <span id="currentUserEmailreceiving">receivingbaguio645@gmail.com</span>
              </a>
            </div>

            <hr class="border-light opacity-50" />
            <ul class="nav nav-pills flex-column mb-auto">
              <li class="nav-item">
                <a href="#" class="nav-link active" id="dashboardLink">
                  <i class="bi bi-house-door stat-icon"></i>
                  Dashboard
                </a>
              </li>
              <li>
                <a href="#" class="nav-link" id="documentsLink">
                  <i class="bi bi-file-earmark-text stat-icon"></i>
                  Documents
                </a>
              </li>
              <li hidden>
                <a href="#" class="nav-link" id="usersLink">
                  <i class="bi bi-people stat-icon"></i>
                  Users
                </a>
              </li>
              <li>
                <a href="#" class="nav-link" id="archivesLink">
                  <i class="bi bi-archive stat-icon"></i>
                  Archives
                </a>
              </li>
              <li>
                <a href="#" class="nav-link" id="historyLink">
                  <i class="bi bi-clock-history stat-icon"></i>
                  History
                </a>
              </li>
              <li>
                <a href="#" class="nav-link" id="profileLink">
                  <i class="bi bi-person-circle stat-icon"></i>
                  Profile
                </a>
              </li>
              <li>
                <a href="#" class="nav-link" onclick="signOut()">
                  <i class="bi bi-box-arrow-right me-2"></i>
                  Sign out
                </a>
              </li>
              
            </ul>
            <hr class="border-light opacity-50" />
          </div>
        </div>

        <!-- Main content -->
        <div class="col-md-9 col-lg-10 main-content">
          <!-- Dashboard Section -->
          <div id="dashboardSection">
            <div class="header-section card-header bg-white">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h1 class="h2 mb-1">Receiving Section - Mayor's Office Dashboard</h1>
                  <p class="mb-0 text-muted">Welcome back, <span id="currentUserName">Receiving</span></p>
                </div>
                <div class="d-flex justify-content-end gap-2 mb-2 mb-md-0">
                  <!-- Create New Button -->
                  <button
                    type="button"
                    class="btn btn-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#createEntryModal"
                  >
                    <i class="bi bi-plus-circle me-2"></i>Create New
                  </button>

                  <!-- Archive All Button -->
                  <button
                    type="button"
                    class="btn btn-secondary"
                    id="archiveAllBtn"
                  >
                    <i class="bi bi-archive me-2"></i>Archive All
                  </button>
                </div>
              </div>
            </div>

            <!-- Monthly Statistics -->
            <div class="card mb-4">
              <div class="card-header bg-white">
                <h5 class="card-title mb-0">Monthly Statistics</h5>
              </div>
              <div class="card-body p-0">
                <div class="accordion" id="monthlyStatsAccordion">
                  <!-- Monthly statistics will be populated here -->
                </div>
              </div>
            </div>
          </div>

          <!-- Archives Section -->
          <div id="archivesSection" class="d-none">
            <div class="header-section card-header bg-white">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h1 class="h2 mb-1">Archived Entries</h1>
                  <p class="mb-0 text-white-50">
                    View archived entries by year
                  </p>
                </div>
              </div>
            </div>

            <div class="card mb-4">
              <div class="card-body">
                <div class="row" id="archivedYearsContainer">
                  <!-- Archived years will be populated here -->
                </div>
              </div>
            </div>
          </div>

          <!-- Documents Section -->
          <div id="documentsSection" class="d-none">
            <div class="header-section card-header bg-white">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h1 class="h2 mb-1">Documents Summary</h1>
                  <p class="mb-0 text-white-50">
                    View document statistics and analytics
                  </p>
                </div>
              </div>
            </div>

            <div class="row">
              <!-- Yearly Statistics -->
              <div class="col-md-6 mb-4">
                <div class="card h-100">
                  <div class="card-body">
                    <h6 class="card-title text-primary mb-3">
                      Yearly Statistics
                    </h6>
                    <div class="table-responsive">
                      <table class="table table-sm">
                        <tbody>
                          <tr>
                            <td>Total Letters Received</td>
                            <td class="text-end" id="yearlyTotal">0</td>
                          </tr>
                          <tr>
                            <td>Complaints</td>
                            <td class="text-end" id="yearlyComplaints">0</td>
                          </tr>
                          <tr>
                            <td>Requests</td>
                            <td class="text-end" id="yearlyRequests">0</td>
                          </tr>
                          <tr>
                            <td>Proposals</td>
                            <td class="text-end" id="yearlyProposals">0</td>
                          </tr>
                          <tr>
                            <td>Invitations</td>
                            <td class="text-end" id="yearlyInvitations">0</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Monthly Statistics -->
              <div class="col-md-6 mb-4">
                <div class="card h-100">
                  <div class="card-body">
                    <h6 class="card-title text-primary mb-3">
                      Monthly Statistics
                    </h6>
                    <div class="table-responsive">
                      <table class="table table-sm">
                        <tbody>
                          <tr>
                            <td>Current Month Letters</td>
                            <td class="text-end" id="monthlyTotal">0</td>
                          </tr>
                          <tr>
                            <td>Average Daily Letters</td>
                            <td class="text-end" id="avgDailyLetters">0</td>
                          </tr>
                          <tr>
                            <td>Highest Volume Month</td>
                            <td class="text-end" id="highestVolumeMonth">-</td>
                          </tr>
                          <tr>
                            <td>Lowest Volume Month</td>
                            <td class="text-end" id="lowestVolumeMonth">-</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Monthly Letters Graph -->
              <div class="col-12 mb-4">
                <div class="card">
                  <div class="card-body">
                    <h6 class="card-title text-primary mb-3">
                      Monthly Letters Received
                    </h6>
                    <canvas id="monthlyLettersChart" height="300"></canvas>
                  </div>
                </div>
              </div>

              <!-- Remove Letter Types Distribution section -->
            </div>
          </div>

          <!-- Users Section -->
          <div id="usersSection" class="d-none">
            <div class="header-section card-header bg-white">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h1 class="h2 mb-1">Users</h1>
                  <p class="mb-0 text-white-50">Manage system users</p>
                </div>
                <div>
                  <button
                    type="button"
                    class="btn btn-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#createUserModal"
                  >
                    <i class="bi bi-person-plus me-2"></i>Create New User
                  </button>
                </div>
              </div>
            </div>
            <div class="card mb-4">
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover" id="usersTable">
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- Users will be populated here -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- History Section -->
          <div id="historySection" class="d-none">
            <div class="header-section card-header bg-white">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h1 class="h2 mb-1">History</h1>
                  <p class="mb-0 text-white-50">View system activity history</p>
                </div>
              </div>
            </div>
            <div class="card mb-4">
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover" id="historyTable">
                    <thead>
                      <tr>
                        <th>Timestamp</th>
                        <th>User</th>
                        <th>Action</th>
                        <th>Details</th>
                        <th>Control Number</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- History will be populated here -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Profile Section -->
          <div id="profileSection" class="d-none">
            <div class="header-section card-header bg-white">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h1 class="h2 mb-1">Profile Management</h1>
                  <p class="mb-0 text-white-50">Manage your account settings</p>
                </div>
              </div>
            </div>

            <div class="row">
              <!-- Profile Settings -->
              <div class="col-lg-8 mb-4">
                <div class="card">
                  <div class="card-body">
                    <h5 class="card-title mb-4">Account Settings</h5>
                    <form id="profileForm">
                      <div class="mb-3">
                        <label for="email" class="form-label">Email Address</label>
                        <div class="input-group">
                          <span class="input-group-text">
                            <i class="bi bi-envelope"></i>
                          </span>
                          <input
                            type="email"
                            class="form-control with-icon"
                            id="email"
                            value="admin@centralcomm.com"
                            readonly
                          />
                        </div>
                      </div>
                      <div class="mb-3">
                        <label for="role" class="form-label">Department</label>
                        <div class="input-group">
                          <span class="input-group-text">
                            <i class="bi bi-person-badge"></i>
                          </span>
                          <input
                            type="text"
                            class="form-control with-icon"
                            id="role"
                            value="Receiving Section - Mayor's Office"
                            readonly
                          />
                        </div>
                      </div>
                    </form>
                  </div>
                </div>

                <!-- Change Password -->
                <div class="card mt-4">
                  <div class="card-body">
                    <h5 class="card-title mb-4">Change Password</h5>
                    <form id="passwordForm">
                      <div class="mb-3">
                        <label for="currentPassword" class="form-label">Current Password</label>
                        <input
                          type="password"
                          class="form-control"
                          id="currentPassword"
                          required
                        />
                      </div>
                      <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password</label>
                        <input
                          type="password"
                          class="form-control"
                          id="newPassword"
                          required
                        />
                      </div>
                      <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Confirm New Password</label>
                        <input
                          type="password"
                          class="form-control"
                          id="confirmPassword"
                          required
                        />
                      </div>
                      <button type="submit" class="btn btn-primary">
                        Update Password
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Create Entry Modal -->
    <div
      class="modal fade"
      id="createEntryModal"
      tabindex="-1"
      aria-labelledby="createEntryModalLabel"
      aria-hidden="true"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header card-header bg-white">
            <h5 class="modal-title" id="createEntryModalLabel">
              Create New Entry
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="createEntryForm">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="letterType" class="form-label">Type</label>
                  <select class="form-select" id="letterType" required>
                    <option value="" disabled selected>Select Type</option>
                    <option value="Complaint">Complaint</option>
                    <option value="Request">Request</option>
                    <option value="Proposal">Proposal</option>
                    <option value="Invitation">Invitation</option>
                    <option value="Other">Other</option>
                  </select> 
                </div>
                <div class="col-md-6">
                  <label for="controlNumber" class="form-label"
                    >Control Number</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="controlNumber"
                    readonly
                  />
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="dateReceived" class="form-label"
                    >Date Received</label
                  >
                  <input
                    type="date"
                    class="form-control"
                    id="dateReceived"
                    required disabled
                  />
                </div>
                <div class="col-md-6">
                  <label for="timeReceived" class="form-label"
                    >Time Received</label
                  >
                  <input
                    type="time"
                    class="form-control"
                    id="timeReceived"
                    required disabled
                  />
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="from" class="form-label">From</label>
                  <input type="text" class="form-control" id="from" required />
                </div>
                <div class="col-md-6">
                  <label for="office" class="form-label">Office</label>
                  <input
                    type="text"
                    class="form-control"
                    id="office"
                    required
                  />
                </div>
              </div>
              <div class="mb-3">
                <label for="subject" class="form-label">Subject</label>
                <input type="text" class="form-control" id="subject" required />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button type="button" class="btn btn-primary" id="saveEntry">
              Save Entry
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Entry Modal -->
    <div
      class="modal fade"
      id="editEntryModal"
      tabindex="-1"
      aria-labelledby="editEntryModalLabel"
      aria-hidden="true"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header card-header bg-white">
            <h5 class="modal-title" id="editEntryModalLabel">Edit Entry</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editEntryForm">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="editType" class="form-label">Type</label>
                  <select class="form-select" id="editType" required>
                    <option value="">Select Type</option>
                    <option value="Complaint">Complaint</option>
                    <option value="Request">Request</option>
                    <option value="Proposal">Proposal</option>
                    <option value="Invitation">Invitation</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="editControlNumber" class="form-label"
                    >Control Number</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="editControlNumber"
                    required disabled
                  />
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="editDateReceived" class="form-label"
                    >Date Received</label
                  >
                  <input
                    type="date"
                    class="form-control"
                    id="editDateReceived"
                    required disabled
                  />
                </div>
                <div class="col-md-6">
                  <label for="editTimeReceived" class="form-label"
                    >Time Received</label
                  >
                  <input
                    type="time"
                    class="form-control"
                    id="editTimeReceived"
                    required disabled
                  />
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="editFrom" class="form-label">From</label>
                  <input
                    type="text"
                    class="form-control"
                    id="editFrom"
                    required
                  />
                </div>
                <div class="col-md-6">
                  <label for="editOffice" class="form-label">Office</label>
                  <input
                    type="text"
                    class="form-control"
                    id="editOffice"
                    required
                  />
                </div>
              </div>
              <div class="mb-3">
                <label for="editSubject" class="form-label">Subject</label>
                <input
                  type="text"
                  class="form-control"
                  id="editSubject"
                  required
                />
              </div>
              <div class="mb-3" hidden>
                <label for="editEndorsedTo" class="form-label"
                  >Endorsed To</label
                >
                <select class="form-select" id="editEndorsedTo" required>
                  <option value="">Select Office</option>
                  <option value="Vice Mayor's Office">
                    Vice Mayor's Office
                  </option>
                  <option value="Sangguniang Panlungsod">
                    Sangguniang Panlungsod
                  </option>
                  <option value="CAO">CAO</option>
                  <option value="CASSO">CASSO</option>
                  <option value="CADMO">CADMO</option>
                  <option value="CBO">CBO</option>
                  <option value="CEPMO">CEPMO</option>
                  <option value="CHRMO">CHRMO</option>
                  <option value="CLO">CLO</option>
                  <option value="CPDSO">CPDSO</option>
                  <option value="CTO">CTO</option>
                  <option value="GSO">GSO</option>
                  <option value="CBAO">CBAO</option>
                  <option value="CEO">CEO</option>
                  <option value="CSWDO">CSWDO</option>
                  <option value="HSO">HSO</option>
                  <option value="LCR">LCR</option>
                  <option value="CVAO">CVAO</option>
                  <option value="DepEd">DepEd</option>
                  <option value="COA">COA</option>
                  <option value="MTCC">MTCC</option>
                  <option value="RTCC">RTCC</option>
                  <option value="Prosecutor's Office">
                    Prosecutor's Office
                  </option>
                  <option value="PESO">PESO</option>
                  <option value="PIO">PIO</option>
                  <option value="PLD">PLD</option>
                  <option value="PLEB">PLEB</option>
                  <option value="POSD">POSD</option>
                  <option value="SSD">SSD</option>
                  <option value="PDAO">PDAO</option>
                  <option value="MITD">MITD</option>
                  <option value="CCTV/EWSS">CCTV/EWSS</option>
                  <option value="CDRRMO">CDRRMO</option>
                  <option value="LIBRARY">LIBRARY</option>
                  <option value="PERSONAL STAFF">PERSONAL STAFF</option>
                </select>
              </div>
              <div class="mb-3" hidden>
                <label for="editFileUpload" class="form-label"
                  >File Upload</label
                >
                <input
                  type="file"
                  class="form-control"
                  id="editFileUpload"
                  accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                />
                <div class="form-text">
                  Accepted formats: PDF, DOC, DOCX, JPG, JPEG, PNG
                </div>
              </div>
              <div class="mb-3" hidden>
                <label for="editRemarks" class="form-label">Remarks</label>
                <textarea
                  class="form-control"
                  id="editRemarks"
                  rows="3"
                ></textarea>
              </div>
              <div class="mb-3">
                <label for="editStatus" class="form-label">Status</label>
                <select class="form-select" id="editStatus" required disabled>
                  <option value="Pending">Pending</option>
                  <option value="Processing">Processing</option>
                  <option value="Completed">Completed</option>
                  <option value="Archived">Archived</option>
                  <option value="Under Investigation">Under Investigation (Ongoing)</option>
                  <option value="Inspection">Inspection, Acted Upon (Done)</option>
                </select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button type="button" class="btn btn-primary" id="updateEntry">
              Update Entry
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- View Archived Entry Modal -->
    <div
      class="modal fade"
      id="viewArchivedModal"
      tabindex="-1"
      aria-labelledby="viewArchivedModalLabel"
      aria-hidden="true"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header card-header bg-white">
            <h5 class="modal-title" id="viewArchivedModalLabel">
              Archived Entry Details
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <!-- Entry details will be populated here -->
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- View Audit Log Modal -->
    <div
      class="modal fade"
      id="viewAuditLogModal"
      tabindex="-1"
      aria-labelledby="viewAuditLogModalLabel"
      aria-hidden="true"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header card-header bg-white">
            <h5 class="modal-title" id="viewAuditLogModalLabel">
              Audit Log Details
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row mb-3">
              <div class="col-md-6">
                <strong>Timestamp:</strong> <span id="auditTimestamp"></span>
              </div>
              <div class="col-md-6">
                <strong>User:</strong> <span id="auditUser"></span>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <strong>Action:</strong> <span id="auditAction"></span>
              </div>
              <div class="col-md-6">
                <strong>Control Number:</strong>
                <span id="auditControlNumber"></span>
              </div>
            </div>
            <div class="mb-3">
              <strong>Details:</strong>
              <p id="auditDetails" class="mt-2"></p>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Create User Modal -->
    <div
      class="modal fade"
      id="createUserModal"
      tabindex="-1"
      aria-labelledby="createUserModalLabel"
      aria-hidden="true"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header card-header bg-white">
            <h5 class="modal-title" id="createUserModalLabel">Create New User</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="createUserForm">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="newFirstName" class="form-label">First Name</label>
                  <div class="input-group">
                    <span class="input-group-text">
                      <i class="bi bi-person"></i>
                    </span>
                  <input
                    type="text"
                      class="form-control with-icon"
                    id="newFirstName"
                      placeholder="First Name"
                    required
                  />
                  </div>
                </div>
                <div class="col-md-6">
                  <label for="newLastName" class="form-label">Last Name</label>
                  <div class="input-group">
                    <span class="input-group-text">
                      <i class="bi bi-person"></i>
                    </span>
                  <input
                    type="text"
                      class="form-control with-icon"
                    id="newLastName"
                      placeholder="Last Name"
                    required
                  />
                  </div>
                </div>
              </div>
              <div class="mb-3">
                <label for="newEmail" class="form-label">Email Address</label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="bi bi-envelope"></i>
                  </span>
                <input
                  type="email"
                    class="form-control with-icon"
                  id="newEmail"
                    placeholder="Email"
                  required
                />
              </div>
              </div>
              <div class="mb-3">
                <label for="newRole" class="form-label">Role</label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="bi bi-person-badge"></i>
                  </span>
                  <select class="form-control with-icon" id="newRole" required>
                  <option value="">Select Role</option>
                    <option value="Administrator">Administrator</option>
                    <option value="Staff">Staff</option>
                    <option value="Manager">Manager</option>
                </select>
                </div>
              </div>
              <div class="mb-3">
                <label for="newPassword" class="form-label">Password</label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="bi bi-key"></i>
                  </span>
                <input
                  type="password"
                    class="form-control with-icon"
                  id="newPassword"
                    placeholder="Password"
                  required
                />
                </div>
              </div>
              <div class="mb-3">
                <label for="confirmNewPassword" class="form-label">Confirm Password</label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="bi bi-key-fill"></i>
                  </span>
                <input
                  type="password"
                    class="form-control with-icon"
                  id="confirmNewPassword"
                    placeholder="Confirm Password"
                  required
                />
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button type="button" class="btn btn-primary" id="saveUser">
              Create User
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
      crossorigin="anonymous"
    ></script>
    <!-- Add DataTables JS -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
    <!-- Add SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Add Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      // Initialize Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyCaSHRLbIRWW8COl5iwHb19dMDYYLJ2DIk",
        authDomain: "centralcomm-248a9.firebaseapp.com",
        databaseURL: "https://centralcomm-248a9-default-rtdb.firebaseio.com",
        projectId: "centralcomm-248a9",
        storageBucket: "centralcomm-248a9.firebasestorage.app",
        messagingSenderId: "796912003621",
        appId: "1:796912003621:web:0d6fd82e43399871a9edcc",
        measurementId: "G-CN0S9L5YV4",
      };

      // Initialize Firebase if not already initialized
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }

      const database = firebase.database();
      const entriesRef = database.ref("entries");

      // Function to generate control number
      function generateControlNumber() {
        // Get the current year
        const year = new Date().getFullYear();
        
        // Get the last control number from the database
        return database.ref('lastControlNumber').once('value').then(snapshot => {
          let lastNumber = snapshot.val() || 0;
          
          // Update the last control number in the database
          database.ref('lastControlNumber').set(lastNumber + 1);
          
          // Format the number with 5 leading zeros
          const formattedNumber = String(lastNumber + 1).padStart(5, '0');
          return `${year}-${formattedNumber}`;
        });
      }

      // Function to get the next control number without incrementing
      function getNextControlNumber() {
        // Get the current year
        const year = new Date().getFullYear();
        
        // Get the last control number from the database
        return database.ref('lastControlNumber').once('value').then(snapshot => {
          let lastNumber = snapshot.val() || 0;
          
          // Format the number with 5 leading zeros
          const formattedNumber = String(lastNumber + 1).padStart(5, '0');
          return `${year}-${formattedNumber}`;
        });
      }

      // Function to check and archive old entries
      function checkAndArchiveEntries() {
        // Show loading state
        Swal.fire({
          title: "Checking Entries",
          text: "Please wait while we check for entries to archive...",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        const currentYear = new Date().getFullYear();
        entriesRef
          .once("value", (snapshot) => {
            const entries = snapshot.val();
            if (entries) {
              let archivedCount = 0;
              let totalToArchive = 0;

              // First count how many entries need to be archived
              Object.entries(entries).forEach(([_, entry]) => {
                const entryYear = new Date(entry.dateReceived).getFullYear();
                if (
                  currentYear === 2025 &&
                  entryYear < 2025 &&
                  entry.status !== "Archived"
                ) {
                  totalToArchive++;
                }
              });

              if (totalToArchive === 0) {
                Swal.close();
                return;
              }

              // Update loading message
              Swal.update({
                title: "Archiving Entries",
                html: `Archiving ${totalToArchive} entries...`,
              });

              // Archive each entry
              Object.entries(entries).forEach(([key, entry]) => {
                const entryYear = new Date(entry.dateReceived).getFullYear();
                if (
                  currentYear === 2025 &&
                  entryYear < 2025 &&
                  entry.status !== "Archived"
                ) {
                  entriesRef
                    .child(key)
                    .update({
                      status: "Archived",
                      archivedAt: firebase.database.ServerValue.TIMESTAMP,
                    })
                    .then(() => {
                      archivedCount++;
                      logActivity(
                        "archive",
                        `Archived entry from ${entryYear}: ${entry.subject}`,
                        entry.controlNumber
                      );

                      // Update progress
                      if (archivedCount === totalToArchive) {
                        Swal.fire({
                          title: "Success!",
                          text: `Successfully archived ${archivedCount} entries!`,
                          icon: "success",
                          confirmButtonColor: "",
                        });
                      }
                    })
                    .catch((error) => {
                      console.error("Error archiving entry:", error);
                      Swal.fire({
                        title: "Error!",
                        text: "Error archiving entries. Please try again.",
                        icon: "error",
                        confirmButtonColor: "#dc3545",
                      });
                    });
                }
              });
            }
            Swal.close();
          })
          .catch((error) => {
            console.error("Error checking entries:", error);
            Swal.close();
            showErrorAlert("Error checking entries. Please try again.");
          });
      }

      // Function to load entries into the table
      function loadEntries() {
        const currentYear = getCurrentYear();
        entriesRef.on("value", (snapshot) => {
          const entries = snapshot.val();
          const accordionContainer = document.getElementById(
            "monthlyStatsAccordion"
          );

          // Create months array
          const months = [
            "January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
          ];

          // Clear existing content
          accordionContainer.innerHTML = "";

          // Create empty accordion items for all months first
          months.forEach((month) => {
            const monthKey = `${month.toLowerCase()}${currentYear}`;
            const accordionItem = document.createElement("div");
            accordionItem.className = "accordion-item border-0 mb-2";
            accordionItem.id = `accordion-${monthKey}`;
            accordionItem.innerHTML = `
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${monthKey}">
                  <div class="d-flex justify-content-between align-items-center w-100">
                    <div>
                      <span class="fw-bold">${month} ${currentYear}</span>
                      <span class="badge bg-warning ms-2">Active</span>
                    </div>
                    <div class="text-muted small">
                      <i class="bi bi-arrow-down-circle me-1"></i>
                      Click to view details
                    </div>
                  </div>
                </button>
              </h2>
              <div id="${monthKey}" class="accordion-collapse collapse" data-bs-parent="#monthlyStatsAccordion">
                <div class="accordion-body">
                  <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading data for ${month} ${currentYear}...</p>
                  </div>
                </div>
              </div>
            `;
            accordionContainer.appendChild(accordionItem);
          });

          // Then populate each month's data as it arrives
          months.forEach((month) => {
            const monthKey = `${month.toLowerCase()}${currentYear}`;
            const tableId = `monthly-stats-table-${monthKey}`;

            // Get monthly data
            database
              .ref(`monthlyData/${monthKey}`)
              .once("value", (monthlySnapshot) => {
                const monthlyData = monthlySnapshot.val() || {
                  total: 0,
                  complaints: 0,
                  proposals: 0,
                  invitations: 0,
                  requests: 0,
                  entries: [],
                };

                // Get entries for this month
                const monthEntries = monthlyData.entries
                  .map((key) => {
                    const entry = entries[key];
                    return entry ? { key, ...entry } : null;
                  })
                  .filter((entry) => entry && entry.status !== "Archived");

                // Calculate statistics including archived entries
                const stats = {
                  complaints: 0,
                  proposals: 0,
                  invitations: 0,
                  requests: 0,
                  total: 0
                };

                // Count only non-archived entries
                monthlyData.entries.forEach(key => {
                  const entry = entries[key];
                  if (entry && entry.status !== "Archived") {
                    stats.total++;
                    const type = entry.type.toLowerCase();
                    if (type === 'complaint') stats.complaints++;
                    else if (type === 'proposal') stats.proposals++;
                    else if (type === 'invitation') stats.invitations++;
                    else if (type === 'request') stats.requests++;
                  }
                });

                // Sort entries by date
                monthEntries.sort((a, b) => {
                  return new Date(b.dateReceived) - new Date(a.dateReceived);
                });

                // Update the accordion item with the data
                const accordionBody = document.querySelector(
                  `#${monthKey} .accordion-body`
                );
                if (accordionBody) {
                  accordionBody.innerHTML = `
                  <!-- ${month} Statistics -->
                  <div class="row mb-4">
                    <div class="col-md-3">
                      <div class="card bg-primary bg-opacity-10">
                        <div class="card-body">
                          <h6 class="card-title text-primary">Complaints</h6>
                          <h2 class="card-text">${stats.complaints}</h2>
                          <div class="d-flex align-items-center">
                            <span class="trend-indicator trend-up text-primary">
                              <i class="bi bi-arrow-up me-1"></i>0%
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="card bg-warning bg-opacity-10">
                        <div class="card-body">
                          <h6 class="card-title text-warning">Proposals</h6>
                          <h2 class="card-text">${stats.proposals}</h2>
                          <div class="d-flex align-items-center">
                            <span class="trend-indicator trend-up text-warning">
                              <i class="bi bi-arrow-up me-1"></i>0%
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="card bg-info bg-opacity-10">
                        <div class="card-body">
                          <h6 class="card-title text-info">Invitations</h6>
                          <h2 class="card-text">${stats.invitations}</h2>
                          <div class="d-flex align-items-center">
                            <span class="trend-indicator trend-up text-info">
                              <i class="bi bi-arrow-up me-1"></i>0%
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="card bg-warning bg-opacity-10">
                        <div class="card-body">
                          <h6 class="card-title text-success">Requests</h6>
                          <h2 class="card-text">${stats.requests}</h2>
                          <div class="d-flex align-items-center">
                            <span class="trend-indicator trend-up text-success">
                              <i class="bi bi-arrow-up me-1"></i>0%
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="table-responsive">
                     <div class="d-flex justify-content-between align-items-center mb-3">
                      <div class="input-group" style="width: 300px;">
                        <span class="input-group-text">
                          <i class="bi bi-search"></i>
                        </span>
                        <input type="text" class="form-control" id="search${monthKey}" placeholder="Search entries...">
                      </div>
                    </div>

                    <table class="table table-hover monthly-stats-table" id="monthly-stats-table-${monthKey}">
                      <thead>
                        <tr>
                          <th>Control #</th>
                          <th>Type</th>
                          <th>Time Received</th>
                          <th>Date Received</th>
                          <th>From</th>
                          <th>Office</th>
                          <th>Subject</th>
                          <th>Endorsed To</th>
                          <th>Remarks</th>
                          <th>Status</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                      </tbody>
                    </table>
                  </div>
                `;

                setTimeout(() => {
                    try {
                      console.log(`Initializing table for ${month} with data:`, monthEntries);
                      initializeDataTable(monthKey, tableId, monthEntries);
                    } catch (error) {
                      console.error(`Error initializing DataTable for ${month}:`, error);
                    }
                  }, 100);
                }
              });
          });
        });

        setTimeout(initializeSearch, 500);

      }

      // Function to get status color
      function getStatusColor(status) {
        switch (status) {
          case "Pending":
            return "warning";
          case "Processing":
            return "info";
          case "Completed":
            return "success";
          case "Archived":
            return "secondary";
          default:
            return "primary";
        }
      }

      // Function to format date
      function formatDate(dateString) {
        try {
          const date = new Date(dateString);
          if (isNaN(date.getTime())) {
            return dateString;
          }
          return date.toLocaleDateString("en-US", {
            year: "numeric",
            month: "long",
            day: "numeric",
          });
        } catch (error) {
          console.error("Error formatting date:", error);
          return dateString;
        }
      }

      // Function to log activity
      function logActivity(action, details, controlNumber) {
        const user = firebase.auth().currentUser;
        const logData = {
          timestamp: firebase.database.ServerValue.TIMESTAMP,
          user: user ? user.email : "admin@centralcomm.com",
          action: action,
          details: details,
          controlNumber: controlNumber,
          ipAddress: "127.0.0.1", // Replace with actual IP when available
        };

        database
          .ref("logs")
          .push(logData)
          .catch((error) => {
            console.error("Error logging activity:", error);
          });
      }

      // Function to show success alert
      function showSuccessAlert(message) {
        Swal.fire({
          title: "Success!",
          text: message,
          icon: "success",
          confirmButtonColor: "#2e7d32",
          timer: 2000,
          timerProgressBar: true,
        });
      }

      // Function to show error alert
      function showErrorAlert(message) {
        Swal.fire({
          title: "Error!",
          text: message,
          icon: "error",
          confirmButtonColor: "#dc3545",
        });
      }

      // Function to show confirmation dialog
      function showConfirmDialog(title, text, confirmButtonText) {
        return Swal.fire({
          title: title,
          text: text,
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#002C75",
          cancelButtonColor: "#dc3545",
          confirmButtonText: confirmButtonText,
        });
      }

      // Update delete entry function
      function deleteEntry(key) {
        showConfirmDialog(
          "Are you sure?",
          "You won't be able to revert this!",
          "Yes, delete it!"
        ).then((result) => {
          if (result.isConfirmed) {
            entriesRef.child(key).once("value", (snapshot) => {
              const entry = snapshot.val();
              entriesRef
                .child(key)
                .remove()
                .then(() => {
                  // Log the deletion in history
                  const logData = {
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    user: "Admin", // Replace with actual user when authentication is implemented
                    action: "delete",
                    details: `Deleted entry: ${entry.subject}`,
                    controlNumber: entry.controlNumber,
                    ipAddress: "127.0.0.1", // Replace with actual IP when available
                    userAgent: navigator.userAgent,
                  };

                  database
                    .ref("logs")
                    .push(logData)
                    .then(() => {
                      showSuccessAlert("Entry deleted successfully!");
                    })
                    .catch((error) => {
                      console.error("Error logging deletion:", error);
                      showErrorAlert(
                        "Entry deleted but failed to log the action."
                      );
                    });
                })
                .catch((error) => {
                  console.error("Error deleting entry:", error);
                  showErrorAlert("Error deleting entry. Please try again.");
                });
            });
          }
        });
      }

      // Function to archive all entries
      function archiveAllEntries() {
        showConfirmDialog(
          "Archive All Entries",
          "Are you sure you want to archive all entries? This action cannot be undone.",
          "Yes, archive all!"
        ).then((result) => {
          if (result.isConfirmed) {
            // Show initial loading state
            Swal.fire({
              title: "Preparing to Archive",
              text: "Please wait while we prepare to archive entries...",
              allowOutsideClick: false,
              didOpen: () => {
                Swal.showLoading();
              },
            });

            entriesRef
              .once("value", (snapshot) => {
                const entries = snapshot.val();
                if (entries) {
                  let archivedCount = 0;
                  let totalToArchive = 0;

                  // First count how many entries need to be archived
                  Object.entries(entries).forEach(([_, entry]) => {
                    if (entry.status !== "Archived") {
                      totalToArchive++;
                    }
                  });

                  if (totalToArchive === 0) {
                    Swal.fire({
                      title: "No Entries to Archive",
                      text: "There are no entries available to archive.",
                      icon: "info",
                      confirmButtonColor: "#002C75",
                    });
                    return;
                  }

                  // Update loading message
                  Swal.update({
                    title: "Archiving Entries",
                    html: `Archiving ${totalToArchive} entries...<br><br>
                          <div class="progress" style="height: 20px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: 0%" 
                                 id="archiveProgress">
                              0%
                            </div>
                          </div>`,
                  });

                  // Archive each entry
                  Object.entries(entries).forEach(([key, entry]) => {
                    if (entry.status !== "Archived") {
                      entriesRef
                        .child(key)
                        .update({
                          status: "Archived",
                          archivedAt: firebase.database.ServerValue.TIMESTAMP,
                        })
                        .then(() => {
                          archivedCount++;
                          logActivity(
                            "archive",
                            `Archived entry: ${entry.subject}`,
                            entry.controlNumber
                          );

                          // Update progress bar
                          const progress = Math.round(
                            (archivedCount / totalToArchive) * 100
                          );
                          document.getElementById(
                            "archiveProgress"
                          ).style.width = `${progress}%`;
                          document.getElementById(
                            "archiveProgress"
                          ).textContent = `${progress}%`;

                          // Update progress
                          if (archivedCount === totalToArchive) {
                            Swal.fire({
                              title: "Success!",
                              text: `Successfully archived ${archivedCount} entries!`,
                              icon: "success",
                              confirmButtonColor: "#002C75",
                            }).then(() => {
                              loadEntries();
                            });
                          }
                        })
                        .catch((error) => {
                          console.error("Error archiving entry:", error);
                          Swal.fire({
                            title: "Error!",
                            text: "Error archiving entries. Please try again.",
                            icon: "error",
                            confirmButtonColor: "#dc3545",
                          });
                        });
                    }
                  });
                } else {
                  Swal.fire({
                    title: "No Entries Found",
                    text: "There are no entries in the database.",
                    icon: "info",
                    confirmButtonColor: "#002C75",
                  });
                }
              })
              .catch((error) => {
                console.error("Error preparing to archive:", error);
                Swal.fire({
                  title: "Error!",
                  text: "Error preparing to archive entries. Please try again.",
                  icon: "error",
                  confirmButtonColor: "#dc3545",
                });
              });
          }
        });
      }

      // Update restore entry function
      function restoreEntry(key) {
        showConfirmDialog(
          "Restore Entry",
          "Are you sure you want to restore this entry?",
          "Yes, restore it!"
        ).then((result) => {
          if (result.isConfirmed) {
            // First get the entry details to log the control number
            entriesRef.child(key).once("value", (snapshot) => {
              const entry = snapshot.val();
              if (entry) {
                entriesRef
                  .child(key)
                  .update({
                    status: "Pending",
                    restoredAt: firebase.database.ServerValue.TIMESTAMP,
                  })
                  .then(() => {
                    logActivity("restore", `Restored archived entry: ${entry.subject}`, entry.controlNumber);
                    showSuccessAlert("Entry restored successfully!");
                    loadArchivedEntries();
                  })
                  .catch((error) => {
                    console.error("Error restoring entry:", error);
                    showErrorAlert("Error restoring entry. Please try again.");
                  });
              }
            });
          }
        });
      }

      // Save entry form submission
      document.getElementById("saveEntry").addEventListener("click", function() {
        const formData = {
          type: document.getElementById("letterType").value,
          dateReceived: document.getElementById("dateReceived").value,
          timeReceived: document.getElementById("timeReceived").value,
          from: document.getElementById("from").value,
          office: document.getElementById("office").value,
          subject: document.getElementById("subject").value,
          status: document.getElementById("status").value, // Get the selected status
          createdAt: firebase.database.ServerValue.TIMESTAMP,
        };

        // Validate required fields
        if (!formData.type || !formData.dateReceived || !formData.timeReceived || 
            !formData.from || !formData.office || !formData.subject || !formData.status) {
          showErrorAlert("Please fill in all required fields");
          return;
        }

        // Generate control number and save entry
        generateControlNumber().then(controlNumber => {
          formData.controlNumber = controlNumber;

          // Get the month and year for monthly data
          const entryDate = new Date(formData.dateReceived);
          const month = entryDate.toLocaleString("default", { month: "long" }).toLowerCase();
          const year = entryDate.getFullYear();
          const monthKey = `${month}${year}`;

          // Save the entry
          entriesRef.push(formData)
            .then((ref) => {
              // Save monthly data
              const monthlyRef = database.ref(`monthlyData/${monthKey}`);
              monthlyRef.once("value", (snapshot) => {
                const monthlyData = snapshot.val() || {
                  total: 0,
                  complaints: 0,
                  proposals: 0,
                  invitations: 0,
                  requests: 0,
                  entries: [],
                };

                // Update monthly statistics
                monthlyData.total++;
                monthlyData[formData.type.toLowerCase() + "s"]++;
                monthlyData.entries.push(ref.key);

                // Save updated monthly data
                monthlyRef.set(monthlyData)
                  .then(() => {
                    logActivity(
                      "create",
                      `Created new entry: ${formData.subject}`,
                      formData.controlNumber
                    );

                    // Reset form and update status options
                    document.getElementById("createEntryForm").reset();
                    updateStatusOptions(document.getElementById("letterType").value);

                    // Set current date and time
                    const now = new Date();
                    const currentDate = now.toISOString().split("T")[0];
                    const currentTime = now.toTimeString().slice(0, 5);
                    document.getElementById("dateReceived").value = currentDate;
                    document.getElementById("timeReceived").value = currentTime;

                    // Show success message
                    showSuccessAlert("Entry created successfully!");

                    // Close modal
                    const modal = bootstrap.Modal.getInstance(
                      document.getElementById("createEntryModal")
                    );
                    modal.hide();

                    // Reload entries
                    loadEntries();

                    // Open the relevant month's accordion
                    setTimeout(() => {
                      const accordionButton = document.querySelector(
                        `button[data-bs-target="#${monthKey}"]`
                      );
                      if (accordionButton) {
                        accordionButton.click();
                      }
                    }, 500);
                  })
                  .catch((error) => {
                    console.error("Error saving monthly data:", error);
                    showErrorAlert("Error saving monthly data. Please try again.");
                  });
              });
            })
            .catch((error) => {
              console.error("Error creating entry:", error);
              showErrorAlert("Error creating entry. Please try again.");
            });
        });
      });

      // Update edit entry handler
      document.getElementById("updateEntry").addEventListener("click", function() {
        const key = document.getElementById("editEntryForm").dataset.key;
        const formData = {
          type: document.getElementById("editType").value,
          controlNumber: document.getElementById("editControlNumber").value,
          dateReceived: document.getElementById("editDateReceived").value,
          timeReceived: document.getElementById("editTimeReceived").value,
          from: document.getElementById("editFrom").value,
          office: document.getElementById("editOffice").value,
          subject: document.getElementById("editSubject").value,
          endorsedTo: document.getElementById("editEndorsedTo").value,
          remarks: document.getElementById("editRemarks").value,
          status: document.getElementById("editStatus").value,
          updatedAt: firebase.database.ServerValue.TIMESTAMP,
        };

        // Validate required fields
        if (!formData.type || !formData.dateReceived || !formData.timeReceived || 
            !formData.from || !formData.office || !formData.subject || !formData.status) {
          showErrorAlert("Please fill in all required fields");
          return;
        }

        entriesRef.child(key)
          .update(formData)
          .then(() => {
            logActivity(
              "update",
              `Updated entry: ${formData.subject}`,
              formData.controlNumber
            );

            showSuccessAlert("Entry updated successfully!");
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("editEntryModal")
            );
            modal.hide();

            const entryDate = new Date(formData.dateReceived);
            const monthKey = entryDate.toLocaleString("default", { month: "long" }).toLowerCase() + entryDate.getFullYear();
            loadEntries();
            setTimeout(() => {
              const accordionButton = document.querySelector(
                `button[data-bs-target="#${monthKey}"]`
              );
              if (accordionButton) {
                accordionButton.click();
              }
            }, 500);
          })
          .catch((error) => {
            console.error("Error updating entry:", error);
            showErrorAlert("Error updating entry. Please try again.");
          });
      });

      // Update profile form submission
      document.getElementById("profileForm").addEventListener("submit", function (e) {
          e.preventDefault();
        const user = firebase.auth().currentUser;
        if (!user) return;

          const profileData = {
            firstName: document.getElementById("firstName").value,
            lastName: document.getElementById("lastName").value,
            email: document.getElementById("email").value,
            phone: document.getElementById("phone").value,
            department: document.getElementById("department").value,
            position: document.getElementById("position").value,
          role: document.getElementById("role").value,
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
          };

        // Update user data in database
        database.ref("users/" + user.uid).update(profileData)
            .then(() => {
            // Update the displayed user info
            document.getElementById("profileName").textContent = `${profileData.firstName} ${profileData.lastName}`;
            document.getElementById("profileRole").textContent = profileData.role;
            document.getElementById("currentUserName").textContent = `${profileData.firstName} ${profileData.lastName}`;
            document.getElementById("currentUserRole").textContent = profileData.role;
            
              showSuccessAlert("Profile updated successfully!");
            logActivity("profile_update", "Updated profile information", user.uid);
            })
            .catch((error) => {
              console.error("Error updating profile:", error);
              showErrorAlert("Error updating profile. Please try again.");
            });
        });

      // Update password change form submission
      document.getElementById("passwordForm").addEventListener("submit", function (e) {
          e.preventDefault();
        const user = firebase.auth().currentUser;
        if (!user) return;

        const currentPassword = document.getElementById("currentPassword").value;
          const newPassword = document.getElementById("newPassword").value;
        const confirmPassword = document.getElementById("confirmPassword").value;

          if (newPassword !== confirmPassword) {
            showErrorAlert("New passwords do not match!");
            return;
          }

        // Reauthenticate user before changing password
        const credential = firebase.auth.EmailAuthProvider.credential(
          user.email,
          currentPassword
        );

        user.reauthenticateWithCredential(credential)
          .then(() => {
            return user.updatePassword(newPassword);
          })
          .then(() => {
          showSuccessAlert("Password updated successfully!");
            logActivity("password_change", "Changed password", user.uid);
          document.getElementById("passwordForm").reset();
          })
          .catch((error) => {
            console.error("Error changing password:", error);
            showErrorAlert("Error changing password. Please try again.");
          });
        });


      // Edit entry function
      function editEntry(key) {
        entriesRef.child(key).once("value", (snapshot) => {
          const entry = snapshot.val();
          if (entry) {
            // Set the type first
            document.getElementById("editType").value = entry.type;
            
            // Update status options based on the type
            updateStatusOptions(entry.type);
            
            // Then set the status
            document.getElementById("editStatus").value = entry.status;
            
            // Set other fields
            document.getElementById("editControlNumber").value = entry.controlNumber;
            document.getElementById("editDateReceived").value = entry.dateReceived;
            document.getElementById("editTimeReceived").value = entry.timeReceived;
            document.getElementById("editFrom").value = entry.from;
            document.getElementById("editOffice").value = entry.office;
            document.getElementById("editSubject").value = entry.subject;
            document.getElementById("editEndorsedTo").value = entry.endorsedTo;
            document.getElementById("editRemarks").value = entry.remarks || "";

            // Store the key for updating
            document.getElementById("editEntryForm").dataset.key = key;
          }
        });
      }

      // Update control number when date changes in create form
      document
        .getElementById("dateReceived")
        .addEventListener("change", function () {
          const controlNumber = generateControlNumber(this.value);
          document.getElementById("controlNumber").value = controlNumber;
        });

      // Update control number when date changes in edit form
      document
        .getElementById("editDateReceived")
        .addEventListener("change", function () {
          const controlNumber = generateControlNumber(this.value);
          document.getElementById("editControlNumber").value = controlNumber;
        });

      // Set current time when modal opens
      document
        .getElementById("createEntryModal")
        .addEventListener("show.bs.modal", function () {
          const now = new Date();
          const currentDate = now.toISOString().split("T")[0];
          const currentTime = now.toTimeString().slice(0, 5);

          document.getElementById("dateReceived").value = currentDate;
          document.getElementById("timeReceived").value = currentTime;
          
          // Show the next control number without incrementing
          getNextControlNumber().then(controlNumber => {
            document.getElementById("controlNumber").value = controlNumber;
          });
        });

      // Load entries and check for archiving when page loads
      document.addEventListener("DOMContentLoaded", function () {
        checkAndArchiveEntries();
        loadEntries();
      });

      // Function to load archived entries
      function loadArchivedEntries() {
        // Show loading state
        Swal.fire({
          title: "Loading Archived Entries",
          text: "Please wait...",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        entriesRef.once("value", (snapshot) => {
          const entries = snapshot.val();
          const archivedYearsContainer = document.getElementById("archivedYearsContainer");
          archivedYearsContainer.innerHTML = "";

          if (entries) {
            // Group entries by year
            const entriesByYear = {};
            Object.entries(entries).forEach(([key, entry]) => {
              if (entry.status === "Archived") {
                const year = new Date(entry.dateReceived).getFullYear();
                if (!entriesByYear[year]) {
                  entriesByYear[year] = [];
                }
                entriesByYear[year].push({ key, ...entry });
              }
            });

            // Sort years in descending order
            const years = Object.keys(entriesByYear).sort((a, b) => b - a);

            // Add year selector
            const yearSelector = document.createElement("div");
            yearSelector.className = "mb-3";
            yearSelector.innerHTML = `
              <div class="d-flex align-items-center">
                <label for="archiveYearSelect" class="form-label me-2 mb-0">Select Year:</label>
                <select class="form-select w-auto" id="archiveYearSelect">
                  ${years.map(year => `<option value="${year}">${year}</option>`).join('')}
                </select>
              </div>
            `;
            archivedYearsContainer.appendChild(yearSelector);

            // Create accordion for each year
            years.forEach((year) => {
              const yearEntries = entriesByYear[year];
              const yearAccordion = document.createElement("div");
              yearAccordion.className = "col-12 mb-4";
              yearAccordion.id = `year-${year}`;
              yearAccordion.style.display = year === getCurrentYear().toString() ? 'block' : 'none';
              yearAccordion.innerHTML = `
                <div class="card">
                  <div class="card-header">
                    <h5 class="card-title mb-0">${year}</h5>
                  </div>
                  <div class="card-body">
                    <div class="table-responsive">
                      <table class="table table-hover archived-entries-table" id="archivedTable${year}">
                        <thead>
                          <tr>
                            <th>Control #</th>
                            <th>Type</th>
                            <th>Time Received</th>
                            <th>Date Received</th>
                            <th>From</th>
                            <th>Office</th>
                            <th>Subject</th>
                            <th>Endorsed To</th>
                            <th>Remarks</th>
                            <th>Status</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${yearEntries.map((entry) => `
                            <tr>
                              <td>${entry.controlNumber}</td>
                              <td>${entry.type}</td>
                              <td>${entry.timeReceived}</td>
                              <td>${formatDate(entry.dateReceived)}</td>
                              <td>${entry.from}</td>
                              <td>${entry.office}</td>
                              <td>${entry.subject}</td>
                              <td>${entry.endorsedTo}</td>
                              <td>${entry.remarks || ""}</td>
                              <td><span class="badge bg-secondary">Archived</span></td>
                              <td>
                                <button class="btn btn-sm btn-info" onclick="viewArchivedEntry('${entry.key}')">
                                  <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="restoreEntry('${entry.key}')">
                                  <i class="bi bi-arrow-counterclockwise"></i>
                                </button>
                              </td>
                            </tr>
                          `).join("")}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              `;
              archivedYearsContainer.appendChild(yearAccordion);

              // Initialize DataTable for this year's entries
              $(`#archivedTable${year}`).DataTable({
                dom: "Bfrtip",
                buttons: [
                  { extend: 'copy', className: 'btn btn-sm' },
                  { extend: 'csv', className: 'btn btn-sm' },
                  { extend: 'excel', className: 'btn btn-sm' },
                  { extend: 'pdf', className: 'btn btn-sm' },
                  { extend: 'print', className: 'btn btn-sm' }
                ],
                pageLength: 10,
                order: [[3, "desc"]],
                destroy: true,
                language: {
                  search: "Search entries:",
                },
              });
            });

            // Add event listener for year selector
            document.getElementById("archiveYearSelect").addEventListener("change", function() {
              const selectedYear = this.value;
              years.forEach(year => {
                const yearElement = document.getElementById(`year-${year}`);
                if (yearElement) {
                  yearElement.style.display = year === selectedYear ? 'block' : 'none';
                }
              });
            });

            if (years.length === 0) {
              archivedYearsContainer.innerHTML = `
                <div class="col-12 text-center">
                  <p class="text-muted">No archived entries found.</p>
                </div>
              `;
            }
          }

          // Close loading state
          Swal.close();
        }).catch((error) => {
          console.error("Error loading archived entries:", error);
          Swal.close();
          showErrorAlert("Error loading archived entries. Please try again.");
        });
      }

      // Function to view archived entry details
      function viewArchivedEntry(key) {
        entriesRef.child(key).once("value", (snapshot) => {
          const entry = snapshot.val();
          if (entry) {
            // Show entry details in a modal
            const modal = new bootstrap.Modal(
              document.getElementById("viewArchivedModal")
            );
            document
              .getElementById("viewArchivedModal")
              .querySelector(".modal-body").innerHTML = `
              <div class="row mb-3">
                <div class="col-md-6">
                  <strong>Control Number:</strong> ${entry.controlNumber}
                </div>
                <div class="col-md-6">
                  <strong>Type:</strong> ${entry.type}
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <strong>Date Received:</strong> ${formatDate(
                    entry.dateReceived
                  )}
                </div>
                <div class="col-md-6">
                  <strong>Time Received:</strong> ${entry.timeReceived}
                </div>
              </div>
              <div class="row mb-3">
              <div class="col-md-6">
                <strong>From:</strong> ${entry.from}
              </div>
              <div class="col-md-6">
                <strong>Office:</strong> ${entry.office}
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6 onset-md-6">
                <strong>Archived On:</strong> ${entry.archivedOn}
              </div>
            </div>
            <div class="mb-3">
              <strong>Subject:</strong> ${entry.subject}
            </div>
            <div class="mb-3">
              <strong>Endorsed To:</strong> ${entry.endorsedTo}
            </div>
            <div class="mb-3">
              <strong>Remarks:</strong> ${entry.remarks || "None"}
            </div>
              
            `;
            modal.show();
          }
        });
      }

      // Function to handle navigation
      function handleNavigation(sectionId) {
        // Hide all sections
        document.querySelectorAll(".main-content > div").forEach((section) => {
          section.classList.add("d-none");
        });

        // Show selected section
        document.getElementById(sectionId).classList.remove("d-none");

        // Update active state in sidebar
        document.querySelectorAll(".nav-link").forEach((link) => {
          link.classList.remove("active");
        });
        document
          .querySelector(`#${sectionId.replace("Section", "Link")}`)
          .classList.add("active");

        // Load section-specific data
        switch (sectionId) {
          case "documentsSection":
            loadDocuments();
            break;
          case "usersSection":
            loadUsers();
            break;
          case "archivesSection":
            loadArchivedEntries();
            break;
          case "historySection":
            loadHistory();
            break;
          case "profileSection":
            loadProfile();
            break;
          default:
            loadEntries();
        }
      }

      // Add event listeners for navigation
      document
        .getElementById("dashboardLink")
        .addEventListener("click", function (e) {
          e.preventDefault();
          handleNavigation("dashboardSection");
        });

      document
        .getElementById("documentsLink")
        .addEventListener("click", function (e) {
          e.preventDefault();
          handleNavigation("documentsSection");
        });

      document
        .getElementById("usersLink")
        .addEventListener("click", function (e) {
          e.preventDefault();
          handleNavigation("usersSection");
        });

      document
        .getElementById("archivesLink")
        .addEventListener("click", function (e) {
          e.preventDefault();
          handleNavigation("archivesSection");
        });

      document
        .getElementById("historyLink")
        .addEventListener("click", function (e) {
          e.preventDefault();
          handleNavigation("historySection");
        });

      document
        .getElementById("profileLink")
        .addEventListener("click", function (e) {
          e.preventDefault();
          handleNavigation("profileSection");
        });

      // Function to load documents
      function loadDocuments() {
        entriesRef.once("value", (snapshot) => {
          const entries = snapshot.val();
          const currentYear = new Date().getFullYear();
          const currentMonth = new Date().getMonth();

          // Initialize statistics
          const yearlyStats = {
            total: 0,
            complaints: 0,
            requests: 0,
            proposals: 0,
            invitations: 0,
          };

          const monthlyStats = {
            total: 0,
            dailyAverage: 0,
            highestVolume: { month: "", count: 0 },
            lowestVolume: { month: "", count: Infinity },
          };

          const monthlyData = Array(12).fill(0);

          if (entries) {
            Object.entries(entries).forEach(([_, entry]) => {
              const entryDate = new Date(entry.dateReceived);
              const entryYear = entryDate.getFullYear();
              const entryMonth = entryDate.getMonth();

              // Yearly statistics
              if (entryYear === currentYear) {
                yearlyStats.total++;
                yearlyStats[entry.type.toLowerCase() + "s"]++;

                // Monthly statistics
                if (entryMonth === currentMonth) {
                  monthlyStats.total++;
                }
                monthlyData[entryMonth]++;
              }
            });

            // Calculate monthly statistics
            const nonZeroMonths = monthlyData.filter((count) => count > 0);
            monthlyStats.dailyAverage =
              nonZeroMonths.length > 0
                ? Math.round(
                    nonZeroMonths.reduce((a, b) => a + b, 0) /
                      nonZeroMonths.length
                  )
                : 0;

            monthlyData.forEach((count, month) => {
              if (count > monthlyStats.highestVolume.count) {
                monthlyStats.highestVolume = {
                  month: new Date(2000, month).toLocaleString("default", {
                    month: "long",
                  }),
                  count: count,
                };
              }
              if (count < monthlyStats.lowestVolume.count && count > 0) {
                monthlyStats.lowestVolume = {
                  month: new Date(2000, month).toLocaleString("default", {
                    month: "long",
                  }),
                  count: count,
                };
              }
            });
          }

          // Update yearly statistics
          document.getElementById("yearlyTotal").textContent =
            yearlyStats.total;
          document.getElementById("yearlyComplaints").textContent =
            yearlyStats.complaints;
          document.getElementById("yearlyRequests").textContent =
            yearlyStats.requests;
          document.getElementById("yearlyProposals").textContent =
            yearlyStats.proposals;
          document.getElementById("yearlyInvitations").textContent =
            yearlyStats.invitations;

          // Update monthly statistics
          document.getElementById("monthlyTotal").textContent =
            monthlyStats.total;
          document.getElementById("avgDailyLetters").textContent =
            monthlyStats.dailyAverage;
          document.getElementById(
            "highestVolumeMonth"
          ).textContent = `${monthlyStats.highestVolume.month} (${monthlyStats.highestVolume.count})`;
          document.getElementById(
            "lowestVolumeMonth"
          ).textContent = `${monthlyStats.lowestVolume.month} (${monthlyStats.lowestVolume.count})`;

          // Create monthly letters chart
          const monthlyCtx = document
            .getElementById("monthlyLettersChart")
            .getContext("2d");
          new Chart(monthlyCtx, {
            type: "line",
            data: {
              labels: [
                "January",
                "February",
                "March",
                "April",
                "May",
                "June",
                "July",
                "August",
                "September",
                "October",
                "November",
                "December",
              ],
              datasets: [
                {
                  label: "Letters Received",
                  data: monthlyData,
                  borderColor: "#002C75",
                  backgroundColor: "rgba(46, 125, 50, 0.1)",
                  tension: 0.4,
                  fill: true,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  display: false,
                },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    stepSize: 1,
                  },
                },
              },
            },
          });
        });
      }

      // Function to load users
      function loadUsers() {
        // Check if DataTable is already initialized
        if ($.fn.DataTable.isDataTable("#usersTable")) {
          $("#usersTable").DataTable().destroy();
        }

        // Show loading state
        Swal.fire({
          title: "Loading Users",
          text: "Please wait...",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        database
          .ref("users")
          .once("value", (snapshot) => {
            const users = snapshot.val();
            const tbody = document.querySelector("#usersTable tbody");
            tbody.innerHTML = "";

            if (users) {
              Object.entries(users).forEach(([key, user]) => {
                if (key !== "admin") {
                  // Skip the admin user
                  const row = document.createElement("tr");
                  row.innerHTML = `
                  <td>${user.firstName} ${user.lastName}</td>
                  <td>${user.email}</td>
                  <td>${user.role}</td>
                  <td><span class="badge bg-warning">Active</span></td>
                  <td>
                    <button class="btn btn-sm btn-primary" onclick="editUser('${key}')">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteUser('${key}')">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                `;
                  tbody.appendChild(row);
                }
              });
            }

            // Initialize DataTable
            $("#usersTable").DataTable({
              dom: "Bfrtip",
              buttons: [
                { extend: 'copy', className: 'btn btn-sm' },
                { extend: 'csv', className: 'btn btn-sm' },
                { extend: 'excel', className: 'btn btn-sm' },
                { extend: 'pdf', className: 'btn btn-sm' },
                { extend: 'print', className: 'btn btn-sm' }
              ],
              pageLength: 10,
              order: [[0, "asc"]],
              destroy: true,
              language: {
                search: "Search users:",
              },
            });

            // Close loading state
            Swal.close();
          })
          .catch((error) => {
            console.error("Error loading users:", error);
            Swal.close();
            showErrorAlert("Error loading users. Please try again.");
          });
      }

      // Function to load history
      function loadHistory() {
        // Check if DataTable is already initialized
        if ($.fn.DataTable.isDataTable("#historyTable")) {
          $("#historyTable").DataTable().destroy();
        }

        // Show loading state
        Swal.fire({
          title: "Loading History",
          text: "Please wait...",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        database
          .ref("logs")
          .on("value", (snapshot) => {
            const logs = snapshot.val();
            const tbody = document.querySelector("#historyTable tbody");
            tbody.innerHTML = "";

            if (logs) {
              Object.entries(logs).forEach(([key, log]) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                <td>${formatDate(log.timestamp)}</td>
                <td>${log.user}</td>
                <td>${log.action}</td>
                <td>${log.details}</td>
                <td>${log.controlNumber || "-"}</td>
              `;
                tbody.appendChild(row);
              });
            }

            // Initialize DataTable
            $("#historyTable").DataTable({
              dom: "Bfrtip",
              buttons: [
                { extend: 'copy', className: 'btn btn-sm' },
                { extend: 'csv', className: 'btn btn-sm' },
                { extend: 'excel', className: 'btn btn-sm' },
                { extend: 'pdf', className: 'btn btn-sm' },
                { extend: 'print', className: 'btn btn-sm' }
              ],
              pageLength: 10,
              order: [[0, "desc"]],
              destroy: true,
              language: {
                search: "Search history:",
              },
              columnDefs: [
                { width: "20%", targets: 0 },
                { width: "15%", targets: 1 },
                { width: "15%", targets: 2 },
                { width: "35%", targets: 3 },
                { width: "15%", targets: 4 }
              ],
            });

            // Close loading state
            Swal.close();
          })
          .catch((error) => {
            console.error("Error loading history:", error);
            Swal.close();
            showErrorAlert("Error loading history. Please try again.");
          });
      }

      // Function to view audit log details
      function viewAuditLog(key, log) {
        const modal = new bootstrap.Modal(
          document.getElementById("viewAuditLogModal")
        );

        // Format timestamp
        const timestamp = new Date(log.timestamp);
        const formattedTimestamp = timestamp.toLocaleString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });

        // Update modal content
        document.getElementById("auditTimestamp").textContent =
          formattedTimestamp;
        document.getElementById("auditUser").textContent = log.user;
        document.getElementById("auditAction").textContent = log.action;
        document.getElementById("auditControlNumber").textContent =
          log.controlNumber || "-";
        document.getElementById("auditDetails").textContent = log.details;

        // Show modal
        modal.show();
      }

      // Function to load profile
      function loadProfile() {
        const user = firebase.auth().currentUser;
        if (!user) return;

        // Show loading state
        Swal.fire({
          title: "Loading Profile",
          text: "Please wait...",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        // Fetch user data from database
        database.ref('users/' + user.uid).once('value').then((snapshot) => {
          const userData = snapshot.val();
          if (userData) {
            // Update profile information
            document.getElementById("profileName").textContent = `${userData.firstName} ${userData.lastName}`;
            document.getElementById("profileRole").textContent = userData.role;
            
            // Update form fields
            document.getElementById("firstName").value = userData.firstName;
            document.getElementById("lastName").value = userData.lastName;
            document.getElementById("email").value = userData.email || "admin@centralcomm.com";
            document.getElementById("phone").value = userData.phone || "";
            document.getElementById("department").value = userData.department || "";
            document.getElementById("position").value = userData.position || "";
            
            // Set role and disable it if it exists
            const roleSelect = document.getElementById("role");
            if (userData.role) {
              roleSelect.value = userData.role;
              roleSelect.disabled = true;
            } else {
              roleSelect.disabled = false;
            }

            // Update profile image if available
            if (user.photoURL) {
              document.getElementById("profileImage").src = user.photoURL;
            }
          }
          Swal.close();
        }).catch((error) => {
          console.error("Error loading profile:", error);
          Swal.close();
          showErrorAlert("Error loading profile. Please try again.");
        });
      }

      // Initialize the dashboard on page load
      document.addEventListener("DOMContentLoaded", function () {
        handleNavigation("dashboardSection");
      });

      // Add event listener for the Archive All button
      document.addEventListener("DOMContentLoaded", function () {
        const archiveAllBtn = document.getElementById("archiveAllBtn");
        if (archiveAllBtn) {
          archiveAllBtn.addEventListener("click", archiveAllEntries);
        }
      });

      // Function to handle sign out
      function signOut() {
        showConfirmDialog(
          "Sign Out",
          "Are you sure you want to sign out?",
          "Yes, sign out"
        ).then((result) => {
          if (result.isConfirmed) {
            // Sign out from Firebase
            firebase
              .auth()
              .signOut()
              .then(() => {
                // Clear any session data
                sessionStorage.clear();
                localStorage.clear();

                // Redirect to selection page
                window.location.href = "../pages/selection.html";
              })
              .catch((error) => {
                console.error("Error signing out:", error);
                showErrorAlert("Error signing out. Please try again.");
              });
          }
        });
      }

      // Check authentication state
      firebase.auth().onAuthStateChanged((user) => {
        if (!user) {
          // If no user is signed in, redirect to selection page
          window.location.href = "../pages/selection.html";
        } else if (user) {
          // Set the current user's email
          document.getElementById("email").value = user.email || "";
          document.getElementById("currentUserEmail").textContent = user.email || "";
          
          // Fetch user details from database
          database.ref('users/' + user.uid).once('value').then((snapshot) => {
            const userData = snapshot.val();
            if (userData) {
              // Check if profile is complete (has first name, last name, and role)
              const isProfileComplete = userData.firstName && userData.lastName && userData.role;
              
              if (!isProfileComplete) {
                // Show profile completion modal
                Swal.fire({
                  title: 'Complete Your Profile',
                  html: `
                    <form id="initialProfileForm">
                      <div class="mb-3">
                        <label for="initialFirstName" class="form-label">First Name</label>
                        <input type="text" class="form-control" id="initialFirstName" required>
                      </div>
                      <div class="mb-3">
                        <label for="initialLastName" class="form-label">Last Name</label>
                        <input type="text" class="form-control" id="initialLastName" required>
                      </div>
                      <div class="mb-3">
                        <label for="initialRole" class="form-label">Role</label>
                        <select class="form-select" id="initialRole" required>
                          <option value="">Select Role</option>
                          <option value="Administrator">Administrator</option>
                          <option value="Staff">Staff</option>
                        </select>
                      </div>
                    </form>
                  `,
                  showCancelButton: false,
                  confirmButtonText: 'Save Profile',
                  confirmButtonColor: '#002C75',
                  allowOutsideClick: false,
                  preConfirm: () => {
                    const firstName = document.getElementById('initialFirstName').value;
                    const lastName = document.getElementById('initialLastName').value;
                    const role = document.getElementById('initialRole').value;
                    
                    if (!firstName || !lastName || !role) {
                      Swal.showValidationMessage('Please fill in all fields');
                      return false;
                    }
                    
                    return { firstName, lastName, role };
                  }
                }).then((result) => {
                  if (result.isConfirmed) {
                    const { firstName, lastName, role } = result.value;
                    
                    // Update user data in database
                    const updates = {
                      firstName: firstName,
                      lastName: lastName,
                      role: role,
                      updatedAt: firebase.database.ServerValue.TIMESTAMP
                    };
                    
                    database.ref('users/' + user.uid).update(updates)
                      .then(() => {
                        // Update user's display name in Firebase Auth
                        return user.updateProfile({
                          displayName: `${firstName} ${lastName}`
                        });
                      })
                      .then(() => {
                        // Update UI with new user info
                        document.getElementById("currentUserName").textContent = `${firstName} ${lastName}`;
                        document.getElementById("currentUserRole").textContent = role;
                        
                        // Show success message
                        Swal.fire({
                          title: 'Success!',
                          text: 'Profile completed successfully!',
                          icon: 'success',
                          confirmButtonColor: '#002C75'
                        });
                      })
                      .catch((error) => {
                        console.error("Error updating profile:", error);
                        showErrorAlert("Error updating profile. Please try again.");
                      });
                  }
                });
              } else {
                // Profile is complete, update UI normally
                document.getElementById("currentUserName").textContent = `${userData.firstName} ${userData.lastName}`;
                document.getElementById("currentUserRole").textContent = userData.role;
                
                // Update user avatar if available
                if (user.photoURL) {
                  document.getElementById("userAvatar").src = user.photoURL;
                }
              }
            }
          }).catch((error) => {
            console.error("Error fetching user data:", error);
            // Fallback to basic user info
            document.getElementById("currentUserName").textContent = user.displayName || user.email;
            document.getElementById("currentUserRole").textContent = "User";
          });
        }
      });

      // Function to create new user
      document.getElementById("saveUser").addEventListener("click", function () {
        const firstName = document.getElementById("newFirstName").value;
        const lastName = document.getElementById("newLastName").value;
        const email = document.getElementById("newEmail").value;
        const password = document.getElementById("newPassword").value;
        const confirmPassword = document.getElementById("confirmNewPassword").value;
        const role = document.getElementById("newRole").value;

        // Validate password match
        if (password !== confirmPassword) {
          Swal.fire({
            title: "Error!",
            text: "Passwords do not match!",
            icon: "error",
            confirmButtonColor: "#dc3545",
          });
          return;
        }

        // Validate password length
        if (password.length < 6) {
          Swal.fire({
            title: "Error!",
            text: "Password should be at least 6 characters long!",
            icon: "error",
            confirmButtonColor: "#dc3545",
          });
          return;
        }

        // Show loading state
        Swal.fire({
          title: "Creating user...",
          text: "Please wait while we create the user account",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        // Create user with Firebase Auth
        auth
          .createUserWithEmailAndPassword(email, password)
          .then((userCredential) => {
            const user = userCredential.user;

            // Store additional user data in Realtime Database
            const userData = {
              firstName: firstName,
              lastName: lastName,
              email: email,
              role: role,
              status: "active",
              createdAt: firebase.database.ServerValue.TIMESTAMP
            };

            // Save user data to database
            return database.ref('users/' + user.uid).set(userData)
              .then(() => {
                // Also update the user's display name in Firebase Auth
                return user.updateProfile({
                  displayName: `${firstName} ${lastName}`
                });
              });
          })
          .then(() => {
            // Show success message
            Swal.fire({
              title: "Success!",
              text: "User created successfully!",
              icon: "success",
              confirmButtonColor: "#002C75",
            }).then(() => {
              // Close modal
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("createUserModal")
              );
              modal.hide();

              // Reset form
              document.getElementById("createUserForm").reset();

              // Reload users table
              loadUsers();
            });
          })
          .catch((error) => {
            let errorMessage = "An error occurred while creating the user.";

            switch (error.code) {
              case "auth/email-already-in-use":
                errorMessage = "Email is already in use.";
                break;
              case "auth/invalid-email":
                errorMessage = "Invalid email format.";
                break;
              case "auth/weak-password":
                errorMessage = "Password should be at least 6 characters.";
                break;
              case "auth/operation-not-allowed":
                errorMessage = "User creation is currently disabled.";
                break;
            }

            // Show error message
            Swal.fire({
              title: "Error!",
              text: errorMessage,
              icon: "error",
              confirmButtonColor: "#dc3545",
            });
          });
      });

      // Function to update status options based on type
      function updateStatusOptions(type) {
        const statusSelect = document.getElementById("status");
        const editStatusSelect = document.getElementById("editStatus");
        
        // Clear existing options
        statusSelect.innerHTML = '';
        editStatusSelect.innerHTML = '';
        
        switch(type) {
          case "Complaint":
            // Complaint statuses
            const complaintStatuses = [
              { value: "Under Investigation", text: "Under Investigation (Ongoing)" },
              { value: "Inspection", text: "Inspection, Acted Upon (Done)" }
            ];
            addStatusOptions(complaintStatuses);
            break;
            
          case "Request":
            // Request statuses
            const requestStatuses = [
              { value: "For Review", text: "For Review and Approval (Ongoing)" },
              { value: "Request Granted", text: "Request Granted (Done)" }
            ];
            addStatusOptions(requestStatuses);
            break;
            
          case "Invitation":
            // Invitation statuses
            const invitationStatuses = [
              { value: "Calendar Pending", text: "To be placed in the calendar (Ongoing)" },
              { value: "Mayor Decision", text: "The mayor will accept/decline (Done)" }
            ];
            addStatusOptions(invitationStatuses);
            break;
            
          case "Proposal":
            // Proposal statuses
            const proposalStatuses = [
              { value: "Review Study", text: "For review and study (Ongoing)" },
              { value: "Decision Made", text: "Approve, please present your proposal/ disapprove, the city has already a working product/system (Done)" }
            ];
            addStatusOptions(proposalStatuses);
            break;
            
          default:
            // Regular status options for other types
            const regularStatuses = [
              { value: "Pending", text: "Pending" },
              { value: "Processing", text: "Processing" },
              { value: "Completed", text: "Completed" },
              { value: "Archived", text: "Archived" }
            ];
            addStatusOptions(regularStatuses);
        }
      }

      // Helper function to add status options to both select elements
      function addStatusOptions(statuses) {
        const statusSelect = document.getElementById("status");
        const editStatusSelect = document.getElementById("editStatus");
        
        statuses.forEach(status => {
          const option = new Option(status.text, status.value);
          const editOption = new Option(status.text, status.value);
          statusSelect.add(option);
          editStatusSelect.add(editOption);
        });
      }

      // Add event listeners for type changes
      document.getElementById("letterType").addEventListener("change", function() {
        updateStatusOptions(this.value);
      });

      document.getElementById("editType").addEventListener("change", function() {
        updateStatusOptions(this.value);
      });

      // Initialize status options based on initial type
      document.addEventListener("DOMContentLoaded", function() {
        const initialType = document.getElementById("letterType").value;
        updateStatusOptions(initialType);
      });

      // Add this function near the top of the script section
      function getCurrentYear() {
        return new Date().getFullYear();
      }

         // Function to handle search in accordion tables
         function initializeSearch() {
        const currentYear = getCurrentYear();
        const months = [
          "January", "February", "March", "April", "May", "June",
          "July", "August", "September", "October", "November", "December"
        ];

        months.forEach(month => {
          const monthKey = `${month.toLowerCase()}${currentYear}`;
          const searchInput = document.getElementById(`search${monthKey}`);
          const tableId = `monthly-stats-table-${monthKey}`;
          
          if (searchInput) {
            // Initialize DataTable for this month
            $(`#${tableId}`).DataTable({
              dom: "Bfrtip",
              buttons: [
                { extend: 'copy', className: 'btn btn-sm' },
                { extend: 'csv', className: 'btn btn-sm' },
                { extend: 'excel', className: 'btn btn-sm' },
                { extend: 'pdf', className: 'btn btn-sm' },
                { extend: 'print', className: 'btn btn-sm' }
              ],
              pageLength: 10,
              order: [[4, "desc"]], // Sort by Date Received by default
              destroy: true,
              language: {
                search: "Search entries:",
              },
              columnDefs: [
                { width: "5%", targets: 0 }, // #
                { width: "12%", targets: 1 }, // Control Number
                { width: "8%", targets: 2 }, // Letter Type
                { width: "7%", targets: 3 }, // Time Received
                { width: "7%", targets: 4 }, // Date Received
                { width: "7%", targets: 5 }, // From
                { width: "7%", targets: 6 }, // Office
                { width: "10%", targets: 7 }, // Subject
                { width: "7%", targets: 8 }, // Time Received (Admin)
                { width: "7%", targets: 9 }, // Date Received (Admin)
                { width: "7%", targets: 10 }, // Endorsed To
                { width: "7%", targets: 11 }, // Remarks
                { width: "7%", targets: 12 }, // File Code
                { width: "5%", targets: 13 }, // Status
                { width: "5%", targets: 14 }  // Actions
              ],
              scrollX: true,
              scrollCollapse: true,
              fixedColumns: {
                left: 1,
                right: 1
              }
            });

            // Add search functionality
            searchInput.addEventListener('keyup', function() {
              const table = $(`#${tableId}`).DataTable();
              table.search(this.value).draw();
            });
          }
        });
      }

      // Function to initialize DataTable for a specific month
      function initializeDataTable(monthKey, tableId, data) {
        // Destroy existing DataTable if it exists
        if ($.fn.DataTable.isDataTable(`#${tableId}`)) {
          $(`#${tableId}`).DataTable().destroy();
        }

        // Initialize new DataTable with basic configuration
        const table = $(`#${tableId}`).DataTable({
          data: data,
          columns: [
            { 
              data: null,
              render: function(data, type, row, meta) {
                return meta.row + 1;
              }
            },
            { data: 'controlNumber' },
            { data: 'type' },
            { data: 'timeReceived' },
            { data: 'dateReceived' },
            { data: 'from' },
            { data: 'office' },
            { data: 'subject' },
            { data: 'endorsedTo', defaultContent: '' },
            { data: 'remarks', defaultContent: '' },

            { data: 'status' },
            {
              data: null,
              render: function(data, type, row) {
                return `
                  <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#editEntryModal" onclick="editEntry('${row.key}')">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="deleteEntry('${row.key}')">
                    <i class="bi bi-trash"></i>
                  </button>
                `;
              }
            }
          ],
          pageLength: 10,
          order: [[4, "desc"]],
          dom: "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
               "<'row'<'col-sm-12'tr>>" +
               "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
          buttons: [
            { extend: 'copy', className: 'btn btn-sm' },
            { extend: 'csv', className: 'btn btn-sm' },
            { extend: 'excel', className: 'btn btn-sm' },
            { extend: 'pdf', className: 'btn btn-sm' },
            { extend: 'print', className: 'btn btn-sm' }
          ],
          language: {
            search: "Search entries:",
          },
          responsive: true,
          autoWidth: false,
          columnDefs: [
            { width: "5%", targets: 0 },
            { width: "10%", targets: 1 },
            { width: "8%", targets: 2 },
            { width: "8%", targets: 3 },
            { width: "8%", targets: 4 },
            { width: "10%", targets: 5 },
            { width: "10%", targets: 6 },
            { width: "15%", targets: 7 },
            { width: "10%", targets: 8 },
            { width: "10%", targets: 9 },
            { width: "8%", targets: 10 },
            { width: "8%", targets: 11 }
          ]
        });

        // Add search functionality
        const searchInput = document.getElementById(`search${monthKey}`);
        if (searchInput) {
          searchInput.addEventListener('keyup', function() {
            table.search(this.value).draw();
          });
        }

        return table;
      }

      // Update the loadEntries function to use the new initialization
      function loadEntries() {
        const currentYear = getCurrentYear();
        entriesRef.on("value", (snapshot) => {
          const entries = snapshot.val();
          const accordionContainer = document.getElementById("monthlyStatsAccordion");

          // Create months array
          const months = [
            "January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
          ];

          // Clear existing content
          accordionContainer.innerHTML = "";

          // Create empty accordion items for all months first
          months.forEach((month) => {
            const monthKey = `${month.toLowerCase()}${currentYear}`;
            const accordionItem = document.createElement("div");
            accordionItem.className = "accordion-item border-0 mb-2";
            accordionItem.id = `accordion-${monthKey}`;
            accordionItem.innerHTML = `
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${monthKey}">
                  <div class="d-flex justify-content-between align-items-center w-100">
                    <div>
                      <span class="fw-bold">${month} ${currentYear}</span>
                      <span class="badge bg-warning ms-2">Active</span>
                    </div>
                    <div class="text-muted small">
                      <i class="bi bi-arrow-down-circle me-1"></i>
                      Click to view details
                    </div>
                  </div>
                </button>
              </h2>
              <div id="${monthKey}" class="accordion-collapse collapse" data-bs-parent="#monthlyStatsAccordion">
                <div class="accordion-body">
                  <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading data for ${month} ${currentYear}...</p>
                  </div>
                </div>
              </div>
            `;
            accordionContainer.appendChild(accordionItem);
          });

          // Then populate each month's data as it arrives
          months.forEach((month) => {
            const monthKey = `${month.toLowerCase()}${currentYear}`;
            const tableId = `monthly-stats-table-${monthKey}`;

            // Get monthly data
            database
              .ref(`monthlyData/${monthKey}`)
              .once("value", (monthlySnapshot) => {
                const monthlyData = monthlySnapshot.val() || {
                  total: 0,
                  complaints: 0,
                  proposals: 0,
                  invitations: 0,
                  requests: 0,
                  entries: [],
                };

                // Get entries for this month
                const monthEntries = monthlyData.entries
                  .map((key) => {
                    const entry = entries[key];
                    return entry ? { key, ...entry } : null;
                  })
                  .filter((entry) => entry && entry.status !== "Archived");

                // Calculate statistics including archived entries
                const stats = {
                  complaints: 0,
                  proposals: 0,
                  invitations: 0,
                  requests: 0,
                  total: 0
                };

                // Count only non-archived entries
                monthlyData.entries.forEach(key => {
                  const entry = entries[key];
                  if (entry && entry.status !== "Archived") {
                    stats.total++;
                    const type = entry.type.toLowerCase();
                    if (type === 'complaint') stats.complaints++;
                    else if (type === 'proposal') stats.proposals++;
                    else if (type === 'invitation') stats.invitations++;
                    else if (type === 'request') stats.requests++;
                  }
                });

                // Update the accordion item with the data
                const accordionBody = document.querySelector(
                  `#${monthKey} .accordion-body`
                );
                if (accordionBody) {
                  accordionBody.innerHTML = `
                    <!-- ${month} Statistics -->
                    <div class="row mb-4">
                      <div class="col-md-3">
                        <div class="card bg-primary bg-opacity-10">
                          <div class="card-body">
                            <h6 class="card-title text-primary">Complaints</h6>
                            <h2 class="card-text">${stats.complaints}</h2>
                            <div class="d-flex align-items-center">
                              <span class="trend-indicator trend-up text-primary">
                                <i class="bi bi-arrow-up me-1"></i>0%
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="card bg-warning bg-opacity-10">
                          <div class="card-body">
                            <h6 class="card-title text-warning">Proposals</h6>
                            <h2 class="card-text">${stats.proposals}</h2>
                            <div class="d-flex align-items-center">
                              <span class="trend-indicator trend-up text-warning">
                                <i class="bi bi-arrow-up me-1"></i>0%
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="card bg-info bg-opacity-10">
                          <div class="card-body">
                            <h6 class="card-title text-info">Invitations</h6>
                            <h2 class="card-text">${stats.invitations}</h2>
                            <div class="d-flex align-items-center">
                              <span class="trend-indicator trend-up text-info">
                                <i class="bi bi-arrow-up me-1"></i>0%
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="card bg-warning bg-opacity-10">
                          <div class="card-body">
                            <h6 class="card-title text-success">Requests</h6>
                            <h2 class="card-text">${stats.requests}</h2>
                            <div class="d-flex align-items-center">
                              <span class="trend-indicator trend-up text-success">
                                <i class="bi bi-arrow-up me-1"></i>0%
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="table-responsive">
                      <table class="table table-hover monthly-stats-table" id="${tableId}">
                        <thead>
                          <tr>
                            <th>#</th>
                            <th>Control Number</th>
                            <th>Type</th>
                            <th>Time Received</th>
                            <th>Date Received</th>
                            <th>From</th>
                            <th>Office</th>
                            <th>Subject</th>
                            <th>Endorsed To</th>
                            <th>Remarks</th>
                            <th>Status</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                        </tbody>
                      </table>
                    </div>
                  `;

                  // Initialize DataTable with the data
                  setTimeout(() => {
                    try {
                      console.log(`Initializing table for ${month} with data:`, monthEntries);
                      initializeDataTable(monthKey, tableId, monthEntries);
                    } catch (error) {
                      console.error(`Error initializing DataTable for ${month}:`, error);
                    }
                  }, 100);
                }
              });
          });
        });
      }
    </script>
  </body>
</html>
