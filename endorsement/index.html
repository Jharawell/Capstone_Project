<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Endorsement Section Dashboard</title>
    <link rel="shortcut icon" href="../assets/images/logo.png" type="image/x-icon" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />
    <!-- Add DataTables CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css"
    />
    <link rel="stylesheet" href="../assets/css/style.css" />
    <style>
    
      /* Add custom styling for DataTables buttons */
     
      .btnCreate{
        background: #04b9b9;
        border: none;
        padding: 14px;
        border-radius: 9px;

      }

      .bi{
        font-weight: 700;
        
      }

      .header-section{
        background: #0D98BA;
      }

      .dt-buttons .btn {
        margin-right: 8px;
      }
      .dt-buttons .btn:last-child {
        margin-right: 0;
      }

      #currentUserEmailendorsement{
        font-size: 14px;
      }

      /* Make all read-only or disabled fields in the edit modal have the same color as the disabled select (Type) */
      #editEntryModal input[readonly],
      #editEntryModal select[disabled],
      #editEntryModal textarea[readonly] {
        background-color: #e9ecef !important;
        color: #6c757d !important;
        cursor: not-allowed;
        opacity: 1;
      }
      /* Keep the status field normal */
      #editStatus:not([disabled]) {
        background-color: #fff !important;
        color: #212529 !important;
        cursor: pointer;
      }

      @media print {
        body * {
          visibility: hidden !important;
        }
        #documentsSection, #documentsSection * {
          visibility: visible !important;
        }
        #documentsSection {
          position: absolute !important;
          left: 0; top: 0; width: 100vw; background: white;
          z-index: 9999;
          padding: 2rem;
        }
        .sidebar, .menu-toggle, .main-content > div:not(#documentsSection) {
          display: none !important;
        }
        .btn, .bi-printer {
          display: none !important;
        }
        .monthly-letters-card {
          page-break-before: always !important;
          break-before: page !important;
        }
      }
    </style>
  </head>
  <body>
    <button class="menu-toggle" id="menuToggle" title="Toggle sidebar menu">
      <i class="bi bi-list"></i>
    </button>

    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 px-0 sidebar" id="sidebar">
          <div class="d-flex flex-column p-4">
            <div class="d-flex justify-content-center">
              <a
                href="/"
                class="d-flex flex-column align-items-center text-white text-decoration-none"
                aria-label="Go to CentralComm homepage"
              >
                <img
                  src="../assets/images/logo-dashboard-page.png"
                  alt="CentralComm Logo"
                  class="mb-1"
                  style="width: 50px; height: 50px"
                />
                <span class="fs-3 fw-bold mt-2">CentralComm</span>
                <span id="currentUserEmailendorsement">endorsement@endorsement.com</span>
              </a>
            </div>

            <hr class="border-light opacity-50" />
            <ul class="nav nav-pills flex-column mb-auto">
              <li class="nav-item">
                <a href="#" class="nav-link active" id="dashboardLink">
                  <i class="bi bi-house-door stat-icon"></i>
                  Dashboard
                </a>
              </li>
              <li>
                <a href="#" class="nav-link" id="documentsLink">
                  <i class="bi bi-file-earmark-text stat-icon"></i>
                  Reports
                </a>
              </li>
              <li hidden>
                <a href="#" class="nav-link" id="usersLink">
                  <i class="bi bi-people stat-icon"></i>
                  Users
                </a>
              </li>
              <li>
                <a href="#" class="nav-link" id="archivesLink" >
                  <i class="bi bi-archive stat-icon"></i>
                  Archives
                </a>
              </li>
              <li>
                <a href="#" class="nav-link" id="historyLink">
                  <i class="bi bi-clock-history stat-icon"></i>
                  History
                </a>
              </li>
              <li>
                <a href="#" class="nav-link" id="profileLink">
                  <i class="bi bi-person-circle stat-icon"></i>
                  Profile
                </a>
              </li>
              <li>
                <a href="#" class="nav-link" onclick="signOut()">
                  <i class="bi bi-box-arrow-right me-2"></i>
                  Sign out
                </a>
              </li>
              
            </ul>
            <hr class="border-light opacity-50" />
          </div>
        </div>

        <!-- Main content -->
        <div class="col-md-9 col-lg-10 main-content">
          <!-- Dashboard Section -->
          <div id="dashboardSection">
            <div class="header-section card-header" style="color: black;">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h1 class="h2 mb-1">Endorsement Office - Mayor's Office Dashboard</h1>
                  <p class="mb-0">Welcome back, <span id="currentUserName">Permit and Licensing Division</span></p>
                </div>
                <div class="d-flex justify-content-end gap-2 mb-2 mb-md-0">
                  <!-- Archive All Button -->
                  <button
                    type="button"
                    class="btn btn-secondary"
                    id="archiveAllBtn"
                    title="Archive all current entries"
                  >
                    <i class="bi bi-archive me-2"></i>Archive All
                  </button>
                </div>
              </div>
            </div>

            <!-- Monthly Statistics -->
            <div class="card mb-4">
              <div class="card-header bg-white">
                <h5 class="card-title mb-0">Yearly Statistics</h5>
              </div>
              <div class="card-body p-0">
                <div class="accordion" id="monthlyStatsAccordion">
                  <!-- Monthly statistics will be populated here -->
                </div>
              </div>
            </div>
          </div>

          <!-- Archives Section -->
          <div id="archivesSection" class="d-none">
            <div class="header-section card-header bg-white">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h1 class="h2 mb-1">Archived Entries</h1>
                  <p class="mb-0 text-white-50">
                    View archived entries by year
                  </p>
                </div>
              </div>
            </div>

            <div class="card mb-4">
              <div class="card-body">
                <div class="row" id="archivedYearsContainer">
                  <!-- Archived years will be populated here -->
                </div>
              </div>
            </div>
          </div>

          <!-- Documents Section -->
          <div id="documentsSection" class="d-none">
            <div class="header-section card-header bg-white">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h1 class="h2 mb-1">Documents Reports</h1>
                  <p class="mb-0 text-white-50">
                    View document statistics and analytics
                  </p>
                </div>
                <div>
                  <button id="printReportsBtn" class="btn btn-outline-light" title="Download/Print Reports">
                    <i class="bi bi-printer"></i> Download/Print
                  </button>
                </div>
              </div>
            </div>

            <div class="row">
              <!-- Yearly Statistics -->
              <div class="col-md-6 mb-4">
                <div class="card h-100">
                  <div class="card-body">
                    <h6 class="card-title text-primary mb-3">
                      Yearly Statistics
                    </h6>
                    <div class="table-responsive">
                      <table class="table table-sm">
                        <tbody>
                          <tr>
                            <td>Total Letters Received</td>
                            <td class="text-end" id="yearlyTotal">0</td>
                          </tr>
                          <tr>
                            <td>Complaints</td>
                            <td class="text-end" id="yearlyComplaints">0</td>
                          </tr>
                          <tr>
                            <td>Requests</td>
                            <td class="text-end" id="yearlyRequests">0</td>
                          </tr>
                          <tr>
                            <td>Proposals</td>
                            <td class="text-end" id="yearlyProposals">0</td>
                          </tr>
                          <tr>
                            <td>Invitations</td>
                            <td class="text-end" id="yearlyInvitations">0</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Monthly Statistics -->
              <div class="col-md-6 mb-4">
                <div class="card h-100">
                  <div class="card-body">
                    <h6 class="card-title text-primary mb-3">
                      Monthly Statistics
                    </h6>
                    <div class="table-responsive">
                      <table class="table table-sm">
                        <tbody>
                          <tr>
                            <td>Current Month Letters</td>
                            <td class="text-end" id="monthlyTotal">0</td>
                          </tr>
                          <tr>
                            <td>Average Daily Letters</td>
                            <td class="text-end" id="avgDailyLetters">0</td>
                          </tr>
                          <tr>
                            <td>Highest Volume Month</td>
                            <td class="text-end" id="highestVolumeMonth">-</td>
                          </tr>
                          <tr>
                            <td>Lowest Volume Month</td>
                            <td class="text-end" id="lowestVolumeMonth">-</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Monthly Letters Graph -->
              <div class="col-md-6 mb-4 monthly-letters-card">
                <div class="card">
                  <div class="card-body">
                    <h6 class="card-title text-primary mb-3">
                      Monthly Letters Received
                    </h6>
                    <div style= "width: 100%;"></div>
                    <canvas id="monthlyLettersChart"></canvas>
                  </div>
                </div>
              </div>

              <!-- Add this after the Monthly Letters Graph card -->
              <div class="col-md-6 mb-4">
                <div class="card h-100">
                  <div class="card-body">
                    <h6 class="card-title text-primary mb-3">Letter Type Distribution</h6>
                    <div style="height: 300px; width: 100%;">
                      <canvas id="letterTypeChart"></canvas>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Remove Letter Types Distribution section -->
            </div>
          </div>

          <!-- Users Section -->
          <div id="usersSection" class="d-none">
            <div class="header-section card-header bg-white">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h1 class="h2 mb-1">Users</h1>
                  <p class="mb-0 text-white-50">Manage system users</p>
                </div>
                <div>
                  <button
                    type="button"
                    class="btn btn-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#createUserModal"
                  >
                    <i class="bi bi-person-plus me-2"></i>Create New User
                  </button>
                </div>
              </div>
            </div>
            <div class="card mb-4">
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover" id="usersTable">
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- Users will be populated here -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- History Section -->
          <div id="historySection" class="d-none">
            <div class="header-section card-header bg-white">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h1 class="h2 mb-1">History</h1>
                  <p class="mb-0 text-white-50">View system activity history</p>
                </div>
              </div>
            </div>
            <div class="card mb-4">
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover" id="historyTable">
                    <thead>
                      <tr>
                        <th>Timestamp</th>
                        <th>User</th>
                        <th>Action</th>
                        <th>Details</th>
                        <th>Control Number</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- History will be populated here -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Profile Section -->
          <div id="profileSection" class="d-none">
            <div class="header-section card-header bg-white">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h1 class="h2 mb-1">Profile Management</h1>
                  <p class="mb-0 text-white-50">Manage your account settings</p>
                </div>
              </div>
            </div>

            <div class="row">
              <!-- Profile Settings -->
              <div class="col-lg-8 mb-4">
                <div class="card">
                  <div class="card-body">
                    <h5 class="card-title mb-4">Account Settings</h5>
                    <form id="profileForm">
                      <div class="mb-3">
                        <label for="email" class="form-label">Email Address</label>
                        <div class="input-group">
                          <span class="input-group-text">
                            <i class="bi bi-envelope"></i>
                          </span>
                          <input
                            type="email"
                            class="form-control with-icon"
                            id="email"
                            value=""
                            readonly
                          />
                        </div>
                      </div>
                      <div class="mb-3">
                        <label for="role" class="form-label">Department</label>
                        <div class="input-group">
                          <span class="input-group-text">
                            <i class="bi bi-person-badge"></i>
                          </span>
                          <input
                            type="text"
                            class="form-control with-icon"
                            id="role"
                            value="Endorsement Section - Mayor's Office"
                            readonly
                          />
                        </div>
                      </div>
                    </form>
                  </div>
                </div>

                <!-- Change Password -->
                <div class="card mt-4">
                  <div class="card-body">
                    <h5 class="card-title mb-4">Change Password</h5>
                    <form id="passwordForm">
                      <div class="mb-3">
                        <label for="currentPassword" class="form-label">Current Password</label>
                        <div class="input-group">
                          <input
                            type="password"
                            class="form-control"
                            id="currentPassword"
                            required
                          />
                          <button class="btn btn-outline-secondary" type="button" id="toggleCurrentPassword" title="Show/hide password">
                            <i class="bi bi-eye" id="currentPasswordIcon"></i>
                          </button>
                        </div>
                      </div>
                      <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password</label>
                        <div class="input-group">
                          <input
                            type="password"
                            class="form-control"
                            id="newPassword"
                            required
                          />
                          <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword" title="Show/hide password">
                            <i class="bi bi-eye" id="newPasswordIcon"></i>
                          </button>
                        </div>
                      </div>
                      <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Confirm New Password</label>
                        <div class="input-group">
                          <input
                            type="password"
                            class="form-control"
                            id="confirmPassword"
                            required
                          />
                          <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword" title="Show/hide password">
                            <i class="bi bi-eye" id="confirmPasswordIcon"></i>
                          </button>
                        </div>
                      </div>
                      <button type="submit" class="btn btn-success" title="Update password">
                        Update Password
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Create Entry Modal -->
    <div
      class="modal fade"
      id="createEntryModal"
      tabindex="-1"
      aria-labelledby="createEntryModalLabel"
      aria-hidden="true"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header card-header bg-white">
            <h5 class="modal-title" id="createEntryModalLabel">
              Create New Entry
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="createEntryForm">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="letterType" class="form-label">Type</label>
                  <select class="form-select" id="letterType" required>
                    <option value="" disabled selected>Select Type</option>
                    <option value="Complaint">Complaint</option>
                    <option value="Request">Request</option>
                    <option value="Proposal">Proposal</option>
                    <option value="Invitation">Invitation</option>
                    <option value="Other">Other</option>
                  </select> 
                </div>
                <div class="col-md-6">
                  <label for="controlNumber" class="form-label"
                    >Control Number</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="controlNumber"
                    readonly
                  />
                </div>
              </div>
              <!-- Add Client Email field to Create Entry Form -->
              <div class="mb-3">
                <label for="clientEmail" class="form-label">Client Email</label>
                <input type="email" class="form-control" id="clientEmail" required />
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="dateReceived" class="form-label"
                    >Date Received</label
                  >
                  <input
                    type="date"
                    class="form-control"
                    id="dateReceived"
                    required disabled
                  />
                </div>
                <div class="col-md-6">
                  <label for="timeReceived" class="form-label"
                    >Time Received</label
                  >
                  <input
                    type="time"
                    class="form-control"
                    id="timeReceived"
                    required disabled
                  />
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="from" class="form-label">From</label>
                  <input type="text" class="form-control" id="from" required />
                </div>
                <div class="col-md-6">
                  <label for="office" class="form-label">Office</label>
                  <input
                    type="text"
                    class="form-control"
                    id="office"
                    required
                  />
                </div>
              </div>
              <div class="mb-3">
                <label for="subject" class="form-label">Subject</label>
                <input type="text" class="form-control" id="subject" required />
              </div>
              <div class="mb-3">
                <label for="status" class="form-label">Status</label>
                <select class="form-select" id="status" required readonly disabled>
                  <option value="Pending" selected>Pending</option>
                  <option value="Processing">Processing</option>
                  <option value="Completed">Completed</option>
                  <option value="Archived">Archived</option>
                  <option value="Under Investigation">Under Investigation (Ongoing)</option>
                  <option value="Inspection">Inspection, Acted Upon (Done)</option>
                  <option value="For Review">For Review and Approval (Ongoing)</option>
                  <option value="Request Granted">Request Granted (Done)</option>
                  <option value="Request Denied">Request Denied</option>
                </select>
              </div>
              <!-- Add Google Drive File URL field to Create Entry Form -->
              <div class="mb-3">
                <label for="fileUrl" class="form-label">Google Drive File URL</label>
                <input type="url" class="form-control" id="fileUrl" placeholder="Paste Google Drive shareable link here" />
                <div class="form-text">Upload your file to Google Drive, set sharing to 'Anyone with the link', and paste the link here.</div>
                <div id="fileUrlPreview" class="mt-2"></div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button type="button" class="btn btn-primary" id="saveEntry" title="Save new entry">
              Save Entry
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Entry Modal -->
    <div
      class="modal fade"
      id="editEntryModal"
      tabindex="-1"
      aria-labelledby="editEntryModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header card-header bg-white">
            <h5 class="modal-title" id="editEntryModalLabel">Edit Entry</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editEntryForm">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="editType" class="form-label">Type</label>
                  <select class="form-select" id="editType" required disabled>
                    <option value="">Select Type</option>
                    <option value="Complaint">Complaint</option>
                    <option value="Request">Request</option>
                    <option value="Proposal">Proposal</option>
                    <option value="Invitation">Invitation</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="editControlNumber" class="form-label"
                    >Control Number</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="editControlNumber"
                    required readonly
                  />
                </div>
              </div>
              <!-- Add Client Email field to Edit Entry Form -->
              <div class="mb-3">
                <label for="editClientEmail" class="form-label">Client Email</label>
                <input type="email" class="form-control" id="editClientEmail" required readonly />
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="editDateReceived" class="form-label"
                    >Date Received</label
                  >
                  <input
                    type="date"
                    class="form-control"
                    id="editDateReceived"
                    required readonly
                  />
                </div>
                <div class="col-md-6">
                  <label for="editTimeReceived" class="form-label"
                    >Time Received</label
                  >
                  <input
                    type="time"
                    class="form-control"
                    id="editTimeReceived"
                    required readonly
                  />
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="editFrom" class="form-label">From</label>
                  <input
                    type="text"
                    class="form-control"
                    id="editFrom"
                    required readonly
                  />
                </div>
                <div class="col-md-6">
                  <label for="editOffice" class="form-label">Office</label>
                  <input
                    type="text"
                    class="form-control"
                    id="editOffice"
                    required readonly
                  />
                </div>
              </div>
              <div class="mb-3">
                <label for="editSubject" class="form-label">Subject</label>
                <input
                  type="text"
                  class="form-control"
                  id="editSubject"
                  required readonly
                />
              </div>
              <div class="mb-3" hidden>
                <label for="editEndorsedTo" class="form-label"
                  >Endorsed To</label
                >
                <select class="form-select" id="editEndorsedTo" required disabled>
                  <option value="">Select Office</option>
                  <option value="Vice Mayor's Office">
                    Vice Mayor's Office
                  </option>
                  <option value="Sangguniang Panlungsod">
                    Sangguniang Panlungsod
                  </option>
                  <option value="CAO">CAO</option>
                  <option value="CASSO">CASSO</option>
                  <option value="CADMO">CADMO</option>
                  <option value="CBO">CBO</option>
                  <option value="CEPMO">CEPMO</option>
                  <option value="CHRMO">CHRMO</option>
                  <option value="CLO">CLO</option>
                  <option value="CPDSO">CPDSO</option>
                  <option value="CTO">CTO</option>
                  <option value="GSO">GSO</option>
                  <option value="CBAO">CBAO</option>
                  <option value="CEO">CEO</option>
                  <option value="CSWDO">CSWDO</option>
                  <option value="HSO">HSO</option>
                  <option value="LCR">LCR</option>
                  <option value="CVAO">CVAO</option>
                  <option value="DepEd">DepEd</option>
                  <option value="COA">COA</option>
                  <option value="MTCC">MTCC</option>
                  <option value="RTCC">RTCC</option>
                  <option value="Prosecutor's Office">
                    Prosecutor's Office
                  </option>
                  <option value="PESO">PESO</option>
                  <option value="PIO">PIO</option>
                  <option value="PLD">PLD</option>
                  <option value="PLEB">PLEB</option>
                  <option value="POSD">POSD</option>
                  <option value="SSD">SSD</option>
                  <option value="PDAO">PDAO</option>
                  <option value="MITD">MITD</option>
                  <option value="CCTV/EWSS">CCTV/EWSS</option>
                  <option value="CDRRMO">CDRRMO</option>
                  <option value="LIBRARY">LIBRARY</option>
                  <option value="PERSONAL STAFF">PERSONAL STAFF</option>
                </select>
              </div>
              <div class="mb-3" hidden>
                <label for="editFileUpload" class="form-label"
                  >File Upload</label
                >
                <input
                  type="file"
                  class="form-control"
                  id="editFileUpload"
                  accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                />
                <div class="form-text">
                  Accepted formats: PDF, DOC, DOCX, JPG, JPEG, PNG
                </div>
              </div>
              <div class="mb-3" hidden>
                <label for="editRemarks" class="form-label">Remarks</label>
                <textarea
                  class="form-control"
                  id="editRemarks"
                  rows="3"
                  readonly
                ></textarea>
              </div>
              <div class="mb-3">
                <label for="editStatus" class="form-label">Status</label>
                <select class="form-select" id="editStatus" required>
                  <option value="Pending">Pending</option>
                  <option value="Processing">Processing</option>
                  <option value="Completed">Completed</option>
                  <option value="Archived">Archived</option>
                  <option value="Under Investigation">Under Investigation (Ongoing)</option>
                  <option value="Inspection">Inspection, Acted Upon (Done)</option>
                  <option value="For Review">For Review and Approval (Ongoing)</option>
                  <option value="Request Granted">Request Granted (Done)</option>
                  <option value="Request Denied">Request Denied</option>
                </select>
              </div>
              <!-- Add Status Remarks field for status explanations -->
              <div class="mb-3">
                <label for="editStatusRemarks" class="form-label">Status Explanation</label>
                <textarea
                  class="form-control"
                  id="editStatusRemarks"
                  rows="3"
                  placeholder="Please provide explanation or reasons for the status change..."
                  required
                ></textarea>
                <div class="form-text">This explanation will be included in the email notification to the client.</div>
              </div>
              <!-- Add Google Drive File URL field to Edit Entry Form -->
              <div class="mb-3">
                <label for="editFileUrl" class="form-label">Google Drive File URL</label>
                <input type="url" class="form-control" id="editFileUrl" placeholder="Paste Google Drive shareable link here" readonly />
                <div class="form-text">Upload your file to Google Drive, set sharing to 'Anyone with the link', and paste the link here.</div>
                <div id="editFileUrlPreview" class="mt-2"></div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button type="button" class="btn btn-primary" id="updateEntry" title="Update entry">
              Update Entry
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- View Archived Entry Modal -->
    <div
      class="modal fade"
      id="viewArchivedModal"
      tabindex="-1"
      aria-labelledby="viewArchivedModalLabel"
      aria-hidden="true"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header card-header bg-white">
            <h5 class="modal-title" id="viewArchivedModalLabel">
              Archived Entry Details
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <!-- Entry details will be populated here -->
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- View Audit Log Modal -->
    <div
      class="modal fade"
      id="viewAuditLogModal"
      tabindex="-1"
      aria-labelledby="viewAuditLogModalLabel"
      aria-hidden="true"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header card-header bg-white">
            <h5 class="modal-title" id="viewAuditLogModalLabel">
              Audit Log Details
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row mb-3">
              <div class="col-md-6">
                <strong>Timestamp:</strong> <span id="auditTimestamp"></span>
              </div>
              <div class="col-md-6">
                <strong>User:</strong> <span id="auditUser"></span>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <strong>Action:</strong> <span id="auditAction"></span>
              </div>
              <div class="col-md-6">
                <strong>Control Number:</strong>
                <span id="auditControlNumber"></span>
              </div>
            </div>
            <div class="mb-3">
              <strong>Details:</strong>
              <p id="auditDetails" class="mt-2"></p>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Create User Modal -->
    <div
      class="modal fade"
      id="createUserModal"
      tabindex="-1"
      aria-labelledby="createUserModalLabel"
      aria-hidden="true"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header card-header bg-white">
            <h5 class="modal-title" id="createUserModalLabel">Create New User</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="createUserForm">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="newFirstName" class="form-label">First Name</label>
                  <div class="input-group">
                    <span class="input-group-text">
                      <i class="bi bi-person"></i>
                    </span>
                  <input
                    type="text"
                      class="form-control with-icon"
                    id="newFirstName"
                      placeholder="First Name"
                    required
                  />
                  </div>
                </div>
                <div class="col-md-6">
                  <label for="newLastName" class="form-label">Last Name</label>
                  <div class="input-group">
                    <span class="input-group-text">
                      <i class="bi bi-person"></i>
                    </span>
                  <input
                    type="text"
                      class="form-control with-icon"
                    id="newLastName"
                      placeholder="Last Name"
                    required
                  />
                  </div>
                </div>
              </div>
              <div class="mb-3">
                <label for="newEmail" class="form-label">Email Address</label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="bi bi-envelope"></i>
                  </span>
                <input
                  type="email"
                    class="form-control with-icon"
                  id="newEmail"
                    placeholder="Email"
                  required
                />
              </div>
              </div>
              <div class="mb-3">
                <label for="newRole" class="form-label">Role</label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="bi bi-person-badge"></i>
                  </span>
                  <select class="form-control with-icon" id="newRole" required>
                  <option value="">Select Role</option>
                    <option value="Administrator">Administrator</option>
                    <option value="Staff">Staff</option>
                    <option value="Manager">Manager</option>
                </select>
                </div>
              </div>
              <div class="mb-3">
                <label for="newPassword" class="form-label">Password</label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="bi bi-key"></i>
                  </span>
                <input
                  type="password"
                    class="form-control with-icon"
                  id="newPassword"
                    placeholder="Password"
                  required
                />
                </div>
              </div>
              <div class="mb-3">
                <label for="confirmNewPassword" class="form-label">Confirm Password</label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="bi bi-key-fill"></i>
                  </span>
                <input
                  type="password"
                    class="form-control with-icon"
                  id="confirmNewPassword"
                    placeholder="Confirm Password"
                  required
                />
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-success"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button type="button" class="btn btn-primary" id="saveUser" title="Create user">
              Create User
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Sort/Filter Modal -->
    <div class="modal fade" id="sortFilterModal" tabindex="-1" aria-labelledby="sortFilterModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="sortFilterModalLabel">Sort & Filter Archived Entries</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" title="Close modal"></button>
          </div>
          <div class="modal-body">
            <form id="sortFilterForm">
              <div class="row mb-3">
                <div class="col-md-6 mb-3">
                  <label class="form-label fw-bold">Months</label>
                  <div class="d-flex flex-wrap gap-2">
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="January" id="monthJan" name="months"><label class="form-check-label" for="monthJan">January</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="February" id="monthFeb" name="months"><label class="form-check-label" for="monthFeb">February</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="March" id="monthMar" name="months"><label class="form-check-label" for="monthMar">March</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="April" id="monthApr" name="months"><label class="form-check-label" for="monthApr">April</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="May" id="monthMay" name="months"><label class="form-check-label" for="monthMay">May</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="June" id="monthJun" name="months"><label class="form-check-label" for="monthJun">June</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="July" id="monthJul" name="months"><label class="form-check-label" for="monthJul">July</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="August" id="monthAug" name="months"><label class="form-check-label" for="monthAug">August</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="September" id="monthSep" name="months"><label class="form-check-label" for="monthSep">September</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="October" id="monthOct" name="months"><label class="form-check-label" for="monthOct">October</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="November" id="monthNov" name="months"><label class="form-check-label" for="monthNov">November</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="December" id="monthDec" name="months"><label class="form-check-label" for="monthDec">December</label></div>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label fw-bold">Letter Types</label>
                  <div class="d-flex flex-wrap gap-2">
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="Complaint" id="typeComplaint" name="letterTypes"><label class="form-check-label" for="typeComplaint">Complaint</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="Request" id="typeRequest" name="letterTypes"><label class="form-check-label" for="typeRequest">Request</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="Proposal" id="typeProposal" name="letterTypes"><label class="form-check-label" for="typeProposal">Proposal</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="Invitation" id="typeInvitation" name="letterTypes"><label class="form-check-label" for="typeInvitation">Invitation</label></div>
                  </div>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-4 mb-3">
                  <label class="form-label fw-bold" for="filterDateReceived">Date Received</label>
                  <input type="date" class="form-control" id="filterDateReceived" name="dateReceived">
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label fw-bold" for="filterFrom">From</label>
                  <select class="form-select" id="filterFrom" name="from">
                    <option value="">All</option>
                    <!-- Options will be populated dynamically -->
                  </select>
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label fw-bold" for="filterOffice">Office</label>
                  <select class="form-select" id="filterOffice" name="office">
                    <option value="">All</option>
                    <!-- Options will be populated dynamically -->
                  </select>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6 mb-3">
                  <label class="form-label fw-bold" for="filterEndorsedTo">Endorsed To</label>
                  <select class="form-select" id="filterEndorsedTo" name="endorsedTo">
                    <option value="">All</option>
                    <!-- Options will be populated dynamically -->
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label fw-bold" for="filterStatus">Status</label>
                  <select class="form-select" id="filterStatus" name="status">
                    <option value="">All</option>
                    <!-- Options will be populated dynamically -->
                  </select>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="resetSortFilter" title="Reset filters">Reset</button>
            <button type="button" class="btn btn-primary" id="applySortFilter" title="Apply filters">Apply</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <!-- Add department access control script -->
    <script>
    // Department Access Control System
    class DepartmentAccessControl {
      constructor() {
        this.departmentDomains = {
          'PLD': '@endorsement-pld.com',
          'PIO': '@endorsement-pio.com',
          'CAO': '@endorsement-cao.com',
          'CASSO': '@endorsement-casso.com',
          'CADMO': '@endorsement-cadmo.com',
          'CBO': '@endorsement-cbo.com',
          'CEPMO': '@endorsement-cepmo.com',
          'CHRMO': '@endorsement-chrmo.com',
          'CLO': '@endorsement-clo.com',
          'CPDSO': '@endorsement-cpdso.com',
          'CTO': '@endorsement-cto.com',
          'GSO': '@endorsement-gso.com',
          'CBAO': '@endorsement-cbao.com',
          'CEO': '@endorsement-ceo.com',
          'CSWDO': '@endorsement-cswdo.com',
          'HSO': '@endorsement-hso.com',
          'LCR': '@endorsement-lcr.com',
          'CVAO': '@endorsement-cvao.com',
          'DepEd': '@endorsement-deped.com',
          'COA': '@endorsement-coa.com',
          'MTCC': '@endorsement-mtcc.com',
          'RTCC': '@endorsement-rtcc.com',
          'Prosecutor': '@endorsement-prosecutor.com',
          'PESO': '@endorsement-peso.com',
          'PLEB': '@endorsement-pleb.com',
          'POSD': '@endorsement-posd.com',
          'SSD': '@endorsement-ssd.com',
          'PDAO': '@endorsement-pdao.com',
          'MITD': '@endorsement-mitd.com',
          'CCTV': '@endorsement-cctv.com',
          'CDRRMO': '@endorsement-cdrrmo.com',
          'LIBRARY': '@endorsement-library.com',
          'PERSONAL_STAFF': '@endorsement-personal-staff.com'
        };
        this.domainToDepartment = {};
        Object.entries(this.departmentDomains).forEach(([dept, domain]) => {
          this.domainToDepartment[domain] = dept;
        });
        this.adminEmails = [
          'admin@centralcomm.com',
          'cmobaguio2600@gmail.com',
          'endorsement@endorsement.com'
        ];
      }
      getUserDepartment(email) {
        if (!email) return null;
        if (this.adminEmails.includes(email)) return 'ADMIN';
        const domain = '@' + email.split('@')[1];
        return this.domainToDepartment[domain] || null;
      }
      hasAccessToEntry(userEmail, entry) {
        const userDept = this.getUserDepartment(userEmail);
        if (userDept === 'ADMIN') return true;
        if (entry && entry.endorsedTo) return entry.endorsedTo === userDept;
        return false;
      }
      filterEntriesByDepartment(entries, userEmail) {
        const userDept = this.getUserDepartment(userEmail);
        if (!entries) return [];
        if (userDept === 'ADMIN') return Object.entries(entries).map(([key, entry]) => ({ key, ...entry }));
        return Object.entries(entries).filter(([key, entry]) => this.hasAccessToEntry(userEmail, entry)).map(([key, entry]) => ({ key, ...entry }));
      }
      getDepartmentName(deptCode) {
        const departmentNames = {
          'PLD': 'Permit and Licensing Department',
          'PIO': 'Public Information Office',
          'CAO': 'City Administrator Office',
          'CASSO': 'City Accountant Office',
          'CADMO': 'City Agriculture Office',
          'CBO': 'City Budget Office',
          'CEPMO': 'City Engineering Office',
          'CHRMO': 'City Human Resource Office',
          'CLO': 'City Legal Office',
          'CPDSO': 'City Planning Office',
          'CTO': 'City Treasurer Office',
          'GSO': 'General Services Office',
          'CBAO': 'City Building Office',
          'CEO': 'City Environment Office',
          'CSWDO': 'City Social Welfare Office',
          'HSO': 'Health Services Office',
          'LCR': 'Local Civil Registry',
          'CVAO': 'City Veterinary Office',
          'DepEd': 'Department of Education',
          'COA': 'Commission on Audit',
          'MTCC': 'Municipal Trial Court',
          'RTCC': 'Regional Trial Court',
          'Prosecutor': 'Prosecutor Office',
          'PESO': 'Public Employment Office',
          'PLEB': 'People Law Enforcement Board',
          'POSD': 'Public Order and Safety Office',
          'SSD': 'Social Services Department',
          'PDAO': 'Persons with Disability Office',
          'MITD': 'Management Information Office',
          'CCTV': 'CCTV/EWSS Office',
          'CDRRMO': 'City Disaster Risk Reduction Office',
          'LIBRARY': 'City Library',
          'PERSONAL_STAFF': 'Personal Staff'
        };
        return departmentNames[deptCode] || deptCode;
      }
      validateSectionAccess(userEmail) {
        const userDept = this.getUserDepartment(userEmail);
        return !!userDept;
      }
      getUserDisplayInfo(userEmail) {
        const userDept = this.getUserDepartment(userEmail);
        if (userDept === 'ADMIN') {
          return { name: 'Administrator', department: 'System Administrator', role: 'Administrator' };
        }
        if (userDept) {
          return { name: this.getDepartmentName(userDept), department: this.getDepartmentName(userDept), role: 'Department Staff' };
        }
        return { name: 'Unknown User', department: 'Unknown Department', role: 'User' };
      }
    }
    const departmentAccessControl = new DepartmentAccessControl();
    window.departmentAccessControl = departmentAccessControl;
    </script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
      crossorigin="anonymous"
    ></script>
    <!-- Add DataTables JS -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
    <!-- Add SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Add Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
    <!-- Add Moment.js and DataTables datetime-moment plugin for correct date/time sorting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdn.datatables.net/plug-ins/1.13.7/sorting/datetime-moment.js"></script>

    <script>
      // Initialize Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyCaSHRLbIRWW8COl5iwHb19dMDYYLJ2DIk",
        authDomain: "centralcomm-248a9.firebaseapp.com",
        databaseURL: "https://centralcomm-248a9-default-rtdb.firebaseio.com",
        projectId: "centralcomm-248a9",
        storageBucket: "centralcomm-248a9.firebasestorage.app",
        messagingSenderId: "796912003621",
        appId: "1:796912003621:web:0d6fd82e43399871a9edcc",
        measurementId: "G-CN0S9L5YV4",
      };

      // Initialize Firebase if not already initialized
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }

      const database = firebase.database();
      const entriesRef = database.ref("entries");

      // Function to generate control number
      function generateControlNumber() {
        // Get the current year
        const year = new Date().getFullYear();
        
        // Get the last control number from the database
        return database.ref('lastControlNumber').once('value').then(snapshot => {
          let lastNumber = snapshot.val() || 0;
          
          // Update the last control number in the database
          database.ref('lastControlNumber').set(lastNumber + 1);
          
          // Format the number with 5 leading zeros
          const formattedNumber = String(lastNumber + 1).padStart(5, '0');
          return `${year}-${formattedNumber}`;
        });
      }

      // Function to get the next control number without incrementing
      function getNextControlNumber() {
        // Get the current year
        const year = new Date().getFullYear();
        
        // Get the last control number from the database
        return database.ref('lastControlNumber').once('value').then(snapshot => {
          let lastNumber = snapshot.val() || 0;
          
          // Format the number with 5 leading zeros
          const formattedNumber = String(lastNumber + 1).padStart(5, '0');
          return `${year}-${formattedNumber}`;
        });
      }

      // Function to check and archive old entries
      function checkAndArchiveEntries() {
        // Show loading state
        Swal.fire({
          title: "Checking Entries",
          text: "Please wait while we check for entries to archive...",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        const currentYear = new Date().getFullYear();
        entriesRef
          .once("value", (snapshot) => {
            const entries = snapshot.val();
            if (entries) {
              let archivedCount = 0;
              let totalToArchive = 0;

              // First count how many entries need to be archived
              Object.entries(entries).forEach(([_, entry]) => {
                const entryYear = new Date(entry.dateReceived).getFullYear();
                if (
                  currentYear === 2025 &&
                  entryYear < 2025 &&
                  entry.status !== "Archived"
                ) {
                  totalToArchive++;
                }
              });

              if (totalToArchive === 0) {
                Swal.close();
                return;
              }

              // Update loading message
              Swal.update({
                title: "Archiving Entries",
                html: `Archiving ${totalToArchive} entries...`,
              });

              // Archive each entry
              Object.entries(entries).forEach(([key, entry]) => {
                const entryYear = new Date(entry.dateReceived).getFullYear();
                if (
                  currentYear === 2025 &&
                  entryYear < 2025 &&
                  entry.status !== "Archived"
                ) {
                  entriesRef
                    .child(key)
                    .update({
                      status: "Archived",
                      archivedAt: firebase.database.ServerValue.TIMESTAMP,
                    })
                    .then(() => {
                      archivedCount++;
                      logActivity(
                        "archive",
                        `Archived entry from ${entryYear}: ${entry.subject}`,
                        entry.controlNumber
                      );

                      // Update progress
                      if (archivedCount === totalToArchive) {
                        Swal.fire({
                          title: "Success!",
                          text: `Successfully archived ${archivedCount} entries!`,
                          icon: "success",
                          confirmButtonColor: "#002C75",
                        });
                      }
                    })
                    .catch((error) => {
                      console.error("Error archiving entry:", error);
                      Swal.fire({
                        title: "Error!",
                        text: "Error archiving entries. Please try again.",
                        icon: "error",
                        confirmButtonColor: "#dc3545",
                      });
                    });
                }
              });
            }
            Swal.close();
          })
          .catch((error) => {
            console.error("Error checking entries:", error);
            Swal.close();
            showErrorAlert("Error checking entries. Please try again.");
          });
      }

      // Function to load entries into the table
      function loadEntries() {
        const currentUser = getCurrentUser();
        const currentYear = getCurrentYear();
        if (!departmentAccessControl.validateSectionAccess(currentUser.email)) {
          showErrorAlert("You don't have access to this section.");
          window.location.href = "../pages/selection.html";
          return;
        }
        entriesRef.on("value", (snapshot) => {
          const allEntries = snapshot.val();
          const filteredEntries = departmentAccessControl.filterEntriesByDepartment(allEntries, currentUser.email);
          const accordionContainer = document.getElementById("monthlyStatsAccordion");
          const months = [
            "January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
          ];
          const now = new Date();
          const currentMonthIdx = now.getMonth();
          const visibleMonths = months.slice(0, currentMonthIdx + 1).reverse();
          accordionContainer.innerHTML = "";
          visibleMonths.forEach((month) => {
            const monthKey = `${month.toLowerCase()}${currentYear}`;
            const accordionItem = document.createElement("div");
            accordionItem.className = "accordion-item border-0 mb-2";
            accordionItem.id = `accordion-${monthKey}`;
            accordionItem.innerHTML = `
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${monthKey}" title="Expand/collapse month details">
                  <div class="d-flex justify-content-between align-items-center w-100">
                    <div>
                      <span class="fw-bold">${month} ${currentYear}</span>
                    </div>
                    <div class="text-muted small">
                      <i class="bi bi-arrow-down-circle me-1"></i>
                      Click to view details
                    </div>
                  </div>
                </button>
              </h2>
              <div id="${monthKey}" class="accordion-collapse collapse" data-bs-parent="#monthlyStatsAccordion">
                <div class="accordion-body">
                  <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading data for ${month} ${currentYear}...</p>
                  </div>
                </div>
              </div>
            `;
            accordionContainer.appendChild(accordionItem);
          });
          visibleMonths.forEach((month) => {
            const monthKey = `${month.toLowerCase()}${currentYear}`;
            const tableId = `monthly-stats-table-${monthKey}`;
            database
              .ref(`monthlyData/${monthKey}`)
              .once("value", (monthlySnapshot) => {
                const monthlyData = monthlySnapshot.val() || {
                  total: 0,
                  complaints: 0,
                  proposals: 0,
                  invitations: 0,
                  requests: 0,
                  entries: [],
                };
                const monthEntries = monthlyData.entries
                  .map((key) => {
                    const entry = allEntries[key];
                    return entry ? { key, ...entry } : null;
                  })
                  .filter((entry) => {
                    if (!entry || entry.status === "Archived") return false;
                    return departmentAccessControl.hasAccessToEntry(currentUser.email, entry);
                  });
                const stats = {
                  complaints: 0,
                  proposals: 0,
                  invitations: 0,
                  requests: 0,
                  total: 0
                };
                monthEntries.forEach(entry => {
                  stats.total++;
                  const type = entry.type.toLowerCase();
                  if (type === 'complaint') stats.complaints++;
                  else if (type === 'proposal') stats.proposals++;
                  else if (type === 'invitation') stats.invitations++;
                  else if (type === 'request') stats.requests++;
                });
                function getTypePercent(count, total) {
                  if (total === 0) return 0;
                  return Math.round((count / total) * 100);
                }
                const complaintsPercent = getTypePercent(stats.complaints, stats.total);
                const proposalsPercent = getTypePercent(stats.proposals, stats.total);
                const invitationsPercent = getTypePercent(stats.invitations, stats.total);
                const requestsPercent = getTypePercent(stats.requests, stats.total);
                monthEntries.sort((a, b) => {
                  return new Date(b.dateReceived) - new Date(a.dateReceived);
                });
                const accordionBody = document.querySelector(
                  `#${monthKey} .accordion-body`
                );
                if (accordionBody) {
                  accordionBody.innerHTML = `
                    <!-- ${month} Statistics -->
                    <div class="row mb-4">
                      <div class="col-md-3">
                        <div class="card bg-primary bg-opacity-10">
                          <div class="card-body">
                            <h6 class="card-title text-primary">Complaints</h6>
                            <h2 class="card-text">${stats.complaints}</h2>
                            <div class="d-flex align-items-center">
                              <span class="trend-indicator trend-up text-primary">
                                <i class="bi bi-arrow-up me-1"></i>${complaintsPercent}%
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="card bg-warning bg-opacity-10">
                          <div class="card-body">
                            <h6 class="card-title text-warning">Proposals</h6>
                            <h2 class="card-text">${stats.proposals}</h2>
                            <div class="d-flex align-items-center">
                              <span class="trend-indicator trend-up text-warning">
                                <i class="bi bi-arrow-up me-1"></i>${proposalsPercent}%
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="card bg-info bg-opacity-10">
                          <div class="card-body">
                            <h6 class="card-title text-info">Invitations</h6>
                            <h2 class="card-text">${stats.invitations}</h2>
                            <div class="d-flex align-items-center">
                              <span class="trend-indicator trend-up text-info">
                                <i class="bi bi-arrow-up me-1"></i>${invitationsPercent}%
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="card bg-warning bg-opacity-10">
                          <div class="card-body">
                            <h6 class="card-title text-success">Requests</h6>
                            <h2 class="card-text">${stats.requests}</h2>
                            <div class="d-flex align-items-center">
                              <span class="trend-indicator trend-up text-success">
                                <i class="bi bi-arrow-up me-1"></i>${requestsPercent}%
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="table-responsive">
                      <table class="table table-hover monthly-stats-table" id="${tableId}">
                        <thead>
                          <tr>
                            <th>#</th>
                            <th>Control Number</th>
                            <th>Type</th>
                            <th>File</th>
                            <th>Time Received</th>
                            <th>Date Received</th>
                            <th>From</th>
                            <th>Office</th>
                            <th>Subject</th>
                            <th>Endorsed To</th>
                            <th>Remarks</th>
                            <th>Status</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                        </tbody>
                      </table>
                    </div>
                  `;
                  setTimeout(() => {
                    try {
                      initializeDataTable(monthKey, tableId, monthEntries);
                    } catch (error) {
                      console.error(`Error initializing DataTable for ${month}:`, error);
                    }
                  }, 100);
                }
              });
          });
        });
      }

      // Function to get status color
      function getStatusColor(status) {
        switch (status) {
          case "Pending":
            return "warning";
          case "Processing":
            return "info";
          case "Completed":
            return "success";
          case "Archived":
            return "secondary";
          default:
            return "primary";
        }
      }

      // Function to format date
      function formatDate(dateString) {
        try {
          const date = new Date(dateString);
          if (isNaN(date.getTime())) {
            return dateString;
          }
          return date.toLocaleDateString("en-US", {
            year: "numeric",
            month: "long",
            day: "numeric",
          });
        } catch (error) {
          console.error("Error formatting date:", error);
          return dateString;
        }
      }

      // Function to log activity
      function logActivity(action, details, controlNumber) {
        try {
          // Get section-specific user
          const sectionUser = getSectionUser();
          
          const logData = {
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            user: sectionUser.email,
            action: action || "unknown",
            details: details || "No details provided",
            controlNumber: controlNumber || "N/A",
            ipAddress: "127.0.0.1", // Replace with actual IP when available
            section: "endorsement" // Add section identifier
          };

          // Check if database is available
          if (!database) {
            console.error("Database not available for logging activity");
            return;
          }

          database
            .ref("logs")
            .push(logData)
            .then(() => {
              console.log("Activity logged successfully:", action, details);
            })
            .catch((error) => {
              console.error("Error logging activity:", error);
            });
        } catch (error) {
          console.error("Error in logActivity function:", error);
        }
      }

      // Function to show success alert
      function showSuccessAlert(message) {
        Swal.fire({
          title: "Success!",
          text: message,
          icon: "success",
          confirmButtonColor: "#002C75",
          timer: 2000,
          timerProgressBar: true,
        });
      }

      // Function to show error alert
      function showErrorAlert(message) {
        Swal.fire({
          title: "Error!",
          text: message,
          icon: "error",
          confirmButtonColor: "#dc3545",
        });
      }

      // Function to show confirmation dialog
      function showConfirmDialog(title, text, confirmButtonText) {
        return Swal.fire({
          title: title,
          text: text,
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#002C75",
          cancelButtonColor: "#dc3545",
          confirmButtonText: confirmButtonText,
        });
      }

      // Update delete entry function - now moves to archive instead of permanent deletion
      function deleteEntry(key) {
        showConfirmDialog(
          "Archive Entry",
          "This will move the entry to archives. You can restore it later if needed.",
          "Yes, archive it!"
        ).then((result) => {
          if (result.isConfirmed) {
            entriesRef.child(key).once("value", (snapshot) => {
              const entry = snapshot.val();
              if (entry) {
                entriesRef
                  .child(key)
                  .update({
                    status: "Archived",
                    archivedAt: firebase.database.ServerValue.TIMESTAMP,
                  })
                  .then(() => {
                    // Log the archiving in history
                    const logData = {
                      timestamp: firebase.database.ServerValue.TIMESTAMP,
                      user: "Admin", // Replace with actual user when authentication is implemented
                      action: "archive",
                      details: `Archived entry: ${entry.subject}`,
                      controlNumber: entry.controlNumber,
                      ipAddress: "127.0.0.1", // Replace with actual IP when available
                      userAgent: navigator.userAgent,
                    };

                    database
                      .ref("logs")
                      .push(logData)
                      .then(() => {
                        showSuccessAlert("Entry archived successfully!");
                        // Reload entries to update the table
                        loadEntries();
                        // Switch to archive section so user sees the archived entry
                        handleNavigation("archivesSection");
                      })
                      .catch((error) => {
                        console.error("Error logging archiving:", error);
                        showErrorAlert(
                          "Entry archived but failed to log the action."
                        );
                      });
                  })
                  .catch((error) => {
                    console.error("Error archiving entry:", error);
                    showErrorAlert("Error archiving entry. Please try again.");
                  });
              }
            });
          }
        });
      }

      // Function to archive all entries
      function archiveAllEntries() {
        showConfirmDialog(
          "Archive All Entries",
          "Are you sure you want to archive all entries? This action cannot be undone.",
          "Yes, archive all!"
        ).then((result) => {
          if (result.isConfirmed) {
            // Show initial loading state
            Swal.fire({
              title: "Preparing to Archive",
              text: "Please wait while we prepare to archive entries...",
              allowOutsideClick: false,
              didOpen: () => {
                Swal.showLoading();
              },
            });

            entriesRef
              .once("value", (snapshot) => {
                const entries = snapshot.val();
                if (entries) {
                  let archivedCount = 0;
                  let totalToArchive = 0;

                  // First count how many entries need to be archived
                  Object.entries(entries).forEach(([_, entry]) => {
                    if (entry.status !== "Archived") {
                      totalToArchive++;
                    }
                  });

                  if (totalToArchive === 0) {
                    Swal.fire({
                      title: "No Entries to Archive",
                      text: "There are no entries available to archive.",
                      icon: "info",
                      confirmButtonColor: "#002C75",
                    });
                    return;
                  }

                  // Update loading message
                  Swal.update({
                    title: "Archiving Entries",
                    html: `Archiving ${totalToArchive} entries...<br><br>
                          <div class="progress" style="height: 20px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: 0%" 
                                 id="archiveProgress">
                              0%
                            </div>
                          </div>`,
                  });

                  // Archive each entry
                  Object.entries(entries).forEach(([key, entry]) => {
                    if (entry.status !== "Archived") {
                      entriesRef
                        .child(key)
                        .update({
                          status: "Archived",
                          archivedAt: firebase.database.ServerValue.TIMESTAMP,
                        })
                        .then(() => {
                          archivedCount++;
                          logActivity(
                            "archive",
                            `Archived entry: ${entry.subject}`,
                            entry.controlNumber
                          );

                          // Update progress bar
                          const progress = Math.round(
                            (archivedCount / totalToArchive) * 100
                          );
                          document.getElementById(
                            "archiveProgress"
                          ).style.width = `${progress}%`;
                          document.getElementById(
                            "archiveProgress"
                          ).textContent = `${progress}%`;

                          // Update progress
                          if (archivedCount === totalToArchive) {
                            Swal.fire({
                              title: "Success!",
                              text: `Successfully archived ${archivedCount} entries!`,
                              icon: "success",
                              confirmButtonColor: "#002C75",
                            }).then(() => {
                              loadEntries();
                            });
                          }
                        })
                        .catch((error) => {
                          console.error("Error archiving entry:", error);
                          Swal.fire({
                            title: "Error!",
                            text: "Error archiving entries. Please try again.",
                            icon: "error",
                            confirmButtonColor: "#dc3545",
                          });
                        });
                    }
                  });
                } else {
                  Swal.fire({
                    title: "No Entries Found",
                    text: "There are no entries in the database.",
                    icon: "info",
                    confirmButtonColor: "#002C75",
                  });
                }
              })
              .catch((error) => {
                console.error("Error preparing to archive:", error);
                Swal.fire({
                  title: "Error!",
                  text: "Error preparing to archive entries. Please try again.",
                  icon: "error",
                  confirmButtonColor: "#dc3545",
                });
              });
          }
        });
      }

      // Update restore entry function
      function restoreEntry(key) {
        showConfirmDialog(
          "Restore Entry",
          "Are you sure you want to restore this entry?",
          "Yes, restore it!"
        ).then((result) => {
          if (result.isConfirmed) {
            // First get the entry details to log the control number
            entriesRef.child(key).once("value", (snapshot) => {
              const entry = snapshot.val();
              if (entry) {
                entriesRef
                  .child(key)
                  .update({
                    status: "Pending",
                    restoredAt: firebase.database.ServerValue.TIMESTAMP,
                  })
                  .then(() => {
                    logActivity("restore", `Restored archived entry: ${entry.subject}`, entry.controlNumber);
                    showSuccessAlert("Entry restored successfully!");
                    loadArchivedEntries();
                    // Switch to dashboard section so user sees the restored entry
                    handleNavigation("dashboardSection");
                  })
                  .catch((error) => {
                    console.error("Error restoring entry:", error);
                    showErrorAlert("Error restoring entry. Please try again.");
                  });
              }
            });
          }
        });
      }

      // Save entry form submission
      document.getElementById("saveEntry").addEventListener("click", function() {
        const formData = {
          type: document.getElementById("letterType").value,
          dateReceived: document.getElementById("dateReceived").value,
          timeReceived: document.getElementById("timeReceived").value,
          from: document.getElementById("from").value,
          office: document.getElementById("office").value,
          subject: document.getElementById("subject").value,
          status: document.getElementById("status").value, // Get the selected status
          fromEmail: document.getElementById("clientEmail").value, // Save client email
          createdAt: firebase.database.ServerValue.TIMESTAMP,
          fileUrl: document.getElementById("fileUrl").value,
        };

        // Validate required fields
        if (!formData.type || !formData.dateReceived || !formData.timeReceived || 
            !formData.from || !formData.office || !formData.subject || !formData.status) {
          showErrorAlert("Please fill in all required fields");
          return;
        }

        // Generate control number and save entry
        generateControlNumber().then(controlNumber => {
          formData.controlNumber = controlNumber;

          // Get the month and year for monthly data
          const entryDate = new Date(formData.dateReceived);
          const month = entryDate.toLocaleString("default", { month: "long" }).toLowerCase();
          const year = entryDate.getFullYear();
          const monthKey = `${month}${year}`;

          // Save the entry
          entriesRef.push(formData)
            .then((ref) => {
              // Save monthly data
              const monthlyRef = database.ref(`monthlyData/${monthKey}`);
              monthlyRef.once("value", (snapshot) => {
                const monthlyData = snapshot.val() || {
                  total: 0,
                  complaints: 0,
                  proposals: 0,
                  invitations: 0,
                  requests: 0,
                  entries: [],
                };

                // Update monthly statistics
                monthlyData.total++;
                monthlyData[formData.type.toLowerCase() + "s"]++;
                monthlyData.entries.push(ref.key);

                // Save updated monthly data
                monthlyRef.set(monthlyData)
                  .then(() => {
                    logActivity(
                      "create",
                      `Created new entry: ${formData.subject}`,
                      formData.controlNumber
                    );

                    // Reset form and update status options
                    document.getElementById("createEntryForm").reset();
                    updateStatusOptions(document.getElementById("letterType").value);

                    // Set current date and time
                    const now = new Date();
                    const currentDate = now.toISOString().split("T")[0];
                    const currentTime = now.toTimeString().slice(0, 5);
                    document.getElementById("dateReceived").value = currentDate;
                    document.getElementById("timeReceived").value = currentTime;

                    // Show success message
                    showSuccessAlert("Entry created successfully!");

                    // Close modal
                    const modal = bootstrap.Modal.getInstance(
                      document.getElementById("createEntryModal")
                    );
                    modal.hide();

                    // Reload entries
                    loadEntries();

                    // Open the relevant month's accordion
                    setTimeout(() => {
                      const accordionButton = document.querySelector(
                        `button[data-bs-target="#${monthKey}"]`
                      );
                      if (accordionButton) {
                        accordionButton.click();
                      }
                    }, 500);
                  })
                  .catch((error) => {
                    console.error("Error saving monthly data:", error);
                    showErrorAlert("Error saving monthly data. Please try again.");
                  });
              });
            })
            .catch((error) => {
              console.error("Error creating entry:", error);
              showErrorAlert("Error creating entry. Please try again.");
            });
        });
      });

      // Update edit entry handler
      document.getElementById("updateEntry").addEventListener("click", function() {
        const key = document.getElementById("editEntryForm").dataset.key;
        const formData = {
          type: document.getElementById("editType").value,
          controlNumber: document.getElementById("editControlNumber").value,
          dateReceived: document.getElementById("editDateReceived").value,
          timeReceived: document.getElementById("editTimeReceived").value,
          from: document.getElementById("editFrom").value,
          office: document.getElementById("editOffice").value,
          subject: document.getElementById("editSubject").value,
          endorsedTo: document.getElementById("editEndorsedTo").value,
          remarks: document.getElementById("editRemarks").value,
          status: document.getElementById("editStatus").value,
          statusRemarks: document.getElementById("editStatusRemarks").value, // Save status remarks
          fromEmail: document.getElementById("editClientEmail").value, // Save client email
          updatedAt: firebase.database.ServerValue.TIMESTAMP,
          fileUrl: document.getElementById("editFileUrl").value,
        };

        // Validate required fields
        if (!formData.type || !formData.dateReceived || !formData.timeReceived || 
            !formData.from || !formData.office || !formData.subject || !formData.status || !formData.statusRemarks) {
          showErrorAlert("Please fill in all required fields");
          return;
        }

        // Get the previous status before updating
        entriesRef.child(key).once("value", (snapshot) => {
          const previousEntry = snapshot.val();
          const previousStatus = previousEntry ? previousEntry.status : "Unknown";
          const newStatus = formData.status;
          
          // Update the entry
          entriesRef.child(key)
            .update(formData)
            .then(() => {
              // Log with more specific details for status changes
              if (previousStatus !== newStatus) {
                logActivity(
                  "status_update",
                  `Status changed from "${previousStatus}" to "${newStatus}" for entry: ${formData.subject}`,
                  formData.controlNumber
                );
              } else {
                logActivity(
                  "update",
                  `Updated entry: ${formData.subject}`,
                  formData.controlNumber
                );
              }

              showSuccessAlert("Entry updated successfully!");
              
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("editEntryModal")
              );
              modal.hide();

              // Send email notification to client
              sendStatusUpdateEmail(formData);

              const entryDate = new Date(formData.dateReceived);
              const monthKey = entryDate.toLocaleString("default", { month: "long" }).toLowerCase() + entryDate.getFullYear();
              loadEntries();
              setTimeout(() => {
                const accordionButton = document.querySelector(
                  `button[data-bs-target="#${monthKey}"]`
                );
                if (accordionButton) {
                  accordionButton.click();
                }
              }, 500);
            })
            .catch((error) => {
              console.error("Error updating entry:", error);
              showErrorAlert("Error updating entry. Please try again.");
            });
        });
      });

      // Update profile form submission
      document.getElementById("profileForm").addEventListener("submit", function (e) {
          e.preventDefault();
        const user = firebase.auth().currentUser;
        if (!user) return;

          const profileData = {
            firstName: document.getElementById("firstName").value,
            lastName: document.getElementById("lastName").value,
            email: document.getElementById("email").value,
            phone: document.getElementById("phone").value,
            department: document.getElementById("department").value,
            position: document.getElementById("position").value,
          role: document.getElementById("role").value,
            updatedAt: firebase.database.ServerValue.TIMESTAMP,
          };

        // Update user data in database
        database.ref("users/" + user.uid).update(profileData)
            .then(() => {
            // Update the displayed user info
            document.getElementById("profileName").textContent = `${profileData.firstName} ${profileData.lastName}`;
            document.getElementById("profileRole").textContent = profileData.role;
            document.getElementById("currentUserName").textContent = `${profileData.firstName} ${profileData.lastName}`;
            document.getElementById("currentUserRole").textContent = profileData.role;
            
              showSuccessAlert("Profile updated successfully!");
            // logActivity("profile_update", "Updated profile information", "N/A"); // Removed - not entry-related
            })
            .catch((error) => {
              console.error("Error updating profile:", error);
              showErrorAlert("Error updating profile. Please try again.");
            });
        });

      // Update password change form submission
      document.getElementById("passwordForm").addEventListener("submit", function (e) {
          e.preventDefault();
        const user = firebase.auth().currentUser;
        if (!user) return;

        const currentPassword = document.getElementById("currentPassword").value;
          const newPassword = document.getElementById("newPassword").value;
        const confirmPassword = document.getElementById("confirmPassword").value;

          if (newPassword !== confirmPassword) {
            showErrorAlert("New passwords do not match!");
            return;
          }

        // Reauthenticate user before changing password
        const credential = firebase.auth.EmailAuthProvider.credential(
          user.email,
          currentPassword
        );

        user.reauthenticateWithCredential(credential)
          .then(() => {
            return user.updatePassword(newPassword);
          })
          .then(() => {
          showSuccessAlert("Password updated successfully!");
            // logActivity("password_change", "Changed password", "N/A"); // Removed - not entry-related
          document.getElementById("passwordForm").reset();
          })
          .catch((error) => {
            console.error("Error changing password:", error);
            showErrorAlert("Error changing password. Please try again.");
          });
        });

      // Password toggle functionality
      document.getElementById("toggleCurrentPassword").addEventListener("click", function() {
        const passwordField = document.getElementById("currentPassword");
        const icon = document.getElementById("currentPasswordIcon");
        
        if (passwordField.type === "password") {
          passwordField.type = "text";
          icon.classList.remove("bi-eye");
          icon.classList.add("bi-eye-slash");
        } else {
          passwordField.type = "password";
          icon.classList.remove("bi-eye-slash");
          icon.classList.add("bi-eye");
        }
      });

      document.getElementById("toggleNewPassword").addEventListener("click", function() {
        const passwordField = document.getElementById("newPassword");
        const icon = document.getElementById("newPasswordIcon");
        
        if (passwordField.type === "password") {
          passwordField.type = "text";
          icon.classList.remove("bi-eye");
          icon.classList.add("bi-eye-slash");
        } else {
          passwordField.type = "password";
          icon.classList.remove("bi-eye-slash");
          icon.classList.add("bi-eye");
        }
      });

      document.getElementById("toggleConfirmPassword").addEventListener("click", function() {
        const passwordField = document.getElementById("confirmPassword");
        const icon = document.getElementById("confirmPasswordIcon");
        
        if (passwordField.type === "password") {
          passwordField.type = "text";
          icon.classList.remove("bi-eye");
          icon.classList.add("bi-eye-slash");
        } else {
          passwordField.type = "password";
          icon.classList.remove("bi-eye-slash");
          icon.classList.add("bi-eye");
        }
      });


      // Edit entry function
      function editEntry(key) {
        entriesRef.child(key).once("value", (snapshot) => {
          const entry = snapshot.val();
          if (entry) {
            // Set the type first
            document.getElementById("editType").value = entry.type;
            
            // Update status options based on the type
            updateStatusOptions(entry.type);
            
            // Then set the status
            document.getElementById("editStatus").value = entry.status;
            
            // Set other fields
            document.getElementById("editControlNumber").value = entry.controlNumber;
            document.getElementById("editDateReceived").value = entry.dateReceived;
            document.getElementById("editTimeReceived").value = entry.timeReceived;
            document.getElementById("editFrom").value = entry.from;
            document.getElementById("editOffice").value = entry.office;
            document.getElementById("editSubject").value = entry.subject;
            document.getElementById("editEndorsedTo").value = entry.endorsedTo;
            document.getElementById("editRemarks").value = entry.remarks || "";
            document.getElementById("editStatusRemarks").value = entry.statusRemarks || "";
            // Set client email in edit form
            document.getElementById("editClientEmail").value = entry.fromEmail || "";
            document.getElementById("editFileUrl").value = entry.fileUrl || "";
            // Show preview for fileUrl in edit modal
            const previewDiv = document.getElementById("editFileUrlPreview");
            if (entry.fileUrl) {
              let embedUrl = entry.fileUrl;
              if (embedUrl.includes("view?usp=sharing")) {
                embedUrl = embedUrl.replace("view?usp=sharing", "preview");
              }
              previewDiv.innerHTML = `<a href="${entry.fileUrl}" target="_blank" class="btn btn-outline-primary btn-sm mb-2">View File in Google Drive</a><br><iframe src="${embedUrl}" width="100%" height="400" style="border:1px solid #ccc;"></iframe>`;
            } else {
              previewDiv.innerHTML = "<span class='text-muted'>No file link provided.</span>";
            }

            // Store the key for updating
            document.getElementById("editEntryForm").dataset.key = key;
          }
        });
      }

      // Update control number when date changes in create form
      document
        .getElementById("dateReceived")
        .addEventListener("change", function () {
          const controlNumber = generateControlNumber(this.value);
          document.getElementById("controlNumber").value = controlNumber;
        });

      // Update control number when date changes in edit form
      document
        .getElementById("editDateReceived")
        .addEventListener("change", function () {
          const controlNumber = generateControlNumber(this.value);
          document.getElementById("editControlNumber").value = controlNumber;
        });

      // Set current time when modal opens
      document
        .getElementById("createEntryModal")
        .addEventListener("show.bs.modal", function () {
          const now = new Date();
          const currentDate = now.toISOString().split("T")[0];
          const currentTime = now.toTimeString().slice(0, 5);

          document.getElementById("dateReceived").value = currentDate;
          document.getElementById("timeReceived").value = currentTime;
          
          // Show the next control number without incrementing
          getNextControlNumber().then(controlNumber => {
            document.getElementById("controlNumber").value = controlNumber;
          });
        });

      // Section-specific user management
      const SECTION_NAME = "endorsement";
      const DEFAULT_EMAIL = "endorsement@endorsement.com";
      const DEFAULT_NAME = "Endorsement";
      const DEFAULT_ROLE = "Endorsement Staff";

      // Function to get section-specific user info
      function getSectionUser() {
        const sectionUser = localStorage.getItem(`sectionUser_${SECTION_NAME}`);
        if (sectionUser) {
          return JSON.parse(sectionUser);
        }
        return {
          email: DEFAULT_EMAIL,
          name: DEFAULT_NAME,
          role: DEFAULT_ROLE
        };
      }

      // Function to set section-specific user info
      function setSectionUser(userInfo) {
        localStorage.setItem(`sectionUser_${SECTION_NAME}`, JSON.stringify(userInfo));
        updateUserDisplay(userInfo);
      }

      // Function to update user display
      function updateUserDisplay(userInfo) {
        const currentUserEmailElement = document.getElementById("currentUserEmailendorsement");
        const currentUserNameElement = document.getElementById("currentUserName");
        const currentUserRoleElement = document.getElementById("currentUserRole");
        
        if (currentUserEmailElement) {
          currentUserEmailElement.textContent = userInfo.email;
        }
        if (currentUserNameElement) {
          currentUserNameElement.textContent = userInfo.name;
        }
        if (currentUserRoleElement) {
          currentUserRoleElement.textContent = userInfo.role;
        }
      }

      // Function to validate section access
      function validateSectionAccess() {
        const currentUser = getSectionUser();
        const allowedEmails = [
          "endorsement@endorsement.com",
          "admin@centralcomm.com",
          "cmobaguio2600@gmail.com"
        ];
        
        if (!allowedEmails.includes(currentUser.email)) {
          console.warn("User not authorized for endorsement section:", currentUser.email);
          // You can redirect or show warning here
        }
      }

      // Load entries and check for archiving when page loads
      document.addEventListener("DOMContentLoaded", function () {
        // Initialize section-specific user management
        const sectionUser = getSectionUser();
        updateUserDisplay(sectionUser);
        validateSectionAccess();

        // Initialize Firebase auth state listener (for logging purposes only)
        firebase.auth().onAuthStateChanged(function(user) {
          if (user) {
            console.log("Firebase user signed in:", user.email);
            // Only update if it's an admin user
            if (user.email === "admin@centralcomm.com" || user.email === "cmobaguio2600@gmail.com") {
              setSectionUser({
                email: user.email,
                name: "Admin",
                role: "Administrator"
              });
            }
          } else {
            console.log("No Firebase user signed in");
            // Keep section-specific user info
          }
        });

        checkAndArchiveEntries();
        loadEntries();
      });

      // Function to load archived entries
      function loadArchivedEntries() {
        // Show loading state
        Swal.fire({
          title: "Loading Archived Entries",
          text: "Please wait...",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        entriesRef.once("value", (snapshot) => {
          const entries = snapshot.val();
          const archivedYearsContainer = document.getElementById("archivedYearsContainer");
          archivedYearsContainer.innerHTML = "";

          if (entries) {
            // Group entries by year
            const entriesByYear = {};
            Object.entries(entries).forEach(([key, entry]) => {
              if (entry.status === "Archived" && departmentAccessControl.hasAccessToEntry(getCurrentUser().email, entry)) {
                const year = new Date(entry.dateReceived).getFullYear();
                if (!entriesByYear[year]) {
                  entriesByYear[year] = [];
                }
                entriesByYear[year].push({ key, ...entry });
              }
            });

            // Sort years in descending order
            const years = Object.keys(entriesByYear).sort((a, b) => b - a);

            // Add year selector
            const yearSelector = document.createElement("div");
            yearSelector.className = "mb-3";
            yearSelector.innerHTML = `
              <div class="d-flex align-items-center mb-3">
                <label for="archiveYearSelect" class="form-label me-2 mb-0">Select Year:</label>
                <select class="form-select w-auto me-2" id="archiveYearSelect">
                  ${years.map(year => `<option value="${year}">${year}</option>`).join('')}
                </select>
                <button class="btn btn-outline-primary btn-sm" id="openSortFilterModal" type="button" data-bs-toggle="modal" data-bs-target="#sortFilterModal" title="Open sort/filter modal">
                  <i class="bi bi-funnel"></i> Sort/Filter
                </button>
              </div>
            `;
            archivedYearsContainer.appendChild(yearSelector);

            // Create accordion for each year
            years.forEach((year) => {
              const yearEntries = entriesByYear[year];
              const yearAccordion = document.createElement("div");
              yearAccordion.className = "col-12 mb-4";
              yearAccordion.id = `year-${year}`;
              yearAccordion.style.display = year === getCurrentYear().toString() ? 'block' : 'none';
              yearAccordion.innerHTML = `
                <div class="card">
                  <div class="card-header">
                    <h5 class="card-title mb-0">${year}</h5>
                  </div>
                  <div class="card-body">
                    <div class="table-responsive">
                      <table class="table table-hover archived-entries-table" id="archivedTable${year}">
                        <thead>
                          <tr>
                            <th>Control #</th>
                            <th>Type</th>
                            <th>File</th>
                            <th>Time Received</th>
                            <th>Date Received</th>
                            <th>From</th>
                            <th>Office</th>
                            <th>Subject</th>
                            <th>Endorsed To</th>
                            <th>Remarks</th>
                            <th>Status</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${yearEntries.map((entry) => `
                            <tr>
                              <td>${entry.controlNumber}</td>
                              <td>${entry.type}</td>
                              <td>${entry.fileUrl ? `<a href="${entry.fileUrl}" target="_blank">View File</a>` : ''}</td>
                              <td>${entry.timeReceived}</td>
                              <td>${formatDate(entry.dateReceived)}</td>
                              <td>${entry.from}</td>
                              <td>${entry.office}</td>
                              <td>${entry.subject}</td>
                              <td>${entry.endorsedTo}</td>
                              <td>${entry.remarks || ""}</td>
                              <td><span class="badge bg-secondary">Archived</span></td>
                              <td>
                                <button class="btn btn-sm btn-info" onclick="viewArchivedEntry('${entry.key}')" title="View archived entry details">
                                  <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="restoreEntry('${entry.key}')" title="Restore this archived entry">
                                  <i class="bi bi-arrow-counterclockwise"></i>
                                </button>
                              </td>
                            </tr>
                          `).join("")}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              `;
              archivedYearsContainer.appendChild(yearAccordion);

              // Initialize DataTable for this year's entries
              $(`#archivedTable${year}`).DataTable({
                dom: "Bfrtip",
                buttons: [
                  { extend: 'copy', className: 'btn btn-sm' },
                  { extend: 'csv', className: 'btn btn-success' },
                  { extend: 'excel', className: 'btn btn-success' },
                  { extend: 'pdf', className: 'btn btn-danger',
                    orientation: 'landscape',
                    pageSize: 'LEGAL',
                    customize: function (doc) {
                      doc.defaultStyle.fontSize = 10;              
                      doc.styles.tableHeader.fontSize = 11;        
                      doc.styles.tableHeader.alignment = 'left'
                      const colCount = doc.content[1].table.body[0].length;
                      doc.content[1].table.widths = Array(colCount).fill('*');
                    }
                  },
                  { extend: 'print', className: 'btn btn-primary' }
                ],
                pageLength: 10,
                order: [[0, "desc"]], // Sort by Control Number column (index 0) in descending order
                destroy: true,
                language: {
                  search: "Search entries:",
                },
              });
            });

            // Add event listener for year selector
            document.getElementById("archiveYearSelect").addEventListener("change", function() {
              const selectedYear = this.value;
              years.forEach(year => {
                const yearElement = document.getElementById(`year-${year}`);
                if (yearElement) {
                  yearElement.style.display = year === selectedYear ? 'block' : 'none';
                }
              });
            });

            if (years.length === 0) {
              archivedYearsContainer.innerHTML = `
                <div class="col-12 text-center">
                  <p class="text-muted">No archived entries found.</p>
                </div>
              `;
            }
          }

          // Close loading state
          Swal.close();
        }).catch((error) => {
          console.error("Error loading archived entries:", error);
          Swal.close();
          showErrorAlert("Error loading archived entries. Please try again.");
        });
      }

      // Function to view archived entry details
      function viewArchivedEntry(key) {
        entriesRef.child(key).once("value", (snapshot) => {
          const entry = snapshot.val();
          if (entry) {
            // Show entry details in a modal
            const modal = new bootstrap.Modal(
              document.getElementById("viewArchivedModal")
            );
            document
              .getElementById("viewArchivedModal")
              .querySelector(".modal-body").innerHTML = `
              <div class="row mb-3">
                <div class="col-md-6">
                  <strong>Control Number:</strong> ${entry.controlNumber}
                </div>
                <div class="col-md-6">
                  <strong>Type:</strong> ${entry.type}
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <strong>Date Received:</strong> ${formatDate(
                    entry.dateReceived
                  )}
                </div>
                <div class="col-md-6">
                  <strong>Time Received:</strong> ${entry.timeReceived}
                </div>
              </div>
              <div class="row mb-3">
              <div class="col-md-6">
                <strong>From:</strong> ${entry.from}
              </div>
              <div class="col-md-6">
                <strong>Office:</strong> ${entry.office}
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6 onset-md-6">
                <strong>Archived On:</strong> ${entry.archivedOn}
              </div>
            </div>
            <div class="mb-3">
              <strong>Subject:</strong> ${entry.subject}
            </div>
            <div class="mb-3">
              <strong>Endorsed To:</strong> ${entry.endorsedTo}
            </div>
            <div class="mb-3">
              <strong>Remarks:</strong> ${entry.remarks || "None"}
            </div>
              
            `;
            modal.show();
          }
        });
      }

      // Function to handle navigation
      function handleNavigation(sectionId) {
        // Hide all sections
        document.querySelectorAll(".main-content > div").forEach((section) => {
          section.classList.add("d-none");
        });

        // Show selected section
        document.getElementById(sectionId).classList.remove("d-none");

        // Update active state in sidebar
        document.querySelectorAll(".nav-link").forEach((link) => {
          link.classList.remove("active");
        });
        document
          .querySelector(`#${sectionId.replace("Section", "Link")}`)
          .classList.add("active");

        // Load section-specific data
        switch (sectionId) {
          case "documentsSection":
            loadDocuments();
            break;
          case "usersSection":
            loadUsers();
            break;
          case "archivesSection":
            loadArchivedEntries();
            break;
          case "historySection":
            loadHistory();
            break;
          case "profileSection":
            loadProfile();
            break;
          default:
            loadEntries();
        }
      }

      // Add event listeners for navigation
      document
        .getElementById("dashboardLink")
        .addEventListener("click", function (e) {
          e.preventDefault();
          handleNavigation("dashboardSection");
        });

      document
        .getElementById("documentsLink")
        .addEventListener("click", function (e) {
          e.preventDefault();
          handleNavigation("documentsSection");
        });

      document
        .getElementById("usersLink")
        .addEventListener("click", function (e) {
          e.preventDefault();
          handleNavigation("usersSection");
        });

      document
        .getElementById("archivesLink")
        .addEventListener("click", function (e) {
          e.preventDefault();
          handleNavigation("archivesSection");
        });

      document
        .getElementById("historyLink")
        .addEventListener("click", function (e) {
          e.preventDefault();
          handleNavigation("historySection");
        });

      document
        .getElementById("profileLink")
        .addEventListener("click", function (e) {
          e.preventDefault();
          handleNavigation("profileSection");
          
          // Update profile email field when profile section is accessed
          const currentUser = getCurrentUser();
          const profileEmailElement = document.getElementById("email");
          if (profileEmailElement && currentUser) {
            profileEmailElement.value = currentUser.email;
          }
        });

      // Function to load documents
      function loadDocuments() {
        entriesRef.once("value", (snapshot) => {
          const entries = snapshot.val();
          const currentYear = new Date().getFullYear();
          const currentMonth = new Date().getMonth();

          // Initialize statistics
          const yearlyStats = {
            total: 0,
            complaints: 0,
            requests: 0,
            proposals: 0,
            invitations: 0,
          };

          const monthlyStats = {
            total: 0,
            dailyAverage: 0,
            highestVolume: { month: "", count: 0 },
            lowestVolume: { month: "", count: Infinity },
          };

          const monthlyData = Array(12).fill(0);

          if (entries) {
            Object.entries(entries).forEach(([_, entry]) => {
              const entryDate = new Date(entry.dateReceived);
              const entryYear = entryDate.getFullYear();
              const entryMonth = entryDate.getMonth();

              // Yearly statistics - filter by user's department
              if (entryYear === currentYear && departmentAccessControl.hasAccessToEntry(getCurrentUser().email, entry)) {
                yearlyStats.total++;
                yearlyStats[entry.type.toLowerCase() + "s"]++;

                // Monthly statistics
                if (entryMonth === currentMonth) {
                  monthlyStats.total++;
                }
                monthlyData[entryMonth]++;
              }
            });

            // Calculate monthly statistics
            const nonZeroMonths = monthlyData.filter((count) => count > 0);
            monthlyStats.dailyAverage =
              nonZeroMonths.length > 0
                ? Math.round(
                    nonZeroMonths.reduce((a, b) => a + b, 0) /
                      nonZeroMonths.length
                  )
                : 0;

            monthlyData.forEach((count, month) => {
              if (count > monthlyStats.highestVolume.count) {
                monthlyStats.highestVolume = {
                  month: new Date(2000, month).toLocaleString("default", {
                    month: "long",
                  }),
                  count: count,
                };
              }
              if (count < monthlyStats.lowestVolume.count && count > 0) {
                monthlyStats.lowestVolume = {
                  month: new Date(2000, month).toLocaleString("default", {
                    month: "long",
                  }),
                  count: count,
                };
              }
            });
          }

          // Update yearly statistics
          document.getElementById("yearlyTotal").textContent =
            yearlyStats.total;
          document.getElementById("yearlyComplaints").textContent =
            yearlyStats.complaints;
          document.getElementById("yearlyRequests").textContent =
            yearlyStats.requests;
          document.getElementById("yearlyProposals").textContent =
            yearlyStats.proposals;
          document.getElementById("yearlyInvitations").textContent =
            yearlyStats.invitations;

          // Update monthly statistics
          document.getElementById("monthlyTotal").textContent =
            monthlyStats.total;
          document.getElementById("avgDailyLetters").textContent =
            monthlyStats.dailyAverage;
          document.getElementById(
            "highestVolumeMonth"
          ).textContent = `${monthlyStats.highestVolume.month} (${monthlyStats.highestVolume.count})`;
          document.getElementById(
            "lowestVolumeMonth"
          ).textContent = `${monthlyStats.lowestVolume.month} (${monthlyStats.lowestVolume.count})`;

          // Destroy existing charts before creating new ones
          const existingMonthlyChart = Chart.getChart("monthlyLettersChart");
          if (existingMonthlyChart) {
            existingMonthlyChart.destroy();
          }
          
          const existingLetterTypeChart = Chart.getChart("letterTypeChart");
          if (existingLetterTypeChart) {
            existingLetterTypeChart.destroy();
          }

          // Create monthly letters chart
          const monthlyCtx = document
            .getElementById("monthlyLettersChart")
            .getContext("2d");
          new Chart(monthlyCtx, {
            type: "bar",
            data: {
              labels: [
                "January",
                "February",
                "March",
                "April",
                "May",
                "June",
                "July",
                "August",
                "September",
                "October",
                "November",
                "December",
              ],
              datasets: [
                {
                  label: "Letters Received",
                  data: monthlyData,
                  borderColor: "#002C75",
                  backgroundColor: "#6aa1ff",
                  tension: 0.4,
                  fill: true,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  display: false,
                },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    stepSize: 1,
                  },
                },
              },
            },
          });

          // Create letter type distribution chart (pie chart)
          const letterTypeCtx = document.getElementById("letterTypeChart").getContext("2d");
          new Chart(letterTypeCtx, {
            type: "pie",
            data: {
              labels: ["Complaints", "Requests", "Proposals", "Invitations"],
              datasets: [{
                data: [
                  yearlyStats.complaints,
                  yearlyStats.requests,
                  yearlyStats.proposals,
                  yearlyStats.invitations
                ],
                backgroundColor: [
                  "rgba(255, 99, 132, 0.7)",    // Red for Complaints
                  "rgba(75, 192, 192, 0.7)",    // Green for Requests
                  "rgba(255, 206, 86, 0.7)",    // Yellow for Proposals
                  "rgba(54, 162, 235, 0.7)",    // Blue for Invitations
                ],
                borderColor: [
                  "rgba(255, 99, 132, 1)",      // Red border
                  "rgba(75, 192, 192, 1)",      // Green border
                  "rgba(255, 206, 86, 1)",      // Yellow border
                  "rgba(54, 162, 235, 1)",      // Blue border
                ],
                borderWidth: 2,                 // Increased border width
                borderAlign: 'inner',           // Inner border alignment
                hoverBorderWidth: 3,            // Larger border on hover
                hoverBorderColor: [             // Darker border colors on hover
                  "rgba(205, 49, 82, 1)",
                  "rgba(25, 142, 142, 1)",
                  "rgba(205, 156, 36, 1)",
                  "rgba(4, 112, 185, 1)",
                ],
                hoverOffset: 10                 // Segments spread out on hover
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: "right",
                  labels: {
                    generateLabels: function(chart) {
                      const data = chart.data;
                      if (data.labels.length && data.datasets.length) {
                        return data.labels.map((label, i) => {
                          const value = data.datasets[0].data[i];
                          const total = data.datasets[0].data.reduce((acc, val) => acc + val, 0);
                          const percentage = ((value / total) * 100).toFixed(1);
                          return {
                            text: `${label}: ${value} (${percentage}%)`,
                            fillStyle: data.datasets[0].backgroundColor[i],
                            strokeStyle: data.datasets[0].borderColor[i],
                            lineWidth: 2,
                            index: i
                          };
                        });
                      }
                      return [];
                    },
                    font: {
                      size: 12,
                      weight: 'bold'
                    },
                    padding: 20,
                    usePointStyle: true,
                    pointStyle: 'circle'
                  }
                },
                title: {
                  display: true,
                  text: `Total Letters by Type (${currentYear})`,
                  color: "#333",
                  font: {
                    size: 16,
                    weight: 'bold'
                  },
                  padding: {
                    top: 10,
                    bottom: 30
                  }
                }
              },
              layout: {
                padding: {
                  left: 20,
                  right: 20,
                  top: 20,
                  bottom: 20
                }
              },
              elements: {
                arc: {
                  borderWidth: 2,
                  borderRadius: 5
                }
              }
            }
          });
        });
      }

      // Function to load users
      function loadUsers() {
        // Check if DataTable is already initialized
        if ($.fn.DataTable.isDataTable("#usersTable")) {
          $("#usersTable").DataTable().destroy();
        }

        // Show loading state
        Swal.fire({
          title: "Loading Users",
          text: "Please wait...",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        database
          .ref("users")
          .once("value", (snapshot) => {
            const users = snapshot.val();
            const tbody = document.querySelector("#usersTable tbody");
            tbody.innerHTML = "";

            if (users) {
              Object.entries(users).forEach(([key, user]) => {
                if (key !== "admin") {
                  // Skip the admin user
                  const row = document.createElement("tr");
                  row.innerHTML = `
                  <td>${user.firstName} ${user.lastName}</td>
                  <td>${user.email}</td>
                  <td>${user.role}</td>
                  <td><span class="badge bg-warning">Active</span></td>
                  <td>
                    <button class="btn btn-sm btn-primary" onclick="editUser('${key}')" title="Edit this entry">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteUser('${key}')" title="Archive this entry">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                `;
                  tbody.appendChild(row);
                }
              });
            }

            // Initialize DataTable
            $("#usersTable").DataTable({
              dom: "Bfrtip",
              buttons: [
                { extend: 'copy', className: 'btn btn-sm' },
                { extend: 'csv', className: 'btn btn-success' },
                { extend: 'excel', className: 'btn btn-success' },
                { extend: 'pdf', className: 'btn btn-danger',
                    orientation: 'landscape',
                    pageSize: 'LEGAL',
                    customize: function (doc) {
                      doc.defaultStyle.fontSize = 10;              
                      doc.styles.tableHeader.fontSize = 11;        
                      doc.styles.tableHeader.alignment = 'left'
                      const colCount = doc.content[1].table.body[0].length;
                      doc.content[1].table.widths = Array(colCount).fill('*');
                    }
                  },
                { extend: 'print', className: 'btn btn-primary' }
              ],
              pageLength: 10,
              order: [[0, "asc"]],
              destroy: true,
              language: {
                search: "Search users:",
              },
            });

            // Close loading state
            Swal.close();
          })
          .catch((error) => {
            console.error("Error loading users:", error);
            Swal.close();
            showErrorAlert("Error loading users. Please try again.");
          });
      }

      // Function to load history
      function loadHistory() {
        // Check if DataTable is already initialized
        if ($.fn.DataTable.isDataTable("#historyTable")) {
          $("#historyTable").DataTable().destroy();
        }

        // Show loading state
        Swal.fire({
          title: "Loading History",
          text: "Please wait...",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        try {
          database
            .ref("logs")
            .on("value", (snapshot) => {
              try {
                const logs = snapshot.val();
                const tbody = document.querySelector("#historyTable tbody");
                tbody.innerHTML = "";

                if (logs) {
                  // Show all logs without filtering by endorsedTo
                  Object.entries(logs).forEach(([key, log]) => {
                    try {
                      const date = new Date(log.timestamp);
                      const timestampValue = date.getTime();
                      const formattedTimestamp = date.toLocaleString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true
                      });
                      const row = document.createElement("tr");
                      row.innerHTML = `
                        <td data-order="${timestampValue}">${formattedTimestamp}</td>
                        <td>${log.user}</td>
                        <td>${log.action}</td>
                        <td>${log.details}</td>
                        <td>${log.controlNumber || "-"}</td>
                      `;
                      tbody.appendChild(row);
                    } catch (error) {
                      console.error("Error processing log entry:", error, log);
                    }
                  });
                }

                // Initialize DataTable
                $("#historyTable").DataTable({
                  dom: "Bfrtip",
                  buttons: [
                    { extend: 'copy', className: 'btn btn-sm' },
                    { extend: 'csv', className: 'btn btn-success' },
                    { extend: 'excel', className: 'btn btn-success' },
                    { extend: 'pdf', className: 'btn btn-danger',
                        orientation: 'landscape',
                        pageSize: 'LEGAL',
                        customize: function (doc) {
                          doc.defaultStyle.fontSize = 10;              
                          doc.styles.tableHeader.fontSize = 11;        
                          doc.styles.tableHeader.alignment = 'left'
                          const colCount = doc.content[1].table.body[0].length;
                          doc.content[1].table.widths = Array(colCount).fill('*');
                        }
                      },
                    { extend: 'print', className: 'btn btn-primary' }
                  ],
                  pageLength: 10,
                  order: [[0, "desc"]], // Sort by Timestamp column (index 0) in descending order - latest first
                  destroy: true,
                  language: {
                    search: "Search history:",
                  },
                  columnDefs: [
                    { width: "20%", targets: 0 }, // Timestamp
                    { width: "15%", targets: 1 }, // User
                    { width: "10%", targets: 2 }, // Action
                    { width: "40%", targets: 3 }, // Details
                    { width: "15%", targets: 4 }  // Control Number
                  ],
                });

                // Close loading state
                Swal.close();
              } catch (error) {
                console.error("Error processing logs:", error);
                Swal.close();
                showErrorAlert("Error processing history data. Please try again.");
              }
            }, (error) => {
              // Error callback for the .on() listener
              console.error("Error loading history:", error);
              Swal.close();
              showErrorAlert("Error loading history. Please try again.");
            });
        } catch (error) {
          console.error("Error setting up history listener:", error);
          Swal.close();
          showErrorAlert("Error setting up history. Please try again.");
        }
      }

      // Function to view audit log details
      function viewAuditLog(key, log) {
        const modal = new bootstrap.Modal(
          document.getElementById("viewAuditLogModal")
        );

        // Format timestamp
        const timestamp = new Date(log.timestamp);
        const formattedTimestamp = timestamp.toLocaleString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });

        // Update modal content
        document.getElementById("auditTimestamp").textContent =
          formattedTimestamp;
        document.getElementById("auditUser").textContent = log.user;
        document.getElementById("auditAction").textContent = log.action;
        document.getElementById("auditControlNumber").textContent =
          log.controlNumber || "-";
        document.getElementById("auditDetails").textContent = log.details;

        // Show modal
        modal.show();
      }

      // Function to load profile
      function loadProfile() {
        const currentUser = getCurrentUser();
        if (!currentUser) return;

        // Show loading state
        Swal.fire({
          title: "Loading Profile",
          text: "Please wait...",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        // Use current user data
        const userData = {
          firstName: currentUser.displayInfo.name.split(' ')[0] || '',
          lastName: currentUser.displayInfo.name.split(' ').slice(1).join(' ') || '',
          email: currentUser.email,
          role: currentUser.displayInfo.role,
          phone: '',
          department: currentUser.displayInfo.department,
          position: ''
        };

        // Update profile information
        const profileNameElement = document.getElementById("profileName");
        const profileRoleElement = document.getElementById("profileRole");
        const firstNameElement = document.getElementById("firstName");
        const lastNameElement = document.getElementById("lastName");
        const emailElement = document.getElementById("email");
        const phoneElement = document.getElementById("phone");
        const departmentElement = document.getElementById("department");
        const positionElement = document.getElementById("position");
        const roleSelect = document.getElementById("role");
        const profileImageElement = document.getElementById("profileImage");
        
        // Ensure profile email is updated with current user email
        if (emailElement) {
          emailElement.value = userData.email;
        }

        if (profileNameElement) {
          profileNameElement.textContent = `${userData.firstName} ${userData.lastName}`;
        }
        if (profileRoleElement) {
          profileRoleElement.textContent = userData.role;
        }
        
        // Update form fields
        if (firstNameElement) {
          firstNameElement.value = userData.firstName;
        }
        if (lastNameElement) {
          lastNameElement.value = userData.lastName;
        }
        if (emailElement) {
          emailElement.value = userData.email;
        }
        if (phoneElement) {
          phoneElement.value = userData.phone;
        }
        if (departmentElement) {
          departmentElement.value = userData.department;
        }
        if (positionElement) {
          positionElement.value = userData.position;
        }
        
        // Set role and disable it if it exists
        if (roleSelect) {
          if (userData.role) {
            roleSelect.value = userData.role;
            roleSelect.disabled = true;
          } else {
            roleSelect.disabled = false;
          }
        }

        // Update profile image if available
        if (profileImageElement) {
          profileImageElement.src = 'assets/images/logo.png'; // Default logo as profile image
        }

        Swal.close();
      }

      // Initialize the dashboard on page load
      document.addEventListener("DOMContentLoaded", function () {
        handleNavigation("dashboardSection");
      });

      // Add event listener for the Archive All button
      document.addEventListener("DOMContentLoaded", function () {
        const archiveAllBtn = document.getElementById("archiveAllBtn");
        if (archiveAllBtn) {
          archiveAllBtn.addEventListener("click", archiveAllEntries);
        }
      });

      // Function to handle sign out
      function signOut() {
        showConfirmDialog(
          "Sign Out",
          "Are you sure you want to sign out?",
          "Yes, sign out"
        ).then((result) => {
          if (result.isConfirmed) {
            // Clear session data for this specific section
            sessionStorage.removeItem('endorsement_section_auth');
            localStorage.removeItem('endorsement_section_auth');
            
                    // Clear stored user email
        sessionStorage.removeItem('endorsementLoggedInUserEmail');
        localStorage.removeItem('endorsementLoggedInUserEmail');
            
            // Store sign out timestamp to prevent immediate redirect
            sessionStorage.setItem('endorsement_signout_time', Date.now().toString());

            // Redirect to selection page
            window.location.href = "../pages/selection.html";
          }
        });
      }

      // Check authentication state
      firebase.auth().onAuthStateChanged((user) => {
        // Check if user was signed out from this specific section
        const signoutTime = sessionStorage.getItem('endorsement_signout_time');
        const currentTime = Date.now();
        
        // If signout was within the last 5 seconds, don't redirect back
        if (signoutTime && (currentTime - parseInt(signoutTime)) < 5000) {
          return;
        }
        
        // Clean up old signout timestamp
        if (signoutTime && (currentTime - parseInt(signoutTime)) >= 5000) {
          sessionStorage.removeItem('endorsement_signout_time');
        }
        
        if (!user) {
          // If no user is signed in, redirect to selection page
          window.location.href = "../pages/selection.html";
        } else if (user) {
          // Check if user has access to endorsement section
          const endorsementAuth = sessionStorage.getItem('endorsement_section_auth') || localStorage.getItem('endorsement_section_auth');
          if (!endorsementAuth) {
            // User doesn't have access to this section, redirect to selection
            window.location.href = "../pages/selection.html";
            return;
          }
                  // Get user email from session storage (set during login) or fallback to Firebase user
        const loggedInEmail = sessionStorage.getItem('endorsementLoggedInUserEmail') || localStorage.getItem('endorsementLoggedInUserEmail') || user.email || "";
          
          // Set the current user's email immediately from storage
          const emailElement = document.getElementById("email");
          const currentUserEmailElement = document.getElementById("currentUserEmailendorsement");
          
          if (emailElement) {
            emailElement.value = loggedInEmail;
          }
          if (currentUserEmailElement) {
            currentUserEmailElement.textContent = loggedInEmail;
          }
          
          // Fetch user details from database
          database.ref('users/' + user.uid).once('value').then((snapshot) => {
            const userData = snapshot.val();
            if (userData) {
              // Check if profile is complete (has first name, last name, and role)
              const isProfileComplete = userData.firstName && userData.lastName && userData.role;
              
              if (!isProfileComplete) {
                // Show profile completion modal
                Swal.fire({
                  title: 'Complete Your Profile',
                  html: `
                    <form id="initialProfileForm">
                      <div class="mb-3">
                        <label for="initialFirstName" class="form-label">First Name</label>
                        <input type="text" class="form-control" id="initialFirstName" required>
                      </div>
                      <div class="mb-3">
                        <label for="initialLastName" class="form-label">Last Name</label>
                        <input type="text" class="form-control" id="initialLastName" required>
                      </div>
                      <div class="mb-3">
                        <label for="initialRole" class="form-label">Role</label>
                        <select class="form-select" id="initialRole" required>
                          <option value="">Select Role</option>
                          <option value="Administrator">Administrator</option>
                          <option value="Staff">Staff</option>
                        </select>
                      </div>
                    </form>
                  `,
                  showCancelButton: false,
                  confirmButtonText: 'Save Profile',
                  confirmButtonColor: '#002C75',
                  allowOutsideClick: false,
                  preConfirm: () => {
                    const firstName = document.getElementById('initialFirstName').value;
                    const lastName = document.getElementById('initialLastName').value;
                    const role = document.getElementById('initialRole').value;
                    
                    if (!firstName || !lastName || !role) {
                      Swal.showValidationMessage('Please fill in all fields');
                      return false;
                    }
                    
                    return { firstName, lastName, role };
                  }
                }).then((result) => {
                  if (result.isConfirmed) {
                    const { firstName, lastName, role } = result.value;
                    
                    // Update user data in database
                    const updates = {
                      firstName: firstName,
                      lastName: lastName,
                      role: role,
                      updatedAt: firebase.database.ServerValue.TIMESTAMP
                    };
                    
                    database.ref('users/' + user.uid).update(updates)
                      .then(() => {
                        // Update user's display name in Firebase Auth
                        return user.updateProfile({
                          displayName: `${firstName} ${lastName}`
                        });
                      })
                      .then(() => {
                        // Update UI with new user info - with null checks
                        const currentUserNameElement = document.getElementById("currentUserName");
                        const currentUserRoleElement = document.getElementById("currentUserRole");
                        
                        if (currentUserNameElement) {
                          currentUserNameElement.textContent = `${firstName} ${lastName}`;
                        }
                        
                        if (currentUserRoleElement) {
                          currentUserRoleElement.textContent = role;
                        }
                        
                        // Show success message
                        Swal.fire({
                          title: 'Success!',
                          text: 'Profile completed successfully!',
                          icon: 'success',
                          confirmButtonColor: '#002C75'
                        });
                      })
                      .catch((error) => {
                        console.error("Error updating profile:", error);
                        showErrorAlert("Error updating profile. Please try again.");
                      });
                  }
                });
              } else {
                // Profile is complete, update UI normally - with null checks
                const currentUserNameElement = document.getElementById("currentUserName");
                const currentUserRoleElement = document.getElementById("currentUserRole");
                const userAvatarElement = document.getElementById("userAvatar");
                
                if (currentUserNameElement) {
                  currentUserNameElement.textContent = `${userData.firstName} ${userData.lastName}`;
                }
                
                if (currentUserRoleElement) {
                  currentUserRoleElement.textContent = userData.role;
                }
                
                // Update user avatar if available
                if (user.photoURL && userAvatarElement) {
                  userAvatarElement.src = user.photoURL;
                }
              }
            }
          }).catch((error) => {
            console.error("Error fetching user data:", error);
            // Fallback to basic user info - with null checks
            const currentUserNameElement = document.getElementById("currentUserName");
            const currentUserRoleElement = document.getElementById("currentUserRole");
            
            if (currentUserNameElement) {
              currentUserNameElement.textContent = user.displayName || user.email;
            }
            
            if (currentUserRoleElement) {
              currentUserRoleElement.textContent = "User";
            }
          });
        }
      });

      // Function to create new user
      document.getElementById("saveUser").addEventListener("click", function () {
        const firstName = document.getElementById("newFirstName").value;
        const lastName = document.getElementById("newLastName").value;
        const email = document.getElementById("newEmail").value;
        const password = document.getElementById("newPassword").value;
        const confirmPassword = document.getElementById("confirmNewPassword").value;
        const role = document.getElementById("newRole").value;

        // Validate password match
        if (password !== confirmPassword) {
          Swal.fire({
            title: "Error!",
            text: "Passwords do not match!",
            icon: "error",
            confirmButtonColor: "#dc3545",
          });
          return;
        }

        // Validate password length
        if (password.length < 6) {
          Swal.fire({
            title: "Error!",
            text: "Password should be at least 6 characters long!",
            icon: "error",
            confirmButtonColor: "#dc3545",
          });
          return;
        }

        // Show loading state
        Swal.fire({
          title: "Creating user...",
          text: "Please wait while we create the user account",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        // Create user with Firebase Auth
        auth
          .createUserWithEmailAndPassword(email, password)
          .then((userCredential) => {
            const user = userCredential.user;

            // Store additional user data in Realtime Database
            const userData = {
              firstName: firstName,
              lastName: lastName,
              email: email,
              role: role,
              status: "active",
              createdAt: firebase.database.ServerValue.TIMESTAMP
            };

            // Save user data to database
            return database.ref('users/' + user.uid).set(userData)
              .then(() => {
                // Also update the user's display name in Firebase Auth
                return user.updateProfile({
                  displayName: `${firstName} ${lastName}`
                });
              });
          })
          .then(() => {
            // Show success message
            Swal.fire({
              title: "Success!",
              text: "User created successfully!",
              icon: "success",
              confirmButtonColor: "#002C75",
            }).then(() => {
              // Close modal
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("createUserModal")
              );
              modal.hide();

              // Reset form
              document.getElementById("createUserForm").reset();

              // Reload users table
              loadUsers();
            });
          })
          .catch((error) => {
            let errorMessage = "An error occurred while creating the user.";

            switch (error.code) {
              case "auth/email-already-in-use":
                errorMessage = "Email is already in use.";
                break;
              case "auth/invalid-email":
                errorMessage = "Invalid email format.";
                break;
              case "auth/weak-password":
                errorMessage = "Password should be at least 6 characters.";
                break;
              case "auth/operation-not-allowed":
                errorMessage = "User creation is currently disabled.";
                break;
            }

            // Show error message
            Swal.fire({
              title: "Error!",
              text: errorMessage,
              icon: "error",
              confirmButtonColor: "#dc3545",
            });
          });
      });

      // Function to update status options based on type
      function updateStatusOptions(type) {
        const statusSelect = document.getElementById("status");
        const editStatusSelect = document.getElementById("editStatus");
        
        // Clear existing options
        statusSelect.innerHTML = '';
        editStatusSelect.innerHTML = '';
        
        switch(type) {
          case "Complaint":
            // Complaint statuses
            const complaintStatuses = [
              { value: "Under Investigation", text: "Under Investigation (Ongoing)" },
              { value: "Inspection", text: "Inspection, Acted Upon (Done)" }
            ];
            addStatusOptions(complaintStatuses);
            break;
            
          case "Request":
            // Request statuses
            const requestStatuses = [
              { value: "For Review", text: "For Review and Approval (Ongoing)" },
              { value: "Request Granted", text: "Request Granted (Done)" },
              { value: "Request Denied", text: "Request Denied" }
            ];
            addStatusOptions(requestStatuses);
            break;
            
          case "Invitation":
            // Invitation statuses
            const invitationStatuses = [
              { value: "Calendar Pending", text: "To be placed in the calendar (Ongoing)" },
              { value: "Mayor Decision", text: "The mayor will accept/decline (Done)" }
            ];
            addStatusOptions(invitationStatuses);
            break;
            
          case "Proposal":
            // Proposal statuses
            const proposalStatuses = [
              { value: "Review Study", text: "For review and study (Ongoing)" },
              { value: "Decision Made", text: "Approve, please present your proposal/ disapprove, the city has already a working product/system (Done)" }
            ];
            addStatusOptions(proposalStatuses);
            break;
            
          default:
            // Regular status options for other types
            const regularStatuses = [
              { value: "Pending", text: "Pending" },
              { value: "Processing", text: "Processing" },
              { value: "Completed", text: "Completed" },
              { value: "Archived", text: "Archived" }
            ];
            addStatusOptions(regularStatuses);
        }
      }

      // Helper function to add status options to both select elements
      function addStatusOptions(statuses) {
        const statusSelect = document.getElementById("status");
        const editStatusSelect = document.getElementById("editStatus");
        
        statuses.forEach(status => {
          const option = new Option(status.text, status.value);
          const editOption = new Option(status.text, status.value);
          statusSelect.add(option);
          editStatusSelect.add(editOption);
        });
      }

      // Add event listeners for type changes
      document.getElementById("letterType").addEventListener("change", function() {
        updateStatusOptions(this.value);
      });

      document.getElementById("editType").addEventListener("change", function() {
        updateStatusOptions(this.value);
      });

      // Initialize status options based on initial type
      document.addEventListener("DOMContentLoaded", function() {
        const initialType = document.getElementById("letterType").value;
        updateStatusOptions(initialType);
      });

      // Add this function near the top of the script section
      function getCurrentYear() {
        return new Date().getFullYear();
      }

         // Function to handle search in accordion tables
         function initializeSearch() {
        const currentYear = getCurrentYear();
        const months = [
          "January", "February", "March", "April", "May", "June",
          "July", "August", "September", "October", "November", "December"
        ];

        months.forEach(month => {
          const monthKey = `${month.toLowerCase()}${currentYear}`;
          const searchInput = document.getElementById(`search${monthKey}`);
          const tableId = `monthly-stats-table-${monthKey}`;
          
          if (searchInput) {
            // Create title for this month
            const title = `${month} ${currentYear} - Endorsement Section Dashboard`;
            
            // Initialize DataTable for this month
            $(`#${tableId}`).DataTable({
              dom: "Bfrtip",
              buttons: [
                { 
                  extend: 'copy', 
                  className: 'btn btn-sm',
                  title: title
                },
                { 
                  extend: 'csv', 
                  className: 'btn btn-success',
                  title: title
                },
                { 
                  extend: 'excel', 
                  className: 'btn btn-success',
                  title: title
                },
                { 
                  extend: 'pdf', 
                  className: 'btn btn-danger',
                  orientation: 'landscape',
                  pageSize: 'LEGAL',
                  title: title,
                  customize: function (doc) {
                    doc.defaultStyle.fontSize = 10;
                    doc.styles.tableHeader.fontSize = 11;
                    doc.styles.tableHeader.alignment = 'left';
                    const colCount = doc.content[1].table.body[0].length;
                    doc.content[1].table.widths = Array(colCount).fill('*');
                  }
                },
                { 
                  extend: 'print', 
                  className: 'btn btn-primary',
                  title: title
                }
              ],
              pageLength: 10,
              order: [[4, "desc"]], // Sort by Date Received by default
              destroy: true,
              language: {
                search: "Search entries:",
              },
              columnDefs: [
                { width: "5%", targets: 0 }, // #
                { width: "12%", targets: 1 }, // Control Number
                { width: "8%", targets: 2 }, // Letter Type
                { width: "7%", targets: 3 }, // Time Received
                { width: "7%", targets: 4 }, // Date Received
                { width: "7%", targets: 5 }, // From
                { width: "7%", targets: 6 }, // Office
                { width: "10%", targets: 7 }, // Subject
                { width: "7%", targets: 8 }, // Time Received (Admin)
                { width: "7%", targets: 9 }, // Date Received (Admin)
                { width: "7%", targets: 10 }, // Endorsed To
                { width: "7%", targets: 11 }, // Remarks
                { width: "7%", targets: 12 }, // File Code
                { width: "5%", targets: 13 }, // Status
                { width: "5%", targets: 14 }  // Actions
              ],
              scrollX: true,
              scrollCollapse: true,
              fixedColumns: {
                left: 1,
                right: 1
              }
            });

            // Add search functionality
            searchInput.addEventListener('keyup', function() {
              const table = $(`#${tableId}`).DataTable();
              table.search(this.value).draw();
            });
          }
        });
      }

      // Function to initialize DataTable for a specific month
      function initializeDataTable(monthKey, tableId, data) {
        // Data is already filtered by department in loadEntries function
        // No need to filter again here
        const filteredData = data;
        
        console.log(`Initializing DataTable for ${monthKey}:`, {
          tableId: tableId,
          dataLength: data.length,
          filteredDataLength: filteredData.length,
          data: data
        });

        // Destroy existing DataTable if it exists
        if ($.fn.DataTable.isDataTable(`#${tableId}`)) {
          $(`#${tableId}`).DataTable().destroy();
        }

        // Extract month name from monthKey (e.g., "may2024" -> "May")
        const monthName = monthKey.replace(/\d+/g, '').charAt(0).toUpperCase() + monthKey.replace(/\d+/g, '').slice(1);
        const currentYear = new Date().getFullYear();
        const title = `${monthName} ${currentYear} - Endorsement Section Dashboard`;

        // Initialize new DataTable with export buttons at the top (like archives)
        const table = $(`#${tableId}`).DataTable({
          data: filteredData,
          columns: [
            {
              data: null,
              render: function(data, type, row, meta) {
                // Extract the numeric part of the control number (after the dash)
                const getNum = cn => {
                  const match = (cn || '').match(/-(\d+)$/);
                  return match ? parseInt(match[1], 10) : -1;
                };
                // Get all visible rows' control numbers
                const api = meta.settings ? new $.fn.dataTable.Api(meta.settings) : null;
                if (!api) return meta.row + 1;
                const allRows = api.rows({ search: 'applied' }).data().toArray();
                // Sort all rows by full control number descending
                const sorted = allRows.slice().sort((a, b) => getNum(b.controlNumber) - getNum(a.controlNumber));
                // Find this row's index in the sorted array using only controlNumber
                const idx = sorted.findIndex(r => r.controlNumber === row.controlNumber);
                return idx >= 0 ? idx + 1 : meta.row + 1; // fallback to visible order if not found
              },
              orderable: false
            },
            { data: 'controlNumber' },
            { data: 'type' },
            { data: 'fileUrl', render: function(data) { return data ? `<a href="${data}" target="_blank">View File</a>` : '' } },
            { data: 'timeReceived' },
            { data: 'dateReceived' },
            { data: 'from' },
            { data: 'office' },
            { data: 'subject' },
            { data: 'endorsedTo', defaultContent: '' },
            { data: 'remarks', defaultContent: '' },
            {
              data: 'status',
              render: function(data, type, row) {
                switch (data) {
                  case "Under Investigation": return '<span class="badge bg-primary">Under Investigation</span>';
                  case "Processing": return '<span class="badge bg-info">Processing</span>';
                  case "Completed": return '<span class="badge bg-success">Completed</span>';
                  case "Calendar Pending": return '<span class="badge bg-warning">Calendar Pending</span>';
                  case "For Review": return '<span class="badge bg-primary">For Review</span>';
                  // ...add more as needed
                  default: return `<span class="badge bg-secondary">${data}</span>`;
                }
              }
            },
            {
              data: null,
              render: function(data, type, row) {
                return `
                  <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#editEntryModal" onclick="editEntry('${row.key}')" title="Edit this entry">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-warning" onclick="deleteEntry('${row.key}')" title="Archive this entry">
                    <i class="bi bi-archive"></i>
                  </button>
                `;
              }
            }
          ],
          pageLength: 10,
          order: [[1, 'desc']], // Sort by Control Number (string, but last 3 digits will be highest at top)
          dom: "Bfrtip", // Buttons, filter, processing, table, pagination
          buttons: [
            { 
              extend: 'copy', 
              className: 'btn btn-sm',
              title: title
            },
            { 
              extend: 'csv', 
              className: 'btn btn-success',
              title: title
            },
            { 
              extend: 'excel', 
              className: 'btn btn-success',
              title: title
            },
            { 
              extend: 'pdf', 
              className: 'btn btn-danger',
              orientation: 'landscape',
              pageSize: 'LEGAL',
              title: title,
              customize: function (doc) {
                doc.defaultStyle.fontSize = 10;
                doc.styles.tableHeader.fontSize = 11;
                doc.styles.tableHeader.alignment = 'left';
                const colCount = doc.content[1].table.body[0].length;
                doc.content[1].table.widths = Array(colCount).fill('*');
              }
            },
            { 
              extend: 'print', 
              className: 'btn btn-primary',
              title: title
            }
          ],
          language: {
            search: "Search entries:",
          },
          responsive: true,
          autoWidth: false,
          columnDefs: [
            { width: "5%", targets: 0 },
            { width: "10%", targets: 1 },
            { width: "8%", targets: 2 },
            { width: "8%", targets: 3 },
            { width: "8%", targets: 4 },
            { width: "10%", targets: 5 },
            { width: "10%", targets: 6 },
            { width: "15%", targets: 7 },
            { width: "10%", targets: 8 },
            { width: "10%", targets: 9 },
            { width: "8%", targets: 10 },
            { width: "8%", targets: 11 }
          ]
        });

        // Add search functionality
        const searchInput = document.getElementById(`search${monthKey}`);
        if (searchInput) {
          searchInput.addEventListener('keyup', function() {
            table.search(this.value).draw();
          });
        }

        // After DataTable initialization, style the buttons
        $(`#${tableId}_wrapper .dt-buttons`).addClass('btn-group flex-wrap mb-2');

        return table;
      }

      // Update the loadEntries function to use the new initialization
      function loadEntries() {
        const currentUser = getCurrentUser();
        const currentYear = getCurrentYear();
        
        console.log('Current user:', currentUser);
        console.log('User department:', currentUser.department);
        
        if (!departmentAccessControl.validateSectionAccess(currentUser.email)) {
          showErrorAlert("You don't have access to this section.");
          window.location.href = "../pages/selection.html";
          return;
        }
        
        entriesRef.on("value", (snapshot) => {
          const allEntries = snapshot.val();
          console.log('All entries:', allEntries);
          
          const accordionContainer = document.getElementById("monthlyStatsAccordion");
          const months = [
            "January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
          ];
          const now = new Date();
          const currentMonthIdx = now.getMonth();
          const visibleMonths = months.slice(0, currentMonthIdx + 1).reverse();
          
          accordionContainer.innerHTML = "";
          
          visibleMonths.forEach((month) => {
            const monthKey = `${month.toLowerCase()}${currentYear}`;
            const accordionItem = document.createElement("div");
            accordionItem.className = "accordion-item border-0 mb-2";
            accordionItem.id = `accordion-${monthKey}`;
            accordionItem.innerHTML = `
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${monthKey}" title="Expand/collapse month details">
                  <div class="d-flex justify-content-between align-items-center w-100">
                    <div>
                      <span class="fw-bold">${month} ${currentYear}</span>
                    </div>
                    <div class="text-muted small">
                      <i class="bi bi-arrow-down-circle me-1"></i>
                      Click to view details
                    </div>
                  </div>
                </button>
              </h2>
              <div id="${monthKey}" class="accordion-collapse collapse" data-bs-parent="#monthlyStatsAccordion">
                <div class="accordion-body">
                  <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading data for ${month} ${currentYear}...</p>
                  </div>
                </div>
              </div>
            `;
            accordionContainer.appendChild(accordionItem);
          });
          
          visibleMonths.forEach((month) => {
            const monthKey = `${month.toLowerCase()}${currentYear}`;
            const tableId = `monthly-stats-table-${monthKey}`;
            
            database
              .ref(`monthlyData/${monthKey}`)
              .once("value", (monthlySnapshot) => {
                const monthlyData = monthlySnapshot.val() || {
                  total: 0,
                  complaints: 0,
                  proposals: 0,
                  invitations: 0,
                  requests: 0,
                  entries: [],
                };
                
                console.log(`Monthly data for ${month}:`, monthlyData);
                
                // Get all entries for this month and filter by department
                const monthEntries = monthlyData.entries
                  .map((key) => {
                    const entry = allEntries[key];
                    return entry ? { key, ...entry } : null;
                  })
                  .filter((entry) => {
                    if (!entry || entry.status === "Archived") return false;
                    
                    // Check if user has access to this entry
                    const hasAccess = departmentAccessControl.hasAccessToEntry(currentUser.email, entry);
                    console.log(`Entry ${entry.controlNumber} - Endorsed To: ${entry.endorsedTo}, User Dept: ${currentUser.department}, Has Access: ${hasAccess}`);
                    
                    return hasAccess;
                  });
                
                console.log(`Filtered entries for ${month}:`, monthEntries);
                
                const stats = {
                  complaints: 0,
                  proposals: 0,
                  invitations: 0,
                  requests: 0,
                  total: 0
                };
                
                monthEntries.forEach(entry => {
                  stats.total++;
                  const type = entry.type.toLowerCase();
                  if (type === 'complaint') stats.complaints++;
                  else if (type === 'proposal') stats.proposals++;
                  else if (type === 'invitation') stats.invitations++;
                  else if (type === 'request') stats.requests++;
                });
                
                function getTypePercent(count, total) {
                  if (total === 0) return 0;
                  return Math.round((count / total) * 100);
                }
                const complaintsPercent = getTypePercent(stats.complaints, stats.total);
                const proposalsPercent = getTypePercent(stats.proposals, stats.total);
                const invitationsPercent = getTypePercent(stats.invitations, stats.total);
                const requestsPercent = getTypePercent(stats.requests, stats.total);
                monthEntries.sort((a, b) => {
                  return new Date(b.dateReceived) - new Date(a.dateReceived);
                });
                const accordionBody = document.querySelector(
                  `#${monthKey} .accordion-body`
                );
                if (accordionBody) {
                  accordionBody.innerHTML = `
                    <!-- ${month} Statistics -->
                    <div class="row mb-4">
                      <div class="col-md-3">
                        <div class="card bg-primary bg-opacity-10">
                          <div class="card-body">
                            <h6 class="card-title text-primary">Complaints</h6>
                            <h2 class="card-text">${stats.complaints}</h2>
                            <div class="d-flex align-items-center">
                              <span class="trend-indicator trend-up text-primary">
                                <i class="bi bi-arrow-up me-1"></i>${complaintsPercent}%
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="card bg-warning bg-opacity-10">
                          <div class="card-body">
                            <h6 class="card-title text-warning">Proposals</h6>
                            <h2 class="card-text">${stats.proposals}</h2>
                            <div class="d-flex align-items-center">
                              <span class="trend-indicator trend-up text-warning">
                                <i class="bi bi-arrow-up me-1"></i>${proposalsPercent}%
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="card bg-info bg-opacity-10">
                          <div class="card-body">
                            <h6 class="card-title text-info">Invitations</h6>
                            <h2 class="card-text">${stats.invitations}</h2>
                            <div class="d-flex align-items-center">
                              <span class="trend-indicator trend-up text-info">
                                <i class="bi bi-arrow-up me-1"></i>${invitationsPercent}%
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="card bg-warning bg-opacity-10">
                          <div class="card-body">
                            <h6 class="card-title text-success">Requests</h6>
                            <h2 class="card-text">${stats.requests}</h2>
                            <div class="d-flex align-items-center">
                              <span class="trend-indicator trend-up text-success">
                                <i class="bi bi-arrow-up me-1"></i>${requestsPercent}%
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="table-responsive">
                      <table class="table table-hover monthly-stats-table" id="${tableId}">
                        <thead>
                          <tr>
                            <th>#</th>
                            <th>Control Number</th>
                            <th>Type</th>
                            <th>File</th>
                            <th>Time Received</th>
                            <th>Date Received</th>
                            <th>From</th>
                            <th>Office</th>
                            <th>Subject</th>
                            <th>Endorsed To</th>
                            <th>Remarks</th>
                            <th>Status</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                        </tbody>
                      </table>
                    </div>
                  `;
                  setTimeout(() => {
                    try {
                      initializeDataTable(monthKey, tableId, monthEntries);
                    } catch (error) {
                      console.error(`Error initializing DataTable for ${month}:`, error);
                    }
                  }, 100);
                }
              });
          });
        });
      }

      // === ARCHIVES FILTER LOGIC ===

      // Helper: Get unique values from array of objects
      function getUniqueValues(entries, key) {
        const set = new Set();
        entries.forEach(e => {
          if (e[key]) set.add(e[key]);
        });
        return Array.from(set).sort();
      }

      // Populate filter modal dropdowns when modal is shown
      $(document).on('show.bs.modal', '#sortFilterModal', function () {
        // Get selected year
        const year = document.getElementById('archiveYearSelect')?.value;
        if (!year) return;
        // Find entries for this year
        const yearTable = document.getElementById(`archivedTable${year}`);
        if (!yearTable) return;
        const rows = yearTable.querySelectorAll('tbody tr');
        const entries = Array.from(rows).map(row => {
          const cells = row.querySelectorAll('td');
          return {
            controlNumber: cells[0]?.textContent.trim(),
            type: cells[1]?.textContent.trim(),
            timeReceived: cells[2]?.textContent.trim(),
            dateReceived: cells[3]?.textContent.trim(),
            from: cells[4]?.textContent.trim(),
            office: cells[5]?.textContent.trim(),
            subject: cells[6]?.textContent.trim(),
            endorsedTo: cells[7]?.textContent.trim(),
            remarks: cells[8]?.textContent.trim(),
            status: cells[9]?.textContent.trim(),
          };
        });
        // Populate dropdowns
        function fillSelect(id, values) {
          const sel = document.getElementById(id);
          if (!sel) return;
          sel.innerHTML = '<option value="">All</option>' + values.map(v => `<option value="${v}">${v}</option>`).join('');
        }
        fillSelect('filterFrom', getUniqueValues(entries, 'from'));
        fillSelect('filterOffice', getUniqueValues(entries, 'office'));
        fillSelect('filterEndorsedTo', getUniqueValues(entries, 'endorsedTo'));
        fillSelect('filterStatus', getUniqueValues(entries, 'status'));
      });

      // Filter logic for Apply button
      $('#applySortFilter').on('click', function () {
        const year = document.getElementById('archiveYearSelect')?.value;
        if (!year) return;
        const table = $(`#archivedTable${year}`).DataTable();
        // Gather filter values
        const months = Array.from(document.querySelectorAll('input[name="months"]:checked')).map(cb => cb.value);
        const types = Array.from(document.querySelectorAll('input[name="letterTypes"]:checked')).map(cb => cb.value);
        const dateReceived = document.getElementById('filterDateReceived').value;
        const from = document.getElementById('filterFrom').value;
        const office = document.getElementById('filterOffice').value;
        const endorsedTo = document.getElementById('filterEndorsedTo').value;
        const status = document.getElementById('filterStatus').value;
        // Custom filter function
        $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
          // Only filter the correct table
          if (settings.nTable.id !== `archivedTable${year}`) return true;
          // Data columns: 0=Control #, 1=Type, 2=Time, 3=Date, 4=From, 5=Office, 6=Subject, 7=Endorsed To, 8=Remarks, 9=Status
          const rowType = data[1];
          const rowDate = data[3];
          const rowFrom = data[4];
          const rowOffice = data[5];
          const rowEndorsedTo = data[7];
          const rowStatus = $(data[9]).text() || data[9];
          // Months
          if (months.length > 0) {
            const monthName = rowDate.split(' ')[0];
            if (!months.includes(monthName)) return false;
          }
          // Letter Types
          if (types.length > 0 && !types.includes(rowType)) return false;
          // Date Received
          if (dateReceived) {
            // Try to match YYYY-MM-DD or formatted date
            const rowDateVal = new Date(rowDate);
            const filterDateVal = new Date(dateReceived);
            if (rowDateVal.toISOString().slice(0,10) !== dateReceived) return false;
          }
          // From
          if (from && rowFrom !== from) return false;
          // Office
          if (office && rowOffice !== office) return false;
          // Endorsed To
          if (endorsedTo && rowEndorsedTo !== endorsedTo) return false;
          // Status
          if (status && rowStatus !== status) return false;
          return true;
        });
        table.draw();
        // Remove filter after draw to avoid affecting other tables
        $.fn.dataTable.ext.search.pop();
        // Close modal
        $('#sortFilterModal').modal('hide');
      });

      // Reset button logic
      $('#resetSortFilter').on('click', function () {
        document.getElementById('sortFilterForm').reset();
        const year = document.getElementById('archiveYearSelect')?.value;
        if (!year) return;
        const table = $(`#archivedTable${year}`).DataTable();
        table.search('').columns().search('').draw();
      });
      // === END ARCHIVES FILTER LOGIC ===

      // === EMAILJS INTEGRATION ===
      // Initialize EmailJS (replace 'YOUR_USER_ID' with your actual EmailJS user ID)
      emailjs.init('Tp4tK-Kp7Vr1m3Kv6'); // <-- Replace with your EmailJS user ID

      // Function to send email notification on status update
      function sendStatusUpdateEmail(entry) {
        // Use the client email from the entry
        const clientEmail = entry.fromEmail || "ramosrommel2001@gmail.com";
        emailjs.send('service_07b62xr', 'template_v65zya9', {
          to_email: clientEmail,
          title: "Document Status Update",
          controlNumber: entry.controlNumber,
          subject: entry.subject,
          status: entry.status,
          statusRemarks: entry.statusRemarks || "No additional remarks provided.",
          fileUrl: entry.fileUrl || "",
          email: clientEmail // for Reply To
        })
        .then(function(response) {
          console.log('Email sent!', response.status, response.text);
        }, function(error) {
          console.error('Failed to send email:', error);
        });
      }
      // ... existing code ...

      // Show preview for fileUrl in create modal
      document.getElementById("fileUrl").addEventListener("input", function() {
        const url = this.value;
        const previewDiv = document.getElementById("fileUrlPreview");
        if (url) {
          let embedUrl = url;
          if (embedUrl.includes("view?usp=sharing")) {
            embedUrl = embedUrl.replace("view?usp=sharing", "preview");
          }
          previewDiv.innerHTML = `<a href="${url}" target="_blank" class="btn btn-outline-primary btn-sm mb-2">View File in Google Drive</a><br><iframe src="${embedUrl}" width="100%" height="400" style="border:1px solid #ccc;"></iframe>`;
        } else {
          previewDiv.innerHTML = "<span class='text-muted'>No file link provided.</span>";
        }
      });

      // Register the datetime-moment plugin for DataTables
      $(document).ready(function() {
        if ($.fn.dataTable && $.fn.dataTable.moment) {
          $.fn.dataTable.moment('YYYY-MM-DD'); // For Date Received
          $.fn.dataTable.moment('HH:mm');      // For Time Received
        }
      });

      document.addEventListener("DOMContentLoaded", function () {
        const printBtn = document.getElementById("printReportsBtn");
        if (printBtn) {
          printBtn.addEventListener("click", function () {
            // Before printing, force charts to redraw for print (Chart.js)
            if (window.Chart) {
              Object.values(Chart.instances || {}).forEach(chart => chart.resize());
            }
            window.print();
          });
        }
      });

      function getCurrentUser() {
        // Get user email from session storage (set during login) or fallback to Firebase user
        const userEmail = sessionStorage.getItem('endorsementLoggedInUserEmail') || 
                         localStorage.getItem('endorsementLoggedInUserEmail') || 
                         'endorsement@endorsement.com';
        
        console.log('Getting current user with email:', userEmail);
        
        const userDept = departmentAccessControl.getUserDepartment(userEmail);
        console.log('User department determined:', userDept);
        
        return {
          email: userEmail,
          department: userDept,
          displayInfo: departmentAccessControl.getUserDisplayInfo(userEmail)
        };
      }

      // Initialize the dashboard with user info and load entries
      document.addEventListener("DOMContentLoaded", function () {
        const currentUser = getCurrentUser();
        console.log('DOMContentLoaded - Current user:', currentUser);
        
        // Update user display in sidebar
        const emailElement = document.getElementById("currentUserEmailendorsement");
        const nameElement = document.getElementById("currentUserName");
        
        if (emailElement) {
          emailElement.textContent = currentUser.email;
        }
        if (nameElement) {
          nameElement.textContent = currentUser.displayInfo.name;
        }
        
        // Also update the profile email field (like admin system does)
        const profileEmailElement = document.getElementById("email");
        if (profileEmailElement) {
          profileEmailElement.value = currentUser.email;
        }
        
        console.log('User display updated - Email:', currentUser.email, 'Name:', currentUser.displayInfo.name);
        
        // Test the filtering logic
        console.log('Testing department access control:');
        console.log('- User email:', currentUser.email);
        console.log('- User department:', currentUser.department);
        console.log('- Is admin:', currentUser.department === 'ADMIN');
        
        loadEntries();
        
        // Also update profile email after a short delay to ensure all elements are loaded
        setTimeout(() => {
          const profileEmailElement = document.getElementById("email");
          if (profileEmailElement) {
            profileEmailElement.value = currentUser.email;
            console.log('Profile email updated to:', currentUser.email);
          }
        }, 1000);
      });
    </script>
  </body>
</html>
